{"version":3,"file":"JsonRulesEngineFactChecker.cjs.js","sources":["../../src/service/JsonRulesEngineFactChecker.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { isError } from '@backstage/errors';\nimport { FactResponse } from '@backstage-community/plugin-tech-insights-common';\nimport {\n  CheckValidationResponse,\n  FactChecker,\n  FlatTechInsightFact,\n  TechInsightCheckRegistry,\n  TechInsightsStore,\n} from '@backstage-community/plugin-tech-insights-node';\nimport Ajv, { SchemaObject } from 'ajv';\nimport {\n  Engine,\n  EngineResult,\n  Operator,\n  TopLevelCondition,\n} from 'json-rules-engine';\nimport { flatten, pick } from 'lodash';\nimport { JSON_RULE_ENGINE_CHECK_TYPE } from '../constants';\nimport { JsonRuleBooleanCheckResult, TechInsightJsonRuleCheck } from '../types';\nimport { DefaultCheckRegistry } from './CheckRegistry';\nimport { readChecksFromConfig } from './config';\nimport * as validationSchema from './validation-schema.json';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\nconst noopEvent = {\n  type: 'noop',\n};\n\n/**\n * @public\n * Should actually be at-internal\n *\n * Constructor options for JsonRulesEngineFactChecker\n */\nexport type JsonRulesEngineFactCheckerOptions = {\n  checks: TechInsightJsonRuleCheck[];\n  repository: TechInsightsStore;\n  logger: LoggerService;\n  checkRegistry?: TechInsightCheckRegistry<any>;\n  operators?: Operator[];\n};\n\n/**\n * @public\n * Should actually be at-internal\n *\n * FactChecker implementation using json-rules-engine\n */\nexport class JsonRulesEngineFactChecker\n  implements FactChecker<TechInsightJsonRuleCheck, JsonRuleBooleanCheckResult>\n{\n  private readonly checkRegistry: TechInsightCheckRegistry<TechInsightJsonRuleCheck>;\n  private repository: TechInsightsStore;\n  private readonly logger: LoggerService;\n  private readonly validationSchema: SchemaObject;\n  private readonly operators: Operator[];\n\n  constructor(options: JsonRulesEngineFactCheckerOptions) {\n    const { checks, repository, logger, checkRegistry, operators } = options;\n\n    this.repository = repository;\n    this.logger = logger;\n    this.operators = operators || [];\n    this.validationSchema = JSON.parse(JSON.stringify(validationSchema));\n\n    this.operators.forEach(op => {\n      this.validationSchema.definitions.condition.properties.operator.anyOf.push(\n        { const: op.name },\n      );\n    });\n\n    checks.forEach(check => this.validate(check));\n    this.checkRegistry =\n      checkRegistry ??\n      new DefaultCheckRegistry<TechInsightJsonRuleCheck>(checks);\n  }\n\n  async runChecks(\n    entity: string,\n    checks?: string[],\n  ): Promise<JsonRuleBooleanCheckResult[]> {\n    const engine = new Engine();\n    this.operators.forEach(op => {\n      engine.addOperator(op);\n    });\n\n    const techInsightChecks = checks\n      ? await this.checkRegistry.getAll(checks)\n      : await this.checkRegistry.list();\n    const factRetrieversIds = techInsightChecks.flatMap(it => it.factIds);\n    const facts = await this.repository.getLatestFactsByIds(\n      factRetrieversIds,\n      entity,\n    );\n\n    const schemas = await this.repository.getLatestSchemas(factRetrieversIds);\n\n    // get list of available fact names\n    const factNames = flatten(schemas.map(schema => Object.keys(schema)));\n\n    const factValues = Object.values(facts).reduce(\n      (acc, it) => ({ ...acc, ...it.facts }),\n      {} as FlatTechInsightFact,\n    );\n\n    techInsightChecks.forEach(techInsightCheck => {\n      const rule = techInsightCheck.rule;\n      rule.name = techInsightCheck.id;\n\n      // Only run checks that have all the facts available:\n      const usedFacts = this.retrieveIndividualFactReferences(\n        techInsightCheck.rule.conditions,\n      );\n\n      // check if all facts are known - factNames are correct\n      const allFactsNamesArePresent = usedFacts.every(factId =>\n        factNames.includes(factId),\n      );\n      if (!allFactsNamesArePresent) {\n        // invalid facts - not included in factNames\n        throw new Error(\n          `Not all facts are defined: ${usedFacts.filter(\n            usedFact => !factNames.includes(usedFact),\n          )}`,\n        );\n      }\n\n      // Checks if all facts are present in the factValues\n      const hasFacts = usedFacts.every(factId =>\n        factValues.hasOwnProperty(factId),\n      );\n      if (hasFacts) {\n        engine.addRule({ ...techInsightCheck.rule, event: noopEvent });\n      } else {\n        this.logger.debug(\n          `Skipping ${\n            rule.name\n          } due to missing facts: ${techInsightCheck.factIds\n            .filter(factId => !facts[factId])\n            .join(', ')}`,\n        );\n      }\n    });\n\n    try {\n      const results = await engine.run(factValues);\n      return await this.ruleEngineResultsToCheckResponse(\n        results,\n        techInsightChecks,\n        Object.values(facts),\n      );\n    } catch (e) {\n      if (isError(e)) {\n        throw new Error(`Failed to run rules engine, ${e.message}`, {\n          cause: e,\n        });\n      }\n      throw e;\n    }\n  }\n\n  async validate(\n    check: TechInsightJsonRuleCheck,\n  ): Promise<CheckValidationResponse> {\n    const ajv = new Ajv({ verbose: true });\n    const validator = ajv.compile(this.validationSchema);\n    const isValidToSchema = validator(check.rule);\n    if (check.type !== JSON_RULE_ENGINE_CHECK_TYPE) {\n      const msg = `Only ${JSON_RULE_ENGINE_CHECK_TYPE} checks can be registered to this fact checker`;\n      this.logger.warn(msg);\n      return {\n        valid: false,\n        message: msg,\n      };\n    }\n    if (!isValidToSchema) {\n      const msg = 'Failed to to validate conditions against JSON schema';\n      this.logger.warn(\n        'Failed to to validate conditions against JSON schema',\n        new Error(JSON.stringify(validator.errors)),\n      );\n      return {\n        valid: false,\n        message: msg,\n        errors: validator.errors ? validator.errors : undefined,\n      };\n    }\n\n    const existingSchemas = await this.repository.getLatestSchemas(\n      check.factIds,\n    );\n    const references = this.retrieveIndividualFactReferences(\n      check.rule.conditions,\n    );\n    const results = references.map(ref => ({\n      ref,\n      result: existingSchemas.some(schema => schema.hasOwnProperty(ref)),\n    }));\n    const failedReferences = results.filter(it => !it.result);\n    failedReferences.forEach(it => {\n      this.logger.warn(\n        `Validation failed for check ${check.name}. Reference to value ${\n          it.ref\n        } does not exists in referred fact schemas: ${check.factIds.join(',')}`,\n      );\n    });\n    const valid = failedReferences.length === 0;\n    return {\n      valid,\n      ...(!valid\n        ? {\n            message: `Check is referencing missing values from fact schemas: ${failedReferences\n              .map(it => it.ref)\n              .join(',')}`,\n          }\n        : {}),\n    };\n  }\n\n  getChecks(): Promise<TechInsightJsonRuleCheck[]> {\n    return this.checkRegistry.list();\n  }\n\n  private retrieveIndividualFactReferences(\n    condition: TopLevelCondition | { fact: string },\n  ): string[] {\n    let results: string[] = [];\n    if ('all' in condition) {\n      results = results.concat(\n        condition.all.flatMap(con =>\n          this.retrieveIndividualFactReferences(con),\n        ),\n      );\n    } else if ('any' in condition) {\n      results = results.concat(\n        condition.any.flatMap(con =>\n          this.retrieveIndividualFactReferences(con),\n        ),\n      );\n    } else if ('not' in condition) {\n      results = results.concat(\n        this.retrieveIndividualFactReferences(condition.not),\n      );\n    } else if ('condition' in condition) {\n      // ignore the ConditionReference type\n    } else {\n      results.push(condition.fact);\n    }\n    return results;\n  }\n\n  private async ruleEngineResultsToCheckResponse(\n    results: EngineResult,\n    techInsightChecks: TechInsightJsonRuleCheck[],\n    facts: FlatTechInsightFact[],\n  ) {\n    return await Promise.all(\n      [\n        ...(results.results && results.results),\n        ...(results.failureResults && results.failureResults),\n      ].map(async result => {\n        const techInsightCheck = techInsightChecks.find(\n          check => check.id === result.name,\n        );\n        if (!techInsightCheck) {\n          // This should never happen, we just constructed these based on each other\n          throw new Error(\n            `Failed to determine tech insight check with id ${result.name}. Discrepancy between ran rule engine and configured checks.`,\n          );\n        }\n        const factResponse = await this.constructFactInformationResponse(\n          facts,\n          techInsightCheck,\n        );\n        return {\n          facts: factResponse,\n          result: result.result,\n          check: JsonRulesEngineFactChecker.constructCheckResponse(\n            techInsightCheck,\n            result,\n          ),\n        };\n      }),\n    );\n  }\n\n  private static constructCheckResponse(\n    techInsightCheck: TechInsightJsonRuleCheck,\n    result: any,\n  ) {\n    const returnable = {\n      id: techInsightCheck.id,\n      type: techInsightCheck.type,\n      name: techInsightCheck.name,\n      description: techInsightCheck.description,\n      factIds: techInsightCheck.factIds,\n      metadata: result.result\n        ? { ...techInsightCheck.metadata, ...techInsightCheck.successMetadata }\n        : { ...techInsightCheck.metadata, ...techInsightCheck.failureMetadata },\n      rule: { conditions: {} },\n      links: techInsightCheck.links,\n    };\n\n    if ('toJSON' in result) {\n      // Results from json-rules-engine serialize \"wrong\" since the objects are creating their own serialization implementations.\n      // 'toJSON' should always be present in the result object but it is missing from the types.\n      // Parsing the stringified representation into a plain object here to be able to serialize it later\n      // along with other items present in the returned response.\n      const rule = JSON.parse(result.toJSON());\n      return { ...returnable, rule: pick(rule, ['conditions']) };\n    }\n    return returnable;\n  }\n\n  private async constructFactInformationResponse(\n    facts: FlatTechInsightFact[],\n    techInsightCheck: TechInsightJsonRuleCheck,\n  ): Promise<FactResponse> {\n    const factSchemas = await this.repository.getLatestSchemas(\n      techInsightCheck.factIds,\n    );\n    const schemas = factSchemas.reduce(\n      (acc, schema) => ({ ...acc, ...schema }),\n      {},\n    );\n    const individualFacts = this.retrieveIndividualFactReferences(\n      techInsightCheck.rule.conditions,\n    );\n    const factValues = facts\n      .filter(factContainer =>\n        techInsightCheck.factIds.includes(factContainer.id),\n      )\n      .reduce(\n        (acc, factContainer) => ({\n          ...acc,\n          ...pick(factContainer.facts, individualFacts),\n        }),\n        {},\n      );\n    return Object.entries(factValues).reduce((acc, [key, value]) => {\n      return {\n        ...acc,\n        [key]: {\n          value,\n          ...schemas[key],\n        },\n      };\n    }, {});\n  }\n}\n\n/**\n * @public\n *\n * Constructor options for JsonRulesEngineFactCheckerFactory\n *\n * Implementation of checkRegistry is optional.\n * If there is a need to use persistent storage for checks, it is recommended to inject a storage implementation here.\n * Otherwise, an in-memory option is instantiated and used.\n */\nexport type JsonRulesEngineFactCheckerFactoryOptions = {\n  checks: TechInsightJsonRuleCheck[];\n  logger: LoggerService;\n  checkRegistry?: TechInsightCheckRegistry<TechInsightJsonRuleCheck>;\n  operators?: Operator[];\n};\n\n/**\n * @public\n *\n * Factory to construct JsonRulesEngineFactChecker\n * Can be constructed with optional implementation of CheckInsightCheckRegistry if needed.\n * Otherwise, defaults to using in-memory CheckRegistry.\n */\nexport class JsonRulesEngineFactCheckerFactory {\n  private readonly checks: TechInsightJsonRuleCheck[];\n  private readonly logger: LoggerService;\n  private readonly checkRegistry?: TechInsightCheckRegistry<TechInsightJsonRuleCheck>;\n  private readonly operators?: Operator[];\n\n  static fromConfig(\n    config: Config,\n    options: Omit<JsonRulesEngineFactCheckerFactoryOptions, 'checks'>,\n  ): JsonRulesEngineFactCheckerFactory {\n    const checks = readChecksFromConfig(config, { logger: options.logger });\n\n    return new JsonRulesEngineFactCheckerFactory({\n      ...options,\n      checks,\n    });\n  }\n\n  constructor(options: JsonRulesEngineFactCheckerFactoryOptions) {\n    this.logger = options.logger;\n    this.checks = options.checks;\n    this.checkRegistry = options.checkRegistry;\n    this.operators = options.operators;\n  }\n\n  /**\n   * @param repository - Implementation of TechInsightsStore. Used by the returned JsonRulesEngineFactChecker\n   *                     to retrieve fact and fact schema data\n   * @returns JsonRulesEngineFactChecker implementation\n   */\n  construct(repository: TechInsightsStore) {\n    return new JsonRulesEngineFactChecker({\n      checks: this.checks,\n      logger: this.logger,\n      checkRegistry: this.checkRegistry,\n      repository,\n      operators: this.operators,\n    });\n  }\n}\n"],"names":["DefaultCheckRegistry","Engine","flatten","isError","Ajv","JSON_RULE_ENGINE_CHECK_TYPE","pick","config","readChecksFromConfig"],"mappings":"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"}