{"version":3,"file":"config.cjs.js","sources":["../../src/service/config.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { TopLevelCondition } from 'json-rules-engine';\nimport { Rule, TechInsightJsonRuleCheck } from '../types';\nimport { CheckLink } from '@backstage-community/plugin-tech-insights-common';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n// copy of non-exported `ConditionProperties` from 'json-rules-engine'\ninterface ConditionProperties {\n  fact: string;\n  operator: string;\n  value: { fact: string } | any;\n  path?: string;\n  priority?: number;\n  params?: Record<string, any>;\n  name?: string;\n}\n\n// copy of non-exported `NestedCondition` from 'json-rules-engine'\ntype NestedCondition = ConditionProperties | TopLevelCondition;\n\nfunction readRuleConditionProperties(config: Config): ConditionProperties {\n  const fact = config.getString('fact');\n  const name = config.getOptionalString('name');\n  const operator = config.getString('operator');\n  const params = config.getOptionalConfig('params')?.get<Record<string, any>>();\n  const path = config.getOptionalString('path');\n  const priority = config.getOptionalNumber('priority');\n  const value: { fact: string } | any = config.get('value');\n\n  return {\n    fact,\n    name,\n    operator,\n    params,\n    path,\n    priority,\n    value,\n  };\n}\n\ntype ReadChecksFromConfigOptions = {\n  logger: LoggerService;\n};\n\nfunction readRuleNestedCondition(config: Config): NestedCondition {\n  if (config.has('fact')) {\n    return readRuleConditionProperties(config);\n  }\n\n  return readRuleTopLevelCondition(config);\n}\n\nfunction readRuleTopLevelCondition(config: Config): TopLevelCondition {\n  const base = {\n    name: config.getOptionalString('name'),\n    priority: config.getOptionalNumber('priority'),\n  };\n\n  if (config.has('all')) {\n    const all = config\n      .getConfigArray('all')\n      .map(conditionConfig => readRuleNestedCondition(conditionConfig));\n    return {\n      ...base,\n      all,\n    };\n  }\n\n  if (config.has('any')) {\n    const any = config\n      .getConfigArray('any')\n      .map(conditionConfig => readRuleNestedCondition(conditionConfig));\n    return {\n      ...base,\n      any,\n    };\n  }\n\n  if (config.has('not')) {\n    const not = readRuleNestedCondition(config.getConfig('not'));\n    return {\n      ...base,\n      not,\n    };\n  }\n\n  const condition = config.getString('condition');\n\n  return {\n    ...base,\n    condition,\n  };\n}\n\nfunction readRuleFromRuleConfig(config: Config): Rule {\n  const conditions = readRuleTopLevelCondition(config.getConfig('conditions'));\n  const name = config.getOptionalString('name');\n  const priority = config.getOptionalNumber('priority');\n\n  return {\n    conditions,\n    name,\n    priority,\n  };\n}\n\nfunction readLinksForCheck(\n  linkConfig: Config[] | undefined,\n  opts: ReadChecksFromConfigOptions,\n): CheckLink[] | undefined {\n  const checkLinks: CheckLink[] = [];\n\n  linkConfig?.map(link => {\n    try {\n      checkLinks.push({\n        title: link.getString('title'),\n        url: link.getString('url'),\n      });\n    } catch (e) {\n      opts.logger.error('Missing required fields for link in check config', e);\n    }\n  });\n\n  if (checkLinks.length === 0) {\n    return undefined;\n  }\n\n  return checkLinks;\n}\n\nfunction readCheckFromCheckConfig(\n  id: string,\n  config: Config,\n  opts: ReadChecksFromConfigOptions,\n): TechInsightJsonRuleCheck {\n  const type = config.getString('type');\n  const name = config.getString('name');\n  const description = config.getString('description');\n  const factIds = config.getStringArray('factIds');\n  const metadata = config\n    .getOptionalConfig('metadata')\n    ?.get<Record<string, any>>();\n  const successMetadata = config\n    .getOptionalConfig('successMetadata')\n    ?.get<Record<string, any>>();\n  const failureMetadata = config\n    .getOptionalConfig('failureMetadata')\n    ?.get<Record<string, any>>();\n  const rule = readRuleFromRuleConfig(config.getConfig('rule'));\n  const links = readLinksForCheck(config.getOptionalConfigArray('links'), opts);\n\n  return {\n    description,\n    factIds,\n    failureMetadata,\n    id,\n    metadata,\n    name,\n    rule,\n    successMetadata,\n    type,\n    links,\n  };\n}\n\nexport function readChecksFromConfig(\n  config: Config,\n  opts: ReadChecksFromConfigOptions,\n): TechInsightJsonRuleCheck[] {\n  const key = 'techInsights.factChecker.checks';\n  if (!config.has(key)) {\n    return [];\n  }\n\n  const checksConfig = config.getConfig(key);\n  const checks: TechInsightJsonRuleCheck[] = [];\n  checksConfig.keys().forEach(checkId => {\n    const checkConfig = checksConfig.getConfig(checkId);\n\n    checks.push(readCheckFromCheckConfig(checkId, checkConfig, opts));\n  });\n\n  return checks;\n}\n"],"names":[],"mappings":";;AAoCA,SAAS,4BAA4B,MAAqC,EAAA;AACxE,EAAM,MAAA,IAAA,GAAO,MAAO,CAAA,SAAA,CAAU,MAAM,CAAA;AACpC,EAAM,MAAA,IAAA,GAAO,MAAO,CAAA,iBAAA,CAAkB,MAAM,CAAA;AAC5C,EAAM,MAAA,QAAA,GAAW,MAAO,CAAA,SAAA,CAAU,UAAU,CAAA;AAC5C,EAAA,MAAM,MAAS,GAAA,MAAA,CAAO,iBAAkB,CAAA,QAAQ,GAAG,GAAyB,EAAA;AAC5E,EAAM,MAAA,IAAA,GAAO,MAAO,CAAA,iBAAA,CAAkB,MAAM,CAAA;AAC5C,EAAM,MAAA,QAAA,GAAW,MAAO,CAAA,iBAAA,CAAkB,UAAU,CAAA;AACpD,EAAM,MAAA,KAAA,GAAgC,MAAO,CAAA,GAAA,CAAI,OAAO,CAAA;AAExD,EAAO,OAAA;AAAA,IACL,IAAA;AAAA,IACA,IAAA;AAAA,IACA,QAAA;AAAA,IACA,MAAA;AAAA,IACA,IAAA;AAAA,IACA,QAAA;AAAA,IACA;AAAA,GACF;AACF;AAMA,SAAS,wBAAwB,MAAiC,EAAA;AAChE,EAAI,IAAA,MAAA,CAAO,GAAI,CAAA,MAAM,CAAG,EAAA;AACtB,IAAA,OAAO,4BAA4B,MAAM,CAAA;AAAA;AAG3C,EAAA,OAAO,0BAA0B,MAAM,CAAA;AACzC;AAEA,SAAS,0BAA0B,MAAmC,EAAA;AACpE,EAAA,MAAM,IAAO,GAAA;AAAA,IACX,IAAA,EAAM,MAAO,CAAA,iBAAA,CAAkB,MAAM,CAAA;AAAA,IACrC,QAAA,EAAU,MAAO,CAAA,iBAAA,CAAkB,UAAU;AAAA,GAC/C;AAEA,EAAI,IAAA,MAAA,CAAO,GAAI,CAAA,KAAK,CAAG,EAAA;AACrB,IAAM,MAAA,GAAA,GAAM,OACT,cAAe,CAAA,KAAK,EACpB,GAAI,CAAA,CAAA,eAAA,KAAmB,uBAAwB,CAAA,eAAe,CAAC,CAAA;AAClE,IAAO,OAAA;AAAA,MACL,GAAG,IAAA;AAAA,MACH;AAAA,KACF;AAAA;AAGF,EAAI,IAAA,MAAA,CAAO,GAAI,CAAA,KAAK,CAAG,EAAA;AACrB,IAAM,MAAA,GAAA,GAAM,OACT,cAAe,CAAA,KAAK,EACpB,GAAI,CAAA,CAAA,eAAA,KAAmB,uBAAwB,CAAA,eAAe,CAAC,CAAA;AAClE,IAAO,OAAA;AAAA,MACL,GAAG,IAAA;AAAA,MACH;AAAA,KACF;AAAA;AAGF,EAAI,IAAA,MAAA,CAAO,GAAI,CAAA,KAAK,CAAG,EAAA;AACrB,IAAA,MAAM,GAAM,GAAA,uBAAA,CAAwB,MAAO,CAAA,SAAA,CAAU,KAAK,CAAC,CAAA;AAC3D,IAAO,OAAA;AAAA,MACL,GAAG,IAAA;AAAA,MACH;AAAA,KACF;AAAA;AAGF,EAAM,MAAA,SAAA,GAAY,MAAO,CAAA,SAAA,CAAU,WAAW,CAAA;AAE9C,EAAO,OAAA;AAAA,IACL,GAAG,IAAA;AAAA,IACH;AAAA,GACF;AACF;AAEA,SAAS,uBAAuB,MAAsB,EAAA;AACpD,EAAA,MAAM,UAAa,GAAA,yBAAA,CAA0B,MAAO,CAAA,SAAA,CAAU,YAAY,CAAC,CAAA;AAC3E,EAAM,MAAA,IAAA,GAAO,MAAO,CAAA,iBAAA,CAAkB,MAAM,CAAA;AAC5C,EAAM,MAAA,QAAA,GAAW,MAAO,CAAA,iBAAA,CAAkB,UAAU,CAAA;AAEpD,EAAO,OAAA;AAAA,IACL,UAAA;AAAA,IACA,IAAA;AAAA,IACA;AAAA,GACF;AACF;AAEA,SAAS,iBAAA,CACP,YACA,IACyB,EAAA;AACzB,EAAA,MAAM,aAA0B,EAAC;AAEjC,EAAA,UAAA,EAAY,IAAI,CAAQ,IAAA,KAAA;AACtB,IAAI,IAAA;AACF,MAAA,UAAA,CAAW,IAAK,CAAA;AAAA,QACd,KAAA,EAAO,IAAK,CAAA,SAAA,CAAU,OAAO,CAAA;AAAA,QAC7B,GAAA,EAAK,IAAK,CAAA,SAAA,CAAU,KAAK;AAAA,OAC1B,CAAA;AAAA,aACM,CAAG,EAAA;AACV,MAAK,IAAA,CAAA,MAAA,CAAO,KAAM,CAAA,kDAAA,EAAoD,CAAC,CAAA;AAAA;AACzE,GACD,CAAA;AAED,EAAI,IAAA,UAAA,CAAW,WAAW,CAAG,EAAA;AAC3B,IAAO,OAAA,KAAA,CAAA;AAAA;AAGT,EAAO,OAAA,UAAA;AACT;AAEA,SAAS,wBAAA,CACP,EACA,EAAA,MAAA,EACA,IAC0B,EAAA;AAC1B,EAAM,MAAA,IAAA,GAAO,MAAO,CAAA,SAAA,CAAU,MAAM,CAAA;AACpC,EAAM,MAAA,IAAA,GAAO,MAAO,CAAA,SAAA,CAAU,MAAM,CAAA;AACpC,EAAM,MAAA,WAAA,GAAc,MAAO,CAAA,SAAA,CAAU,aAAa,CAAA;AAClD,EAAM,MAAA,OAAA,GAAU,MAAO,CAAA,cAAA,CAAe,SAAS,CAAA;AAC/C,EAAA,MAAM,QAAW,GAAA,MAAA,CACd,iBAAkB,CAAA,UAAU,GAC3B,GAAyB,EAAA;AAC7B,EAAA,MAAM,eAAkB,GAAA,MAAA,CACrB,iBAAkB,CAAA,iBAAiB,GAClC,GAAyB,EAAA;AAC7B,EAAA,MAAM,eAAkB,GAAA,MAAA,CACrB,iBAAkB,CAAA,iBAAiB,GAClC,GAAyB,EAAA;AAC7B,EAAA,MAAM,IAAO,GAAA,sBAAA,CAAuB,MAAO,CAAA,SAAA,CAAU,MAAM,CAAC,CAAA;AAC5D,EAAA,MAAM,QAAQ,iBAAkB,CAAA,MAAA,CAAO,sBAAuB,CAAA,OAAO,GAAG,IAAI,CAAA;AAE5E,EAAO,OAAA;AAAA,IACL,WAAA;AAAA,IACA,OAAA;AAAA,IACA,eAAA;AAAA,IACA,EAAA;AAAA,IACA,QAAA;AAAA,IACA,IAAA;AAAA,IACA,IAAA;AAAA,IACA,eAAA;AAAA,IACA,IAAA;AAAA,IACA;AAAA,GACF;AACF;AAEgB,SAAA,oBAAA,CACd,QACA,IAC4B,EAAA;AAC5B,EAAA,MAAM,GAAM,GAAA,iCAAA;AACZ,EAAA,IAAI,CAAC,MAAA,CAAO,GAAI,CAAA,GAAG,CAAG,EAAA;AACpB,IAAA,OAAO,EAAC;AAAA;AAGV,EAAM,MAAA,YAAA,GAAe,MAAO,CAAA,SAAA,CAAU,GAAG,CAAA;AACzC,EAAA,MAAM,SAAqC,EAAC;AAC5C,EAAa,YAAA,CAAA,IAAA,EAAO,CAAA,OAAA,CAAQ,CAAW,OAAA,KAAA;AACrC,IAAM,MAAA,WAAA,GAAc,YAAa,CAAA,SAAA,CAAU,OAAO,CAAA;AAElD,IAAA,MAAA,CAAO,IAAK,CAAA,wBAAA,CAAyB,OAAS,EAAA,WAAA,EAAa,IAAI,CAAC,CAAA;AAAA,GACjE,CAAA;AAED,EAAO,OAAA,MAAA;AACT;;;;"}