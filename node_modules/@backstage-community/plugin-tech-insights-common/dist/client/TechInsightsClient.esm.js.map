{"version":3,"file":"TechInsightsClient.esm.js","sources":["../../src/client/TechInsightsClient.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BulkCheckResponse,\n  CheckResult,\n  FactSchema,\n  Check,\n  InsightFacts,\n} from '@backstage-community/plugin-tech-insights-common';\nimport { DiscoveryApi, IdentityApi } from '@backstage/core-plugin-api';\nimport { ResponseError } from '@backstage/errors';\nimport {\n  CompoundEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport qs from 'qs';\nimport { AuthService } from '@backstage/backend-plugin-api';\nimport stableStringify from 'fast-json-stable-stringify';\n\n/**\n * Client to fetch data from tech-insights backend\n *\n * @public */\nexport class TechInsightsClient {\n  private readonly discoveryApi: DiscoveryApi;\n  private readonly identityApi: IdentityApi | AuthService;\n  private readonly apiCache = new Map<string, Promise<any>>();\n  private readonly chunkSize = 750;\n\n  constructor(options: {\n    discoveryApi: DiscoveryApi;\n    identityApi: IdentityApi | AuthService;\n  }) {\n    this.discoveryApi = options.discoveryApi;\n    this.identityApi = options.identityApi;\n  }\n\n  /**\n   * Get facts for a specific entity\n   * @param entity - a component reference\n   * @param facts - a list fact ids to fetch\n   * @public\n   */\n  async getFacts(\n    entity: CompoundEntityRef,\n    facts: string[],\n  ): Promise<InsightFacts> {\n    const query = qs.stringify({\n      entity: stringifyEntityRef(entity),\n      ids: facts,\n    });\n    return await this.api<InsightFacts>(`/facts/latest?${query}`);\n  }\n\n  /**\n   * Get all checks.\n   * This will not return the actual status, but only metadata. To get the status use the /run endpoint\n   * @public\n   */\n  async getAllChecks(): Promise<Check[]> {\n    return this.api('/checks');\n  }\n\n  /**\n   * Get schemas of facts.\n   * Use this for example to understand what the return values will be\n   * @public\n   */\n  async getFactSchemas(): Promise<FactSchema[]> {\n    return this.api('/fact-schemas');\n  }\n\n  /**\n   * Run checks for a specific entity\n   * @param entityParams - reference to an entity\n   * @param checks - IDs of checks to run\n   * @public\n   */\n  async runChecks(\n    entityParams: CompoundEntityRef,\n    checks?: string[],\n  ): Promise<CheckResult[]> {\n    const { namespace, kind, name } = entityParams;\n    const requestBody = { checks };\n    return this.api(\n      `/checks/run/${encodeURIComponent(namespace)}/${encodeURIComponent(\n        kind,\n      )}/${encodeURIComponent(name)}`,\n      {\n        method: 'POST',\n        body: JSON.stringify(requestBody),\n      },\n    );\n  }\n\n  /**\n   * Return checks for multiple entities\n   * @param entities - list of entity references\n   * @param checks - list of check IDs\n   * @public\n   */\n  async runBulkChecks(\n    entities: CompoundEntityRef[],\n    checks?: Check[],\n  ): Promise<BulkCheckResponse> {\n    const checkIds = checks ? checks.map(check => check.id) : [];\n    let bulkResponse: BulkCheckResponse = [];\n    for (let i = 0; i <= entities.length; i += this.chunkSize) {\n      const chunk = entities.slice(i, i + this.chunkSize);\n      const requestBody = {\n        entities: chunk,\n        checks: checkIds.length > 0 ? checkIds : undefined,\n      };\n      const response = await this.api('/checks/run', {\n        method: 'POST',\n        body: JSON.stringify(requestBody),\n      });\n      bulkResponse = bulkResponse.concat(response as BulkCheckResponse);\n    }\n    return bulkResponse;\n  }\n\n  private getCacheKey(path: string, init?: RequestInit): string {\n    return `${path} ${stableStringify(init ?? {})}`;\n  }\n\n  private async api<T>(path: string, init?: RequestInit): Promise<T> {\n    const url = await this.discoveryApi.getBaseUrl('tech-insights');\n\n    const cacheKey = this.getCacheKey(`${url}${path}`, init);\n    const cached = this.apiCache.get(cacheKey);\n    if (cached) {\n      return cached;\n    }\n\n    const result = (async () => {\n      const token = await this.getToken();\n\n      const headers: HeadersInit = new Headers(init?.headers);\n      if (!headers.has('content-type'))\n        headers.set('content-type', 'application/json');\n      if (token && !headers.has('authorization')) {\n        headers.set('authorization', `Bearer ${token}`);\n      }\n\n      const request = new Request(`${url}${path}`, {\n        ...init,\n        headers,\n      });\n\n      return fetch(request).then(async response => {\n        if (!response.ok) {\n          throw await ResponseError.fromResponse(response);\n        }\n        return response.json() as Promise<T>;\n      });\n    })();\n\n    // Fill cache, and clear after 2 seconds\n    this.apiCache.set(cacheKey, result);\n    setTimeout(() => {\n      this.apiCache.delete(cacheKey);\n    }, 2000);\n\n    return result;\n  }\n\n  private async getToken(): Promise<string | null> {\n    let result: { token?: string | undefined };\n\n    if ('getCredentials' in this.identityApi) {\n      result = await this.identityApi.getCredentials();\n    } else {\n      result = await this.identityApi.getPluginRequestToken({\n        onBehalfOf: await this.identityApi.getOwnServiceCredentials(),\n        targetPluginId: 'tech-insights',\n      });\n    }\n\n    return result.token ?? null;\n  }\n}\n"],"names":[],"mappings":"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"}