{"version":3,"file":"plugin.cjs.js","sources":["../../src/plugin/plugin.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport {\n  CheckResult,\n  Check,\n  techInsightsPermissions,\n} from '@backstage-community/plugin-tech-insights-common';\nimport {\n  FactCheckerFactory,\n  FactRetriever,\n  FactRetrieverRegistration,\n  FactRetrieverRegistry,\n  PersistenceContext,\n  techInsightsFactCheckerFactoryExtensionPoint,\n  techInsightsFactRetrieverRegistryExtensionPoint,\n  techInsightsFactRetrieversExtensionPoint,\n  techInsightsPersistenceContextExtensionPoint,\n} from '@backstage-community/plugin-tech-insights-node';\nimport {\n  buildTechInsightsContext,\n  createRouter,\n  entityMetadataFactRetriever,\n  entityOwnershipFactRetriever,\n  techdocsFactRetriever,\n} from '../service';\nimport { createFactRetrieverRegistrationFromConfig } from './config';\n\n/**\n * The tech-insights backend plugin.\n *\n * @public\n */\nexport const techInsightsPlugin = createBackendPlugin({\n  pluginId: 'tech-insights',\n  register(env) {\n    let factCheckerFactory: FactCheckerFactory<Check, CheckResult> | undefined =\n      undefined;\n    env.registerExtensionPoint(techInsightsFactCheckerFactoryExtensionPoint, {\n      setFactCheckerFactory<\n        CheckType extends Check,\n        CheckResultType extends CheckResult,\n      >(factory: FactCheckerFactory<CheckType, CheckResultType>): void {\n        factCheckerFactory = factory;\n      },\n    });\n\n    let factRetrieverRegistry: FactRetrieverRegistry | undefined = undefined;\n    env.registerExtensionPoint(\n      techInsightsFactRetrieverRegistryExtensionPoint,\n      {\n        setFactRetrieverRegistry(registry: FactRetrieverRegistry): void {\n          factRetrieverRegistry = registry;\n        },\n      },\n    );\n\n    // initialized with built-in fact retrievers\n    // only added as registration if there is config for them\n    const addedFactRetrievers: Record<string, FactRetriever> = {\n      entityMetadataFactRetriever,\n      entityOwnershipFactRetriever,\n      techdocsFactRetriever,\n    };\n    env.registerExtensionPoint(techInsightsFactRetrieversExtensionPoint, {\n      addFactRetrievers(factRetrievers: Record<string, FactRetriever>): void {\n        Object.entries(factRetrievers).forEach(([key, value]) => {\n          addedFactRetrievers[key] = value;\n        });\n      },\n    });\n\n    let persistenceContext: PersistenceContext | undefined = undefined;\n    env.registerExtensionPoint(techInsightsPersistenceContextExtensionPoint, {\n      setPersistenceContext(context: PersistenceContext): void {\n        persistenceContext = context;\n      },\n    });\n\n    env.registerInit({\n      deps: {\n        config: coreServices.rootConfig,\n        database: coreServices.database,\n        discovery: coreServices.discovery,\n        httpRouter: coreServices.httpRouter,\n        logger: coreServices.logger,\n        scheduler: coreServices.scheduler,\n        auth: coreServices.auth,\n        urlReader: coreServices.urlReader,\n        httpAuth: coreServices.httpAuth,\n        permissions: coreServices.permissions,\n        permissionsRegistry: coreServices.permissionsRegistry,\n      },\n      async init({\n        config,\n        database,\n        discovery,\n        httpRouter,\n        logger,\n        scheduler,\n        auth,\n        urlReader,\n        httpAuth,\n        permissions,\n        permissionsRegistry,\n      }) {\n        permissionsRegistry.addPermissions(techInsightsPermissions);\n\n        const factRetrievers: FactRetrieverRegistration[] = Object.entries(\n          addedFactRetrievers,\n        )\n          .map(([name, factRetriever]) =>\n            createFactRetrieverRegistrationFromConfig(\n              config,\n              name,\n              factRetriever,\n            ),\n          )\n          .filter(registration => registration) as FactRetrieverRegistration[];\n\n        const context = await buildTechInsightsContext({\n          config,\n          database,\n          discovery,\n          factCheckerFactory,\n          factRetrieverRegistry,\n          factRetrievers,\n          logger,\n          persistenceContext,\n          scheduler,\n          auth,\n          urlReader,\n        });\n\n        httpRouter.use(\n          await createRouter({\n            ...context,\n            config,\n            logger,\n            permissions,\n            httpAuth,\n          }),\n        );\n      },\n    });\n  },\n});\n"],"names":["createBackendPlugin","techInsightsFactCheckerFactoryExtensionPoint","techInsightsFactRetrieverRegistryExtensionPoint","entityMetadataFactRetriever","entityOwnershipFactRetriever","techdocsFactRetriever","techInsightsFactRetrieversExtensionPoint","techInsightsPersistenceContextExtensionPoint","coreServices","config","techInsightsPermissions","createFactRetrieverRegistrationFromConfig","buildTechInsightsContext","createRouter"],"mappings":";;;;;;;;;;;;;AAkDO,MAAM,qBAAqBA,oCAAoB,CAAA;AAAA,EACpD,QAAU,EAAA,eAAA;AAAA,EACV,SAAS,GAAK,EAAA;AACZ,IAAA,IAAI,kBACF,GAAA,KAAA,CAAA;AACF,IAAA,GAAA,CAAI,uBAAuBC,mEAA8C,EAAA;AAAA,MACvE,sBAGE,OAA+D,EAAA;AAC/D,QAAqB,kBAAA,GAAA,OAAA;AAAA;AACvB,KACD,CAAA;AAED,IAAA,IAAI,qBAA2D,GAAA,KAAA,CAAA;AAC/D,IAAI,GAAA,CAAA,sBAAA;AAAA,MACFC,sEAAA;AAAA,MACA;AAAA,QACE,yBAAyB,QAAuC,EAAA;AAC9D,UAAwB,qBAAA,GAAA,QAAA;AAAA;AAC1B;AACF,KACF;AAIA,IAAA,MAAM,mBAAqD,GAAA;AAAA,mCACzDC,uDAAA;AAAA,oCACAC,yDAAA;AAAA,6BACAC;AAAA,KACF;AACA,IAAA,GAAA,CAAI,uBAAuBC,+DAA0C,EAAA;AAAA,MACnE,kBAAkB,cAAqD,EAAA;AACrE,QAAO,MAAA,CAAA,OAAA,CAAQ,cAAc,CAAE,CAAA,OAAA,CAAQ,CAAC,CAAC,GAAA,EAAK,KAAK,CAAM,KAAA;AACvD,UAAA,mBAAA,CAAoB,GAAG,CAAI,GAAA,KAAA;AAAA,SAC5B,CAAA;AAAA;AACH,KACD,CAAA;AAED,IAAA,IAAI,kBAAqD,GAAA,KAAA,CAAA;AACzD,IAAA,GAAA,CAAI,uBAAuBC,mEAA8C,EAAA;AAAA,MACvE,sBAAsB,OAAmC,EAAA;AACvD,QAAqB,kBAAA,GAAA,OAAA;AAAA;AACvB,KACD,CAAA;AAED,IAAA,GAAA,CAAI,YAAa,CAAA;AAAA,MACf,IAAM,EAAA;AAAA,QACJ,QAAQC,6BAAa,CAAA,UAAA;AAAA,QACrB,UAAUA,6BAAa,CAAA,QAAA;AAAA,QACvB,WAAWA,6BAAa,CAAA,SAAA;AAAA,QACxB,YAAYA,6BAAa,CAAA,UAAA;AAAA,QACzB,QAAQA,6BAAa,CAAA,MAAA;AAAA,QACrB,WAAWA,6BAAa,CAAA,SAAA;AAAA,QACxB,MAAMA,6BAAa,CAAA,IAAA;AAAA,QACnB,WAAWA,6BAAa,CAAA,SAAA;AAAA,QACxB,UAAUA,6BAAa,CAAA,QAAA;AAAA,QACvB,aAAaA,6BAAa,CAAA,WAAA;AAAA,QAC1B,qBAAqBA,6BAAa,CAAA;AAAA,OACpC;AAAA,MACA,MAAM,IAAK,CAAA;AAAA,gBACTC,QAAA;AAAA,QACA,QAAA;AAAA,QACA,SAAA;AAAA,QACA,UAAA;AAAA,QACA,MAAA;AAAA,QACA,SAAA;AAAA,QACA,IAAA;AAAA,QACA,SAAA;AAAA,QACA,QAAA;AAAA,QACA,WAAA;AAAA,QACA;AAAA,OACC,EAAA;AACD,QAAA,mBAAA,CAAoB,eAAeC,gDAAuB,CAAA;AAE1D,QAAA,MAAM,iBAA8C,MAAO,CAAA,OAAA;AAAA,UACzD;AAAA,SAEC,CAAA,GAAA;AAAA,UAAI,CAAC,CAAC,IAAM,EAAA,aAAa,CACxB,KAAAC,gDAAA;AAAA,YACEF,QAAA;AAAA,YACA,IAAA;AAAA,YACA;AAAA;AACF,SACF,CACC,MAAO,CAAA,CAAA,YAAA,KAAgB,YAAY,CAAA;AAEtC,QAAM,MAAA,OAAA,GAAU,MAAMG,mDAAyB,CAAA;AAAA,kBAC7CH,QAAA;AAAA,UACA,QAAA;AAAA,UACA,SAAA;AAAA,UACA,kBAAA;AAAA,UACA,qBAAA;AAAA,UACA,cAAA;AAAA,UACA,MAAA;AAAA,UACA,kBAAA;AAAA,UACA,SAAA;AAAA,UACA,IAAA;AAAA,UACA;AAAA,SACD,CAAA;AAED,QAAW,UAAA,CAAA,GAAA;AAAA,UACT,MAAMI,mBAAa,CAAA;AAAA,YACjB,GAAG,OAAA;AAAA,oBACHJ,QAAA;AAAA,YACA,MAAA;AAAA,YACA,WAAA;AAAA,YACA;AAAA,WACD;AAAA,SACH;AAAA;AACF,KACD,CAAA;AAAA;AAEL,CAAC;;;;"}