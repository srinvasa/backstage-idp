{"version":3,"file":"techInsightsContextBuilder.cjs.js","sources":["../../src/service/techInsightsContextBuilder.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DefaultFactRetrieverEngine,\n  FactRetrieverEngine,\n} from './fact/FactRetrieverEngine';\nimport { DefaultFactRetrieverRegistry } from './fact/FactRetrieverRegistry';\nimport { Config } from '@backstage/config';\nimport {\n  FactChecker,\n  FactCheckerFactory,\n  FactRetrieverRegistration,\n  FactRetrieverRegistry,\n  PersistenceContext,\n} from '@backstage-community/plugin-tech-insights-node';\nimport { initializePersistenceContext } from './persistence';\nimport {\n  CheckResult,\n  Check,\n} from '@backstage-community/plugin-tech-insights-common';\nimport {\n  AuthService,\n  DatabaseService,\n  DiscoveryService,\n  LoggerService,\n  SchedulerService,\n  UrlReaderService,\n} from '@backstage/backend-plugin-api';\n\n/**\n * @public\n * @typeParam CheckType - Type of the check for the fact checker this builder returns\n * @typeParam CheckResultType - Type of the check result for the fact checker this builder returns\n *\n * Configuration options to initialize TechInsightsBuilder. Generic types params are needed if FactCheckerFactory\n * is included for FactChecker creation.\n */\nexport interface TechInsightsOptions<\n  CheckType extends Check,\n  CheckResultType extends CheckResult,\n> {\n  /**\n   * Optional collection of FactRetrieverRegistrations (required if no factRetrieverRegistry passed in).\n   * Used to register FactRetrievers and their schemas and schedule an execution loop for them.\n   *\n   * Not needed if passing in your own FactRetrieverRegistry implementation. Required otherwise.\n   */\n  factRetrievers?: FactRetrieverRegistration[];\n\n  /**\n   * Optional factory exposing a `construct` method to initialize a FactChecker implementation\n   */\n  factCheckerFactory?: FactCheckerFactory<CheckType, CheckResultType>;\n\n  /**\n   * Optional FactRetrieverRegistry implementation that replaces the default one.\n   *\n   * If passing this in you don't need to pass in factRetrievers also.\n   */\n  factRetrieverRegistry?: FactRetrieverRegistry;\n\n  /**\n   * Optional persistenceContext implementation that replaces the default one.\n   * This can be used to replace underlying database with a more suitable implementation if needed\n   */\n  persistenceContext?: PersistenceContext;\n\n  logger: LoggerService;\n  config: Config;\n  discovery: DiscoveryService;\n  database: DatabaseService;\n  scheduler: SchedulerService;\n  auth: AuthService;\n  urlReader: UrlReaderService;\n}\n\n/**\n * @public\n * @typeParam CheckType - Type of the check for the fact checker this builder returns\n * @typeParam CheckResultType - Type of the check result for the fact checker this builder returns\n *\n * A container for exported implementations related to TechInsights.\n * FactChecker is present if an optional FactCheckerFactory is included in the build stage.\n */\nexport type TechInsightsContext<\n  CheckType extends Check,\n  CheckResultType extends CheckResult,\n> = {\n  factChecker?: FactChecker<CheckType, CheckResultType>;\n  persistenceContext: PersistenceContext;\n  factRetrieverEngine: FactRetrieverEngine;\n};\n\n/**\n * @public\n *\n * Constructs needed persistence context, fact retriever engine\n * and optionally fact checker implementations to be used in the tech insights module.\n *\n * @param options - Needed options to construct TechInsightsContext\n * @returns TechInsightsContext with persistence implementations and optionally an implementation of a FactChecker\n */\nexport const buildTechInsightsContext = async <\n  CheckType extends Check,\n  CheckResultType extends CheckResult,\n>(\n  options: TechInsightsOptions<CheckType, CheckResultType>,\n): Promise<TechInsightsContext<CheckType, CheckResultType>> => {\n  const {\n    factRetrievers,\n    factCheckerFactory,\n    config,\n    discovery,\n    database,\n    logger,\n    scheduler,\n    auth,\n    urlReader,\n  } = options;\n\n  const buildFactRetrieverRegistry = (): FactRetrieverRegistry => {\n    if (!options.factRetrieverRegistry) {\n      if (!factRetrievers) {\n        throw new Error(\n          'Failed to build FactRetrieverRegistry because no factRetrievers found',\n        );\n      }\n      return new DefaultFactRetrieverRegistry(factRetrievers);\n    }\n    return options.factRetrieverRegistry;\n  };\n\n  const factRetrieverRegistry = buildFactRetrieverRegistry();\n\n  const persistenceContext =\n    options.persistenceContext ??\n    (await initializePersistenceContext(database, {\n      logger,\n    }));\n\n  const factRetrieverEngine = await DefaultFactRetrieverEngine.create({\n    scheduler,\n    repository: persistenceContext.techInsightsStore,\n    factRetrieverRegistry,\n    factRetrieverContext: {\n      config,\n      discovery,\n      logger,\n      auth,\n      urlReader,\n    },\n  });\n\n  await factRetrieverEngine.schedule();\n\n  if (factCheckerFactory) {\n    const factChecker = factCheckerFactory.construct(\n      persistenceContext.techInsightsStore,\n    );\n    return {\n      persistenceContext,\n      factChecker,\n      factRetrieverEngine,\n    };\n  }\n\n  return {\n    persistenceContext,\n    factRetrieverEngine,\n  };\n};\n"],"names":["DefaultFactRetrieverRegistry","persistenceContext","initializePersistenceContext","DefaultFactRetrieverEngine"],"mappings":";;;;;;AAoHa,MAAA,wBAAA,GAA2B,OAItC,OAC6D,KAAA;AAC7D,EAAM,MAAA;AAAA,IACJ,cAAA;AAAA,IACA,kBAAA;AAAA,IACA,MAAA;AAAA,IACA,SAAA;AAAA,IACA,QAAA;AAAA,IACA,MAAA;AAAA,IACA,SAAA;AAAA,IACA,IAAA;AAAA,IACA;AAAA,GACE,GAAA,OAAA;AAEJ,EAAA,MAAM,6BAA6B,MAA6B;AAC9D,IAAI,IAAA,CAAC,QAAQ,qBAAuB,EAAA;AAClC,MAAA,IAAI,CAAC,cAAgB,EAAA;AACnB,QAAA,MAAM,IAAI,KAAA;AAAA,UACR;AAAA,SACF;AAAA;AAEF,MAAO,OAAA,IAAIA,mDAA6B,cAAc,CAAA;AAAA;AAExD,IAAA,OAAO,OAAQ,CAAA,qBAAA;AAAA,GACjB;AAEA,EAAA,MAAM,wBAAwB,0BAA2B,EAAA;AAEzD,EAAA,MAAMC,oBACJ,GAAA,OAAA,CAAQ,kBACP,IAAA,MAAMC,gDAA6B,QAAU,EAAA;AAAA,IAC5C;AAAA,GACD,CAAA;AAEH,EAAM,MAAA,mBAAA,GAAsB,MAAMC,8CAAA,CAA2B,MAAO,CAAA;AAAA,IAClE,SAAA;AAAA,IACA,YAAYF,oBAAmB,CAAA,iBAAA;AAAA,IAC/B,qBAAA;AAAA,IACA,oBAAsB,EAAA;AAAA,MACpB,MAAA;AAAA,MACA,SAAA;AAAA,MACA,MAAA;AAAA,MACA,IAAA;AAAA,MACA;AAAA;AACF,GACD,CAAA;AAED,EAAA,MAAM,oBAAoB,QAAS,EAAA;AAEnC,EAAA,IAAI,kBAAoB,EAAA;AACtB,IAAA,MAAM,cAAc,kBAAmB,CAAA,SAAA;AAAA,MACrCA,oBAAmB,CAAA;AAAA,KACrB;AACA,IAAO,OAAA;AAAA,0BACLA,oBAAA;AAAA,MACA,WAAA;AAAA,MACA;AAAA,KACF;AAAA;AAGF,EAAO,OAAA;AAAA,wBACLA,oBAAA;AAAA,IACA;AAAA,GACF;AACF;;;;"}