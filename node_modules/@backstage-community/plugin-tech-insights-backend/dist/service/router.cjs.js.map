{"version":3,"file":"router.cjs.js","sources":["../../src/service/router.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport express, { Request } from 'express';\nimport Router from 'express-promise-router';\nimport { Config } from '@backstage/config';\nimport {\n  FactChecker,\n  PersistenceContext,\n} from '@backstage-community/plugin-tech-insights-node';\n\nimport {\n  CheckResult,\n  Check,\n  techInsightsCheckReadPermission,\n  techInsightsCheckUpdatePermission,\n  techInsightsFactRetrieverReadPermission,\n} from '@backstage-community/plugin-tech-insights-common';\nimport { DateTime } from 'luxon';\nimport {\n  CompoundEntityRef,\n  parseEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { serializeError } from '@backstage/errors';\nimport {\n  LoggerService,\n  PermissionsService,\n  HttpAuthService,\n} from '@backstage/backend-plugin-api';\nimport { MiddlewareFactory } from '@backstage/backend-defaults/rootHttpRouter';\nimport {\n  AuthorizeResult,\n  BasicPermission,\n} from '@backstage/plugin-permission-common';\nimport { NotAllowedError } from '@backstage/errors';\nimport pLimit from 'p-limit';\n\n/**\n * @public\n *\n * RouterOptions to construct TechInsights endpoints\n * @typeParam CheckType - Type of the check for the fact checker this builder returns\n * @typeParam CheckResultType - Type of the check result for the fact checker this builder returns\n */\nexport interface RouterOptions<\n  CheckType extends Check,\n  CheckResultType extends CheckResult,\n> {\n  /**\n   * Optional FactChecker implementation. If omitted, endpoints are not constructed\n   */\n  factChecker?: FactChecker<CheckType, CheckResultType>;\n\n  /**\n   * TechInsights PersistenceContext. Should contain an implementation of TechInsightsStore\n   */\n  persistenceContext: PersistenceContext;\n\n  /**\n   * Backstage config object\n   */\n  config: Config;\n\n  /**\n   * Implementation of Winston logger\n   */\n  logger: LoggerService;\n\n  /**\n   * Implementation of PermissionsService\n   */\n  permissions: PermissionsService;\n\n  /**\n   * Implementation of HttpAuthService\n   */\n  httpAuth: HttpAuthService;\n}\n\n/**\n * @public\n *\n * Constructs a tech-insights router.\n *\n * Exposes endpoints to handle facts\n * Exposes optional endpoints to handle checks if a FactChecker implementation is passed in\n *\n * @param options - RouterOptions object\n */\nexport async function createRouter<\n  CheckType extends Check,\n  CheckResultType extends CheckResult,\n>(options: RouterOptions<CheckType, CheckResultType>): Promise<express.Router> {\n  const router = Router();\n\n  router.use(express.json());\n\n  const {\n    persistenceContext,\n    factChecker,\n    logger,\n    config,\n    permissions,\n    httpAuth,\n  } = options;\n  const { techInsightsStore } = persistenceContext;\n\n  const factory = MiddlewareFactory.create({ logger, config });\n\n  const authorize = async (request: Request, permission: BasicPermission) => {\n    const decision = (\n      await permissions.authorize([{ permission: permission }], {\n        credentials: await httpAuth.credentials(request),\n      })\n    )[0];\n\n    return decision;\n  };\n\n  if (factChecker) {\n    logger.info('Fact checker configured. Enabling fact checking endpoints.');\n    router.get('/checks', async (req, res) => {\n      const decision = await authorize(req, techInsightsCheckReadPermission);\n\n      if (decision.result === AuthorizeResult.DENY) {\n        throw new NotAllowedError('Unauthorized');\n      }\n      return res.json(await factChecker.getChecks());\n    });\n\n    router.post('/checks/run/:namespace/:kind/:name', async (req, res) => {\n      const decision = await authorize(req, techInsightsCheckUpdatePermission);\n\n      if (decision.result === AuthorizeResult.DENY) {\n        throw new NotAllowedError('Unauthorized');\n      }\n\n      const { namespace, kind, name } = req.params;\n      const { checks }: { checks: string[] } = req.body;\n      const entityTriplet = stringifyEntityRef({ namespace, kind, name });\n      const checkResult = await factChecker.runChecks(entityTriplet, checks);\n      return res.json(checkResult);\n    });\n\n    const checksRunConcurrency =\n      config.getOptionalNumber('techInsights.checksRunConcurrency') || 100;\n    router.post('/checks/run', async (req, res) => {\n      const decision = await authorize(req, techInsightsCheckUpdatePermission);\n\n      if (decision.result === AuthorizeResult.DENY) {\n        throw new NotAllowedError('Unauthorized');\n      }\n      const checks: string[] = req.body.checks;\n      let entities: CompoundEntityRef[] = req.body.entities;\n      if (entities.length === 0) {\n        entities = await techInsightsStore.getEntities();\n      }\n      const limit = pLimit(checksRunConcurrency);\n      const tasks = entities.map(async entity =>\n        limit(async () => {\n          const entityTriplet =\n            typeof entity === 'string' ? entity : stringifyEntityRef(entity);\n          try {\n            const results = await factChecker.runChecks(entityTriplet, checks);\n            return {\n              entity: entityTriplet,\n              results,\n            };\n          } catch (e: any) {\n            const error = serializeError(e);\n            logger.error(`${error.name}: ${error.message}`);\n            return {\n              entity: entityTriplet,\n              error: error,\n              results: [],\n            };\n          }\n        }),\n      );\n      const results = await Promise.all(tasks);\n      return res.json(results);\n    });\n  } else {\n    logger.info(\n      'Starting tech insights module without fact checking endpoints.',\n    );\n  }\n\n  router.get('/fact-schemas', async (req, res) => {\n    const decision = await authorize(\n      req,\n      techInsightsFactRetrieverReadPermission,\n    );\n\n    if (decision.result === AuthorizeResult.DENY) {\n      throw new NotAllowedError('Unauthorized');\n    }\n\n    const ids = req.query.ids as string[];\n    return res.json(await techInsightsStore.getLatestSchemas(ids));\n  });\n\n  /**\n   * /facts/latest?entity=component:default/mycomponent&ids[]=factRetrieverId1&ids[]=factRetrieverId2\n   */\n  router.get('/facts/latest', async (req, res) => {\n    const decision = await authorize(\n      req,\n      techInsightsFactRetrieverReadPermission,\n    );\n\n    if (decision.result === AuthorizeResult.DENY) {\n      throw new NotAllowedError('Unauthorized');\n    }\n    const { entity } = req.query;\n    const { namespace, kind, name } = parseEntityRef(entity as string);\n\n    if (!req.query.ids) {\n      return res\n        .status(422)\n        .json({ error: 'Failed to parse ids from request' });\n    }\n    const ids = [req.query.ids].flat() as string[];\n    return res.json(\n      await techInsightsStore.getLatestFactsByIds(\n        ids,\n        stringifyEntityRef({ namespace, kind, name }),\n      ),\n    );\n  });\n\n  /**\n   * /facts/range?entity=component:default/mycomponent&startDateTime=2021-12-24T01:23:45&endDateTime=2021-12-31T23:59:59&ids[]=factRetrieverId1&ids[]=factRetrieverId2\n   */\n  router.get('/facts/range', async (req, res) => {\n    const decision = await authorize(\n      req,\n      techInsightsFactRetrieverReadPermission,\n    );\n\n    if (decision.result === AuthorizeResult.DENY) {\n      throw new NotAllowedError('Unauthorized');\n    }\n\n    const { entity } = req.query;\n    const { namespace, kind, name } = parseEntityRef(entity as string);\n\n    if (!req.query.ids) {\n      return res\n        .status(422)\n        .json({ error: 'Failed to parse ids from request' });\n    }\n    const ids = [req.query.ids].flat() as string[];\n    const startDatetime = DateTime.fromISO(req.query.startDatetime as string);\n    const endDatetime = DateTime.fromISO(req.query.endDatetime as string);\n    if (!startDatetime.isValid || !endDatetime.isValid) {\n      return res.status(422).json({\n        message: 'Failed to parse datetime from request',\n        field: !startDatetime.isValid ? 'startDateTime' : 'endDateTime',\n        value: !startDatetime.isValid ? startDatetime : endDatetime,\n      });\n    }\n    const entityTriplet = stringifyEntityRef({ namespace, kind, name });\n    return res.json(\n      await techInsightsStore.getFactsBetweenTimestampsByIds(\n        ids,\n        entityTriplet,\n        startDatetime,\n        endDatetime,\n      ),\n    );\n  });\n\n  router.use(factory.error());\n  return router;\n}\n"],"names":["Router","express","MiddlewareFactory","techInsightsCheckReadPermission","AuthorizeResult","NotAllowedError","techInsightsCheckUpdatePermission","stringifyEntityRef","pLimit","results","serializeError","techInsightsFactRetrieverReadPermission","parseEntityRef","DateTime"],"mappings":"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"}