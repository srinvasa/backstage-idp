{"version":3,"file":"persistenceContext.cjs.js","sources":["../../../src/service/persistence/persistenceContext.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { TechInsightsDatabase } from './TechInsightsDatabase';\nimport { PersistenceContext } from '@backstage-community/plugin-tech-insights-node';\nimport {\n  DatabaseService,\n  LoggerService,\n  resolvePackagePath,\n} from '@backstage/backend-plugin-api';\n\nconst migrationsDir = resolvePackagePath(\n  '@backstage-community/plugin-tech-insights-backend',\n  'migrations',\n);\n\n/**\n * A Container for persistence context initialization options\n *\n * @public\n */\nexport type PersistenceContextOptions = {\n  logger: LoggerService;\n};\n\n/**\n * A factory function to construct persistence context for running implementation.\n *\n * @public\n */\nexport const initializePersistenceContext = async (\n  database: DatabaseService,\n  options: PersistenceContextOptions,\n): Promise<PersistenceContext> => {\n  const client = await database.getClient();\n\n  if (!database.migrations?.skip) {\n    await client.migrate.latest({\n      directory: migrationsDir,\n    });\n  }\n\n  return {\n    techInsightsStore: new TechInsightsDatabase(client, options.logger),\n  };\n};\n"],"names":["resolvePackagePath","TechInsightsDatabase"],"mappings":";;;;;AAuBA,MAAM,aAAgB,GAAAA,mCAAA;AAAA,EACpB,mDAAA;AAAA,EACA;AACF,CAAA;AAgBa,MAAA,4BAAA,GAA+B,OAC1C,QAAA,EACA,OACgC,KAAA;AAChC,EAAM,MAAA,MAAA,GAAS,MAAM,QAAA,CAAS,SAAU,EAAA;AAExC,EAAI,IAAA,CAAC,QAAS,CAAA,UAAA,EAAY,IAAM,EAAA;AAC9B,IAAM,MAAA,MAAA,CAAO,QAAQ,MAAO,CAAA;AAAA,MAC1B,SAAW,EAAA;AAAA,KACZ,CAAA;AAAA;AAGH,EAAO,OAAA;AAAA,IACL,iBAAmB,EAAA,IAAIC,yCAAqB,CAAA,MAAA,EAAQ,QAAQ,MAAM;AAAA,GACpE;AACF;;;;"}