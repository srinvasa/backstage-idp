{"version":3,"file":"TechInsightsDatabase.cjs.js","sources":["../../../src/service/persistence/TechInsightsDatabase.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Knex } from 'knex';\nimport {\n  FactLifecycle,\n  FactSchemaDefinition,\n  FlatTechInsightFact,\n  TechInsightFact,\n  TechInsightsStore,\n} from '@backstage-community/plugin-tech-insights-node';\nimport { FactSchema } from '@backstage-community/plugin-tech-insights-common';\nimport { rsort } from 'semver';\nimport { groupBy, omit } from 'lodash';\nimport { DateTime } from 'luxon';\nimport {\n  CompoundEntityRef,\n  parseEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { isMaxItems, isTtl } from '../fact/factRetrievers/utils';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\ntype Transaction = Knex.Transaction;\n\nexport type RawDbFactRow = {\n  id: string;\n  version: string;\n  timestamp: Date | string;\n  entity: string;\n  facts: string;\n};\n\ntype RawDbFactSchemaRow = {\n  id: string;\n  version: string;\n  schema: string;\n  entityFilter?: string;\n};\n\n/**\n * Default TechInsightsDatabase implementation.\n *\n * @internal\n */\nexport class TechInsightsDatabase implements TechInsightsStore {\n  private readonly CHUNK_SIZE = 50;\n\n  constructor(\n    private readonly db: Knex,\n    private readonly logger: LoggerService,\n  ) {}\n\n  async getLatestSchemas(ids?: string[]): Promise<FactSchema[]> {\n    const queryBuilder = this.db<RawDbFactSchemaRow>('fact_schemas');\n    if (ids) {\n      queryBuilder.whereIn('id', ids);\n    }\n    const existingSchemas = await queryBuilder.orderBy('id', 'desc').select();\n\n    const groupedSchemas = groupBy(existingSchemas, 'id');\n    return Object.values(groupedSchemas)\n      .map(schemas => {\n        const sorted = rsort(schemas.map(it => it.version));\n        return schemas.find(it => it.version === sorted[0])!;\n      })\n      .map((it: RawDbFactSchemaRow) => ({\n        ...omit(it, 'schema'),\n        ...JSON.parse(it.schema),\n        entityFilter: it.entityFilter ? JSON.parse(it.entityFilter) : null,\n      }));\n  }\n\n  async insertFactSchema(schemaDefinition: FactSchemaDefinition) {\n    const { id, version, schema, entityFilter } = schemaDefinition;\n    const existingSchemas = await this.db<RawDbFactSchemaRow>('fact_schemas')\n      .where({ id })\n      .and.where({ version })\n      .select();\n\n    if (!existingSchemas || existingSchemas.length === 0) {\n      await this.db<RawDbFactSchemaRow>('fact_schemas').insert({\n        id,\n        version,\n        entityFilter: entityFilter ? JSON.stringify(entityFilter) : undefined,\n        schema: JSON.stringify(schema),\n      });\n    }\n  }\n\n  async insertFacts({\n    id,\n    facts,\n    lifecycle,\n  }: {\n    id: string;\n    facts: TechInsightFact[];\n    lifecycle?: FactLifecycle;\n  }): Promise<void> {\n    if (facts.length === 0) return;\n    const currentSchema = await this.getLatestSchema(id);\n    const factRows = facts.map(it => {\n      const ts = it.timestamp?.toISO();\n      return {\n        id,\n        version: currentSchema.version,\n        entity: stringifyEntityRef(it.entity),\n        facts: JSON.stringify(it.facts),\n        ...(ts && { timestamp: ts }),\n      };\n    });\n\n    await this.db.transaction(async tx => {\n      await tx.batchInsert<RawDbFactRow>('facts', factRows, this.CHUNK_SIZE);\n\n      if (lifecycle && isTtl(lifecycle)) {\n        const expiration = DateTime.now().minus(lifecycle.timeToLive);\n        await this.deleteExpiredFactsByDate(tx, id, expiration);\n      }\n      if (lifecycle && isMaxItems(lifecycle)) {\n        await this.deleteExpiredFactsByNumber(tx, id, lifecycle.maxItems);\n      }\n    });\n  }\n\n  async getLatestFactsByIds(\n    ids: string[],\n    entityTriplet: string,\n  ): Promise<{ [factId: string]: FlatTechInsightFact }> {\n    const results = await this.db<RawDbFactRow>('facts')\n      .where({ entity: entityTriplet })\n      .and.whereIn('id', ids)\n      .join(\n        this.db('facts')\n          .max('timestamp as maxTimestamp')\n          .column('id as subId')\n          .where({ entity: entityTriplet })\n          .and.whereIn('id', ids)\n          .groupBy('id')\n          .as('subQ'),\n        {\n          'facts.id': 'subQ.subId',\n          'facts.timestamp': 'subQ.maxTimestamp',\n        },\n      );\n    return this.dbFactRowsToTechInsightFacts(results);\n  }\n\n  async getEntities(): Promise<CompoundEntityRef[]> {\n    const results = await this.db<RawDbFactRow>('facts').distinct('entity');\n    return results.map(row => parseEntityRef(row.entity));\n  }\n\n  async getFactsBetweenTimestampsByIds(\n    ids: string[],\n    entityTriplet: string,\n    startDateTime: DateTime,\n    endDateTime: DateTime,\n  ): Promise<{\n    [factId: string]: FlatTechInsightFact[];\n  }> {\n    const results = await this.db<RawDbFactRow>('facts')\n      .where({ entity: entityTriplet })\n      .and.whereIn('id', ids)\n      .and.whereBetween('timestamp', [\n        startDateTime.toISO(),\n        endDateTime.toISO(),\n      ]);\n\n    return groupBy(\n      results.map(it => {\n        const { namespace, kind, name } = parseEntityRef(it.entity);\n        const timestamp =\n          typeof it.timestamp === 'string'\n            ? DateTime.fromISO(it.timestamp)\n            : DateTime.fromJSDate(it.timestamp);\n        return {\n          id: it.id,\n          entity: { namespace, kind, name },\n          timestamp,\n          version: it.version,\n          facts: JSON.parse(it.facts),\n        };\n      }),\n      'id',\n    );\n  }\n\n  private async getLatestSchema(id: string): Promise<RawDbFactSchemaRow> {\n    const existingSchemas = await this.db<RawDbFactSchemaRow>('fact_schemas')\n      .where({ id })\n      .orderBy('id', 'desc')\n      .select();\n    if (existingSchemas.length < 1) {\n      this.logger.warn(`No schema found for ${id}. `);\n      throw new Error(`No schema found for ${id}. `);\n    }\n    const sorted = rsort(existingSchemas.map(it => it.version));\n    return existingSchemas.find(it => it.version === sorted[0])!;\n  }\n\n  private async deleteExpiredFactsByDate(\n    tx: Transaction,\n    factRetrieverId: string,\n    timestamp: DateTime,\n  ) {\n    await tx<RawDbFactRow>('facts')\n      .where({ id: factRetrieverId })\n      .and.where('timestamp', '<', timestamp.toISO())\n      .delete();\n  }\n\n  private async deleteExpiredFactsByNumber(\n    tx: Transaction,\n    factRetrieverId: string,\n    maxItems: number,\n  ) {\n    const deletionFilterQuery = (subTx: Knex.QueryBuilder<any, unknown[]>) =>\n      subTx\n        .select(['id', 'entity', 'timestamp'])\n        .from('facts')\n        .where({ id: factRetrieverId })\n        .and.whereIn('entity', db =>\n          db.distinct('entity').where({ id: factRetrieverId }),\n        )\n        .and.leftJoin(\n          joinTable =>\n            joinTable\n              .select('*')\n              .from(\n                this.db('facts')\n                  .column(\n                    { fid: 'id' },\n                    { fentity: 'entity' },\n                    { ftimestamp: 'timestamp' },\n                  )\n                  .column(\n                    this.db.raw(\n                      'row_number() over (partition by id, entity order by timestamp desc) as fact_rank',\n                    ),\n                  )\n                  .as('ranks'),\n              )\n              .where('fact_rank', '<=', maxItems)\n              .as('filterjoin'),\n          joinClause => {\n            joinClause\n              .on('filterjoin.fid', 'facts.id')\n              .on('filterjoin.fentity', 'facts.entity')\n              .on('filterjoin.ftimestamp', 'facts.timestamp');\n          },\n        )\n        .whereNull('filterjoin.fid');\n    await tx('facts')\n      .whereIn(['id', 'entity', 'timestamp'], database =>\n        deletionFilterQuery(database),\n      )\n      .delete();\n  }\n\n  private dbFactRowsToTechInsightFacts(rows: RawDbFactRow[]) {\n    return rows.reduce((acc, it) => {\n      const { namespace, kind, name } = parseEntityRef(it.entity);\n      const timestamp =\n        typeof it.timestamp === 'string'\n          ? DateTime.fromISO(it.timestamp)\n          : DateTime.fromJSDate(it.timestamp);\n      return {\n        ...acc,\n        [it.id]: {\n          id: it.id,\n          entity: { namespace, kind, name },\n          timestamp,\n          version: it.version,\n          facts: JSON.parse(it.facts),\n        },\n      };\n    }, {});\n  }\n}\n"],"names":["groupBy","rsort","omit","stringifyEntityRef","isTtl","DateTime","isMaxItems","parseEntityRef"],"mappings":"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"}