{"version":3,"file":"techdocsFactRetriever.cjs.js","sources":["../../../../src/service/fact/factRetrievers/techdocsFactRetriever.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  FactRetriever,\n  FactRetrieverContext,\n} from '@backstage-community/plugin-tech-insights-node';\nimport { CatalogClient } from '@backstage/catalog-client';\nimport { Entity } from '@backstage/catalog-model';\nimport { entityHasAnnotation, generateAnnotationFactName } from './utils';\nimport { DateTime } from 'luxon';\n\nconst techdocsAnnotation = 'backstage.io/techdocs-ref';\nconst techdocsEntityAnnotation = 'backstage.io/techdocs-entity';\nconst techdocsAnnotationFactName =\n  generateAnnotationFactName(techdocsAnnotation);\nconst techdocsEntityAnnotationFactName = generateAnnotationFactName(\n  techdocsEntityAnnotation,\n);\n\n/**\n * Generates facts related to the completeness of techdocs configuration for entities.\n *\n * @public\n */\nexport const techdocsFactRetriever: FactRetriever = {\n  id: 'techdocsFactRetriever',\n  version: '0.1.0',\n  title: 'Tech Docs',\n  description:\n    'Generates facts related to the completeness of techdocs configuration for entities',\n  schema: {\n    [techdocsAnnotationFactName]: {\n      type: 'boolean',\n      description: 'The entity has a TechDocs reference annotation',\n    },\n    [techdocsEntityAnnotationFactName]: {\n      type: 'boolean',\n      description: 'The entity has a TechDocs entity annotation',\n    },\n  },\n  handler: async ({ discovery, entityFilter, auth }: FactRetrieverContext) => {\n    const { token } = await auth.getPluginRequestToken({\n      onBehalfOf: await auth.getOwnServiceCredentials(),\n      targetPluginId: 'catalog',\n    });\n    const catalogClient = new CatalogClient({\n      discoveryApi: discovery,\n    });\n    const entities = await catalogClient.getEntities(\n      { filter: entityFilter },\n      { token },\n    );\n\n    return entities.items.map((entity: Entity) => {\n      return {\n        entity: {\n          namespace: entity.metadata.namespace!,\n          kind: entity.kind,\n          name: entity.metadata.name,\n        },\n        facts: {\n          [techdocsAnnotationFactName]: entityHasAnnotation(\n            entity,\n            techdocsAnnotation,\n          ),\n          [techdocsEntityAnnotationFactName]: entityHasAnnotation(\n            entity,\n            techdocsEntityAnnotation,\n          ),\n        },\n        timestamp: DateTime.now(),\n      };\n    });\n  },\n};\n"],"names":["generateAnnotationFactName","catalogClient","CatalogClient","entityHasAnnotation","DateTime"],"mappings":";;;;;;AAyBA,MAAM,kBAAqB,GAAA,2BAAA;AAC3B,MAAM,wBAA2B,GAAA,8BAAA;AACjC,MAAM,0BAAA,GACJA,iCAA2B,kBAAkB,CAAA;AAC/C,MAAM,gCAAmC,GAAAA,gCAAA;AAAA,EACvC;AACF,CAAA;AAOO,MAAM,qBAAuC,GAAA;AAAA,EAClD,EAAI,EAAA,uBAAA;AAAA,EACJ,OAAS,EAAA,OAAA;AAAA,EACT,KAAO,EAAA,WAAA;AAAA,EACP,WACE,EAAA,oFAAA;AAAA,EACF,MAAQ,EAAA;AAAA,IACN,CAAC,0BAA0B,GAAG;AAAA,MAC5B,IAAM,EAAA,SAAA;AAAA,MACN,WAAa,EAAA;AAAA,KACf;AAAA,IACA,CAAC,gCAAgC,GAAG;AAAA,MAClC,IAAM,EAAA,SAAA;AAAA,MACN,WAAa,EAAA;AAAA;AACf,GACF;AAAA,EACA,SAAS,OAAO,EAAE,SAAW,EAAA,YAAA,EAAc,MAAiC,KAAA;AAC1E,IAAA,MAAM,EAAE,KAAA,EAAU,GAAA,MAAM,KAAK,qBAAsB,CAAA;AAAA,MACjD,UAAA,EAAY,MAAM,IAAA,CAAK,wBAAyB,EAAA;AAAA,MAChD,cAAgB,EAAA;AAAA,KACjB,CAAA;AACD,IAAM,MAAAC,eAAA,GAAgB,IAAIC,2BAAc,CAAA;AAAA,MACtC,YAAc,EAAA;AAAA,KACf,CAAA;AACD,IAAM,MAAA,QAAA,GAAW,MAAMD,eAAc,CAAA,WAAA;AAAA,MACnC,EAAE,QAAQ,YAAa,EAAA;AAAA,MACvB,EAAE,KAAM;AAAA,KACV;AAEA,IAAA,OAAO,QAAS,CAAA,KAAA,CAAM,GAAI,CAAA,CAAC,MAAmB,KAAA;AAC5C,MAAO,OAAA;AAAA,QACL,MAAQ,EAAA;AAAA,UACN,SAAA,EAAW,OAAO,QAAS,CAAA,SAAA;AAAA,UAC3B,MAAM,MAAO,CAAA,IAAA;AAAA,UACb,IAAA,EAAM,OAAO,QAAS,CAAA;AAAA,SACxB;AAAA,QACA,KAAO,EAAA;AAAA,UACL,CAAC,0BAA0B,GAAGE,yBAAA;AAAA,YAC5B,MAAA;AAAA,YACA;AAAA,WACF;AAAA,UACA,CAAC,gCAAgC,GAAGA,yBAAA;AAAA,YAClC,MAAA;AAAA,YACA;AAAA;AACF,SACF;AAAA,QACA,SAAA,EAAWC,eAAS,GAAI;AAAA,OAC1B;AAAA,KACD,CAAA;AAAA;AAEL;;;;"}