{"version":3,"file":"entityOwnershipFactRetriever.cjs.js","sources":["../../../../src/service/fact/factRetrievers/entityOwnershipFactRetriever.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  FactRetriever,\n  FactRetrieverContext,\n} from '@backstage-community/plugin-tech-insights-node';\nimport { CatalogClient } from '@backstage/catalog-client';\nimport { Entity } from '@backstage/catalog-model';\nimport { DateTime } from 'luxon';\n\n/**\n * Generates facts which indicate the quality of data in the spec.owner field.\n *\n * @public\n */\nexport const entityOwnershipFactRetriever: FactRetriever = {\n  id: 'entityOwnershipFactRetriever',\n  version: '0.0.1',\n  title: 'Entity Ownership',\n  description:\n    'Generates facts which indicate the quality of data in the spec.owner field',\n  entityFilter: [\n    { kind: ['component', 'domain', 'system', 'api', 'resource', 'template'] },\n  ],\n  schema: {\n    hasOwner: {\n      type: 'boolean',\n      description: 'The spec.owner field is set',\n    },\n    hasGroupOwner: {\n      type: 'boolean',\n      description: 'The spec.owner field is set and refers to a group',\n    },\n  },\n  handler: async ({ discovery, entityFilter, auth }: FactRetrieverContext) => {\n    const { token } = await auth.getPluginRequestToken({\n      onBehalfOf: await auth.getOwnServiceCredentials(),\n      targetPluginId: 'catalog',\n    });\n    const catalogClient = new CatalogClient({\n      discoveryApi: discovery,\n    });\n    const entities = await catalogClient.getEntities(\n      { filter: entityFilter },\n      { token },\n    );\n\n    return entities.items.map((entity: Entity) => {\n      return {\n        entity: {\n          namespace: entity.metadata.namespace!,\n          kind: entity.kind,\n          name: entity.metadata.name,\n        },\n        facts: {\n          hasOwner: Boolean(entity.spec?.owner),\n          hasGroupOwner: Boolean(\n            entity.spec?.owner &&\n              !(entity.spec?.owner as string).startsWith('user:'),\n          ),\n        },\n        timestamp: DateTime.now(),\n      };\n    });\n  },\n};\n"],"names":["catalogClient","CatalogClient","DateTime"],"mappings":";;;;;AA6BO,MAAM,4BAA8C,GAAA;AAAA,EACzD,EAAI,EAAA,8BAAA;AAAA,EACJ,OAAS,EAAA,OAAA;AAAA,EACT,KAAO,EAAA,kBAAA;AAAA,EACP,WACE,EAAA,4EAAA;AAAA,EACF,YAAc,EAAA;AAAA,IACZ,EAAE,MAAM,CAAC,WAAA,EAAa,UAAU,QAAU,EAAA,KAAA,EAAO,UAAY,EAAA,UAAU,CAAE;AAAA,GAC3E;AAAA,EACA,MAAQ,EAAA;AAAA,IACN,QAAU,EAAA;AAAA,MACR,IAAM,EAAA,SAAA;AAAA,MACN,WAAa,EAAA;AAAA,KACf;AAAA,IACA,aAAe,EAAA;AAAA,MACb,IAAM,EAAA,SAAA;AAAA,MACN,WAAa,EAAA;AAAA;AACf,GACF;AAAA,EACA,SAAS,OAAO,EAAE,SAAW,EAAA,YAAA,EAAc,MAAiC,KAAA;AAC1E,IAAA,MAAM,EAAE,KAAA,EAAU,GAAA,MAAM,KAAK,qBAAsB,CAAA;AAAA,MACjD,UAAA,EAAY,MAAM,IAAA,CAAK,wBAAyB,EAAA;AAAA,MAChD,cAAgB,EAAA;AAAA,KACjB,CAAA;AACD,IAAM,MAAAA,eAAA,GAAgB,IAAIC,2BAAc,CAAA;AAAA,MACtC,YAAc,EAAA;AAAA,KACf,CAAA;AACD,IAAM,MAAA,QAAA,GAAW,MAAMD,eAAc,CAAA,WAAA;AAAA,MACnC,EAAE,QAAQ,YAAa,EAAA;AAAA,MACvB,EAAE,KAAM;AAAA,KACV;AAEA,IAAA,OAAO,QAAS,CAAA,KAAA,CAAM,GAAI,CAAA,CAAC,MAAmB,KAAA;AAC5C,MAAO,OAAA;AAAA,QACL,MAAQ,EAAA;AAAA,UACN,SAAA,EAAW,OAAO,QAAS,CAAA,SAAA;AAAA,UAC3B,MAAM,MAAO,CAAA,IAAA;AAAA,UACb,IAAA,EAAM,OAAO,QAAS,CAAA;AAAA,SACxB;AAAA,QACA,KAAO,EAAA;AAAA,UACL,QAAU,EAAA,OAAA,CAAQ,MAAO,CAAA,IAAA,EAAM,KAAK,CAAA;AAAA,UACpC,aAAe,EAAA,OAAA;AAAA,YACb,MAAA,CAAO,MAAM,KACX,IAAA,CAAA,CAAE,OAAO,IAAM,EAAA,KAAA,EAAiB,WAAW,OAAO;AAAA;AACtD,SACF;AAAA,QACA,SAAA,EAAWE,eAAS,GAAI;AAAA,OAC1B;AAAA,KACD,CAAA;AAAA;AAEL;;;;"}