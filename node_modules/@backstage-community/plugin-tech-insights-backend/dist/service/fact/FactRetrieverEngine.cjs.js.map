{"version":3,"file":"FactRetrieverEngine.cjs.js","sources":["../../../src/service/fact/FactRetrieverEngine.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  FactLifecycle,\n  FactRetriever,\n  FactRetrieverContext,\n  FactRetrieverRegistration,\n  FactRetrieverRegistry,\n  TechInsightFact,\n  TechInsightsStore,\n} from '@backstage-community/plugin-tech-insights-node';\nimport { Duration } from 'luxon';\nimport { LoggerService, SchedulerService } from '@backstage/backend-plugin-api';\n\nfunction randomDailyCron() {\n  const rand = (min: number, max: number) =>\n    Math.floor(Math.random() * (max - min + 1) + min);\n  return `${rand(0, 59)} ${rand(0, 23)} * * *`;\n}\n\nfunction duration(startTimestamp: [number, number]): string {\n  const delta = process.hrtime(startTimestamp);\n  const seconds = delta[0] + delta[1] / 1e9;\n  return `${seconds.toFixed(1)}s`;\n}\n\n/**\n * @public\n *\n * FactRetrieverEngine responsible scheduling and running fact retrieval tasks.\n */\nexport abstract class FactRetrieverEngine {\n  /**\n   * Schedules fact retriever run cycles based on configuration provided in the registration.\n   *\n   * Default implementation uses SchedulerService to handle scheduling. This function can be called multiple\n   * times, where initial calls schedule the tasks and subsequent invocations update the schedules.\n   */\n  abstract schedule(): Promise<void>;\n\n  /**\n   * Schedules single fact retriever run cycles based on configuration provided in the registration.\n   *\n   * Default implementation defers to scheduling all jobs\n   */\n  async scheduleJob(_: string): Promise<void> {\n    return await this.schedule();\n  }\n\n  /**\n   * Provides possibility to manually run a fact retriever job and construct fact data\n   *\n   * @param ref - Reference to the task name stored in the executor database. By convention this is the fact retriever id\n   */\n  abstract triggerJob(ref: string): Promise<void>;\n\n  /**\n   * Exposes fact retriever job configuration information about previous and next runs and schedule\n   *\n   * @param ref - Reference to the task name stored in the executor database. By convention this is the fact retriever id\n   */\n  abstract getJobRegistration(ref: string): Promise<FactRetrieverRegistration>;\n}\n\nexport class DefaultFactRetrieverEngine implements FactRetrieverEngine {\n  private constructor(\n    private readonly repository: TechInsightsStore,\n    private readonly factRetrieverRegistry: FactRetrieverRegistry,\n    private readonly factRetrieverContext: FactRetrieverContext,\n    private readonly logger: LoggerService,\n    private readonly scheduler: SchedulerService,\n    private readonly defaultCadence?: string,\n    private readonly defaultTimeout?: Duration,\n    private readonly defaultInitialDelay?: Duration,\n  ) {}\n\n  static async create(options: {\n    repository: TechInsightsStore;\n    factRetrieverRegistry: FactRetrieverRegistry;\n    factRetrieverContext: FactRetrieverContext;\n    scheduler: SchedulerService;\n    defaultCadence?: string;\n    defaultTimeout?: Duration;\n    defaultInitialDelay?: Duration;\n  }) {\n    const {\n      repository,\n      factRetrieverRegistry,\n      factRetrieverContext,\n      scheduler,\n      defaultCadence,\n      defaultTimeout,\n      defaultInitialDelay,\n    } = options;\n\n    const retrievers = await factRetrieverRegistry.listRetrievers();\n    await Promise.all(retrievers.map(it => repository.insertFactSchema(it)));\n\n    return new DefaultFactRetrieverEngine(\n      repository,\n      factRetrieverRegistry,\n      factRetrieverContext,\n      factRetrieverContext.logger,\n      scheduler,\n      defaultCadence,\n      defaultTimeout,\n      defaultInitialDelay,\n    );\n  }\n\n  private async scheduleRegistration(registration: FactRetrieverRegistration) {\n    const { factRetriever, cadence, lifecycle, timeout, initialDelay } =\n      registration;\n    const cronExpression = cadence || this.defaultCadence || randomDailyCron();\n    const timeLimit =\n      timeout || this.defaultTimeout || Duration.fromObject({ minutes: 5 });\n    const initialDelaySetting =\n      initialDelay ||\n      this.defaultInitialDelay ||\n      Duration.fromObject({ seconds: 5 });\n\n    await this.scheduler.scheduleTask({\n      id: factRetriever.id,\n      frequency: { cron: cronExpression },\n      fn: this.createFactRetrieverHandler(factRetriever, lifecycle),\n      timeout: timeLimit,\n      // We add a delay in order to prevent errors due to the\n      // fact that the backend is not yet online in a cold-start scenario\n      initialDelay: initialDelaySetting,\n    });\n  }\n\n  async scheduleJob(ref: string): Promise<void> {\n    const registration = await this.factRetrieverRegistry.get(ref);\n    return this.scheduleRegistration(registration);\n  }\n\n  async schedule() {\n    const registrations = await this.factRetrieverRegistry.listRegistrations();\n    const newRegs: string[] = [];\n\n    await Promise.all(\n      registrations.map(async registration => {\n        try {\n          await this.scheduleRegistration(registration);\n          newRegs.push(registration.factRetriever.id);\n        } catch (e) {\n          this.logger.warn(\n            `Failed to schedule fact retriever ${registration.factRetriever.id}, ${e}`,\n          );\n        }\n      }),\n    );\n\n    this.logger.info(\n      `Scheduled ${newRegs.length}/${registrations.length} fact retrievers into the tech-insights engine`,\n    );\n  }\n\n  getJobRegistration(ref: string): Promise<FactRetrieverRegistration> {\n    return this.factRetrieverRegistry.get(ref);\n  }\n\n  async triggerJob(ref: string): Promise<void> {\n    await this.scheduler.triggerTask(ref);\n  }\n\n  private createFactRetrieverHandler(\n    factRetriever: FactRetriever,\n    lifecycle?: FactLifecycle,\n  ) {\n    return async () => {\n      const startTimestamp = process.hrtime();\n      this.logger.info(\n        `Retrieving facts for fact retriever ${factRetriever.id}`,\n      );\n\n      let facts: TechInsightFact[] = [];\n      try {\n        facts = await factRetriever.handler({\n          ...this.factRetrieverContext,\n          logger: this.logger.child({ factRetrieverId: factRetriever.id }),\n          entityFilter: factRetriever.entityFilter,\n        });\n        this.logger.debug(\n          `Retrieved ${facts.length} facts for fact retriever ${\n            factRetriever.id\n          } in ${duration(startTimestamp)}`,\n        );\n      } catch (e) {\n        this.logger.error(\n          `Failed to retrieve facts for retriever ${factRetriever.id}`,\n          e,\n        );\n      }\n\n      try {\n        await this.repository.insertFacts({\n          id: factRetriever.id,\n          facts,\n          lifecycle,\n        });\n        this.logger.info(\n          `Stored ${facts.length} facts for fact retriever ${\n            factRetriever.id\n          } in ${duration(startTimestamp)}`,\n        );\n      } catch (e) {\n        this.logger.warn(\n          `Failed to insert facts for fact retriever ${factRetriever.id}`,\n          e,\n        );\n      }\n    };\n  }\n}\n"],"names":["Duration"],"mappings":"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"}