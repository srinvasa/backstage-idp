{"version":3,"file":"SonarQubeClient.esm.js","sources":["../../src/api/SonarQubeClient.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fetch from 'cross-fetch';\nimport {\n  FindingSummary,\n  Metrics,\n  SonarQubeApi,\n} from '@backstage-community/plugin-sonarqube-react';\nimport { InstanceUrlWrapper, FindingsWrapper } from './types';\nimport { DiscoveryApi, IdentityApi } from '@backstage/core-plugin-api';\n\n/** @public */\nexport class SonarQubeClient implements SonarQubeApi {\n  discoveryApi: DiscoveryApi;\n  identityApi: IdentityApi;\n\n  constructor(options: {\n    discoveryApi: DiscoveryApi;\n    identityApi: IdentityApi;\n  }) {\n    this.discoveryApi = options.discoveryApi;\n    this.identityApi = options.identityApi;\n  }\n\n  private async callApi<T>(\n    path: string,\n    query: { [key in string]: any },\n  ): Promise<T | undefined> {\n    const { token: idToken } = await this.identityApi.getCredentials();\n\n    const apiUrl = `${await this.discoveryApi.getBaseUrl('sonarqube')}`;\n    const response = await fetch(\n      `${apiUrl}/${path}?${new URLSearchParams(query).toString()}`,\n      {\n        headers: {\n          'Content-Type': 'application/json',\n          ...(idToken && { Authorization: `Bearer ${idToken}` }),\n        },\n      },\n    );\n    if (response.status === 200) {\n      return (await response.json()) as T;\n    }\n    return undefined;\n  }\n\n  async getFindingSummary({\n    componentKey,\n    projectInstance,\n  }: {\n    componentKey?: string;\n    projectInstance?: string;\n  } = {}): Promise<FindingSummary | undefined> {\n    if (!componentKey) {\n      return undefined;\n    }\n\n    const instanceKey = projectInstance || '';\n\n    const metrics: Metrics = {\n      alert_status: undefined,\n      bugs: undefined,\n      reliability_rating: undefined,\n      vulnerabilities: undefined,\n      security_rating: undefined,\n      security_hotspots_reviewed: undefined,\n      security_review_rating: undefined,\n      code_smells: undefined,\n      sqale_rating: undefined,\n      coverage: undefined,\n      duplicated_lines_density: undefined,\n    };\n\n    const baseUrlWrapper = await this.callApi<InstanceUrlWrapper>(\n      'instanceUrl',\n      {\n        instanceKey,\n      },\n    );\n    let baseUrl = baseUrlWrapper?.instanceUrl;\n    if (!baseUrl) {\n      return undefined;\n    }\n    // ensure trailing slash for later on\n    if (!baseUrl.endsWith('/')) {\n      baseUrl += '/';\n    }\n\n    const findings = await this.callApi<FindingsWrapper>('findings', {\n      componentKey,\n      instanceKey,\n    });\n    if (!findings) {\n      return undefined;\n    }\n\n    findings.measures.forEach(m => {\n      metrics[m.metric] = m.value;\n    });\n\n    return {\n      lastAnalysis: findings.analysisDate,\n      metrics,\n      projectUrl: `${baseUrl}dashboard?id=${encodeURIComponent(componentKey)}`,\n      getIssuesUrl: identifier =>\n        `${baseUrl}project/issues?id=${encodeURIComponent(\n          componentKey,\n        )}&types=${identifier.toLocaleUpperCase('en-US')}&resolved=false`,\n      getComponentMeasuresUrl: identifier =>\n        `${baseUrl}component_measures?id=${encodeURIComponent(\n          componentKey,\n        )}&metric=${identifier.toLocaleLowerCase(\n          'en-US',\n        )}&resolved=false&view=list`,\n      getSecurityHotspotsUrl: () =>\n        `${baseUrl}${\n          baseUrl === 'https://sonarcloud.io/' ? 'project/' : ''\n        }security_hotspots?id=${encodeURIComponent(componentKey)}`,\n    };\n  }\n}\n"],"names":[],"mappings":"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"}