{"version":3,"file":"router.cjs.js","sources":["../../src/service/router.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { errorHandler } from '@backstage/backend-common';\nimport express from 'express';\nimport Router from 'express-promise-router';\nimport { SonarqubeInfoProvider } from './sonarqubeInfoProvider';\nimport { InputError } from '@backstage/errors';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n/**\n * Dependencies needed by the router\n * @public\n */\nexport interface RouterOptions {\n  /**\n   * Logger for logging purposes\n   */\n  logger: LoggerService;\n  /**\n   * Info provider to be able to get all necessary information for the APIs\n   */\n  sonarqubeInfoProvider: SonarqubeInfoProvider;\n}\n\n/**\n * @public\n *\n * Constructs a sonarqube router.\n *\n * Expose endpoint to get information on or for a sonarqube instance.\n *\n * @param options - Dependencies of the router\n */\nexport async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const { logger, sonarqubeInfoProvider } = options;\n\n  const router = Router();\n  router.use(express.json());\n  router.get('/findings', async (request, response) => {\n    const componentKey = request.query.componentKey as string;\n    const instanceKey = request.query.instanceKey as string;\n\n    if (!componentKey)\n      throw new InputError('ComponentKey must be provided as a single string.');\n\n    logger.info(\n      instanceKey\n        ? `Retrieving findings for component ${componentKey}  in sonarqube instance name ${instanceKey}`\n        : `Retrieving findings for component ${componentKey} in default sonarqube instance`,\n    );\n\n    response.json(\n      await sonarqubeInfoProvider.getFindings({\n        componentKey,\n        instanceName: instanceKey,\n      }),\n    );\n  });\n\n  router.get('/instanceUrl', (request, response) => {\n    const instanceKey = request.query.instanceKey as string;\n\n    logger.info(\n      instanceKey\n        ? `Retrieving sonarqube instance URL for key ${instanceKey}`\n        : `Retrieving default sonarqube instance URL as instanceKey is not provided`,\n    );\n    const { baseUrl, externalBaseUrl } = sonarqubeInfoProvider.getBaseUrl({\n      instanceName: instanceKey,\n    });\n    response.json({\n      instanceUrl: externalBaseUrl || baseUrl,\n    });\n  });\n\n  router.use(errorHandler());\n  return router;\n}\n"],"names":["Router","express","InputError","errorHandler"],"mappings":";;;;;;;;;;;;AA+CA,eAAsB,aACpB,OACyB,EAAA;AACzB,EAAM,MAAA,EAAE,MAAQ,EAAA,qBAAA,EAA0B,GAAA,OAAA,CAAA;AAE1C,EAAA,MAAM,SAASA,uBAAO,EAAA,CAAA;AACtB,EAAO,MAAA,CAAA,GAAA,CAAIC,wBAAQ,CAAA,IAAA,EAAM,CAAA,CAAA;AACzB,EAAA,MAAA,CAAO,GAAI,CAAA,WAAA,EAAa,OAAO,OAAA,EAAS,QAAa,KAAA;AACnD,IAAM,MAAA,YAAA,GAAe,QAAQ,KAAM,CAAA,YAAA,CAAA;AACnC,IAAM,MAAA,WAAA,GAAc,QAAQ,KAAM,CAAA,WAAA,CAAA;AAElC,IAAA,IAAI,CAAC,YAAA;AACH,MAAM,MAAA,IAAIC,kBAAW,mDAAmD,CAAA,CAAA;AAE1E,IAAO,MAAA,CAAA,IAAA;AAAA,MACL,cACI,CAAqC,kCAAA,EAAA,YAAY,gCAAgC,WAAW,CAAA,CAAA,GAC5F,qCAAqC,YAAY,CAAA,8BAAA,CAAA;AAAA,KACvD,CAAA;AAEA,IAAS,QAAA,CAAA,IAAA;AAAA,MACP,MAAM,sBAAsB,WAAY,CAAA;AAAA,QACtC,YAAA;AAAA,QACA,YAAc,EAAA,WAAA;AAAA,OACf,CAAA;AAAA,KACH,CAAA;AAAA,GACD,CAAA,CAAA;AAED,EAAA,MAAA,CAAO,GAAI,CAAA,cAAA,EAAgB,CAAC,OAAA,EAAS,QAAa,KAAA;AAChD,IAAM,MAAA,WAAA,GAAc,QAAQ,KAAM,CAAA,WAAA,CAAA;AAElC,IAAO,MAAA,CAAA,IAAA;AAAA,MACL,WAAA,GACI,CAA6C,0CAAA,EAAA,WAAW,CACxD,CAAA,GAAA,CAAA,wEAAA,CAAA;AAAA,KACN,CAAA;AACA,IAAA,MAAM,EAAE,OAAA,EAAS,eAAgB,EAAA,GAAI,sBAAsB,UAAW,CAAA;AAAA,MACpE,YAAc,EAAA,WAAA;AAAA,KACf,CAAA,CAAA;AACD,IAAA,QAAA,CAAS,IAAK,CAAA;AAAA,MACZ,aAAa,eAAmB,IAAA,OAAA;AAAA,KACjC,CAAA,CAAA;AAAA,GACF,CAAA,CAAA;AAED,EAAO,MAAA,CAAA,GAAA,CAAIC,4BAAc,CAAA,CAAA;AACzB,EAAO,OAAA,MAAA,CAAA;AACT;;;;"}