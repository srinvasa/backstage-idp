{"version":3,"file":"GithubPullRequestsClient.esm.js","sources":["../../src/api/GithubPullRequestsClient.ts"],"sourcesContent":["/*\n * Copyright 2025 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { GithubPullRequestsApi } from './GithubPullRequestsApi';\nimport { readGithubIntegrationConfigs } from '@backstage/integration';\nimport { Octokit } from '@octokit/rest';\nimport {\n  SearchPullRequestsResponseData,\n  GithubRepositoryData,\n  GithubFirstCommitDate,\n  GetSearchPullRequestsResponseType,\n  GithubSearchPullRequestsDataItem,\n} from '../types';\nimport { ConfigApi } from '@backstage/core-plugin-api';\nimport { ScmAuthApi } from '@backstage/integration-react';\nimport { DateTime } from 'luxon';\nimport { SecondaryRateLimitHandler } from './SecondaryRateLimitHandler';\n\nexport class GithubPullRequestsClient implements GithubPullRequestsApi {\n  private readonly configApi: ConfigApi;\n  private readonly scmAuthApi: ScmAuthApi;\n  private readonly rateLimitHandler = SecondaryRateLimitHandler.getInstance();\n\n  constructor(options: { configApi: ConfigApi; scmAuthApi: ScmAuthApi }) {\n    this.configApi = options.configApi;\n    this.scmAuthApi = options.scmAuthApi;\n  }\n\n  private async getOctokit(hostname: string = 'github.com'): Promise<Octokit> {\n    const { token } = await this.scmAuthApi.getCredentials({\n      url: `https://${hostname}/`,\n      additionalScope: {\n        customScopes: {\n          github: ['repo'],\n        },\n      },\n    });\n    const configs = readGithubIntegrationConfigs(\n      this.configApi.getOptionalConfigArray('integrations.github') ?? [],\n    );\n    const githubIntegrationConfig = configs.find(v => v.host === hostname);\n    const baseUrl = githubIntegrationConfig?.apiBaseUrl;\n    return new Octokit({ auth: token, baseUrl });\n  }\n\n  async listPullRequests({\n    search = '',\n    owner,\n    repo,\n    pageSize = 5,\n    page,\n    hostname,\n  }: {\n    search: string;\n    owner: string;\n    repo: string;\n    pageSize?: number;\n    page?: number;\n    hostname?: string;\n  }): Promise<{\n    pullRequestsData: SearchPullRequestsResponseData;\n  }> {\n    return this.rateLimitHandler.executeWithBackoff(async () => {\n      const octokit = await this.getOctokit(hostname);\n      const pullRequestResponse = await octokit.search.issuesAndPullRequests({\n        q: `${search} in:title type:pr repo:${owner}/${repo}`,\n        per_page: pageSize,\n        page,\n      });\n      return {\n        pullRequestsData:\n          pullRequestResponse.data as any as SearchPullRequestsResponseData,\n      };\n    });\n  }\n\n  async getRepositoryData({\n    hostname,\n    url,\n  }: {\n    hostname?: string;\n    url: string;\n  }): Promise<GithubRepositoryData> {\n    return this.rateLimitHandler.executeWithBackoff(async () => {\n      const octokit = await this.getOctokit(hostname);\n      const response = await octokit.request({ url: url });\n\n      return {\n        htmlUrl: response.data.html_url,\n        fullName: response.data.full_name,\n        additions: response.data.additions,\n        deletions: response.data.deletions,\n        changedFiles: response.data.changed_files,\n      };\n    });\n  }\n\n  async getCommitDetailsData({\n    hostname,\n    owner,\n    repo,\n    number,\n  }: {\n    hostname: string;\n    owner: string;\n    repo: string;\n    number: number;\n  }): Promise<GithubFirstCommitDate> {\n    return this.rateLimitHandler.executeWithBackoff(async () => {\n      const octokit = await this.getOctokit(hostname);\n      const { data: commits } = await octokit.pulls.listCommits({\n        owner: owner,\n        repo: repo,\n        pull_number: number,\n      });\n      if (commits.length === 0) {\n        return {\n          firstCommitDate: null,\n        };\n      }\n      const firstCommit = commits[0];\n      return {\n        firstCommitDate: new Date(firstCommit.commit.author!.date!),\n      };\n    });\n  }\n\n  async searchPullRequest({\n    query,\n    hostname,\n  }: {\n    query: string;\n    hostname?: string;\n  }): Promise<GithubSearchPullRequestsDataItem[]> {\n    return this.rateLimitHandler.executeWithBackoff(async () => {\n      const octokit = await this.getOctokit(hostname);\n      const pullRequestResponse: GetSearchPullRequestsResponseType =\n        await octokit.search.issuesAndPullRequests({\n          q: query,\n          per_page: 100,\n          page: 1,\n        });\n      return pullRequestResponse.data.items.map(pr => ({\n        id: pr.id,\n        state: pr.state,\n        draft: pr.draft ?? false,\n        merged: pr.pull_request?.merged_at ?? undefined,\n        repositoryUrl: pr.repository_url,\n        pullRequest: {\n          htmlUrl: pr.pull_request?.html_url || undefined,\n          created_at: DateTime.fromISO(pr.created_at).toRelative() || undefined,\n        },\n        title: pr.title,\n        number: pr.number,\n        user: {\n          login: pr.user?.login,\n          htmlUrl: pr.user?.html_url,\n        },\n        comments: pr.comments,\n        htmlUrl: pr.html_url,\n      }));\n    });\n  }\n}\n"],"names":[],"mappings":"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"}