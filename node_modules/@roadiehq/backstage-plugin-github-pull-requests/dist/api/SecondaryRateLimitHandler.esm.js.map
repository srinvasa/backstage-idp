{"version":3,"file":"SecondaryRateLimitHandler.esm.js","sources":["../../src/api/SecondaryRateLimitHandler.ts"],"sourcesContent":["/*\n * Copyright 2025 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport class SecondaryRateLimitHandler {\n  private static instance: SecondaryRateLimitHandler;\n  private requestQueue: Array<() => Promise<any>> = [];\n  private isProcessing = false;\n  private lastRequestTime = 0;\n  private minDelay = 1000;\n  private backoffMultiplier = 1;\n  private maxBackoff = 60000; // 1 minute\n\n  static getInstance(): SecondaryRateLimitHandler {\n    if (!this.instance) {\n      this.instance = new SecondaryRateLimitHandler();\n    }\n    return this.instance;\n  }\n\n  async executeWithBackoff<T>(\n    request: () => Promise<T>,\n    maxRetries = 5,\n  ): Promise<T> {\n    return new Promise((resolve, reject) => {\n      this.requestQueue.push(async () => {\n        let lastError: Error | null = null;\n\n        for (let attempt = 0; attempt <= maxRetries; attempt++) {\n          try {\n            // Apply current backoff delay\n            const timeSinceLastRequest = Date.now() - this.lastRequestTime;\n            const currentDelay = this.minDelay * this.backoffMultiplier;\n            const waitTime = Math.max(0, currentDelay - timeSinceLastRequest);\n\n            if (waitTime > 0) {\n              await new Promise(res => setTimeout(res, waitTime));\n            }\n\n            this.lastRequestTime = Date.now();\n            const result = await request();\n\n            // Success - reset backoff\n            this.backoffMultiplier = 1;\n            resolve(result);\n            return;\n          } catch (error: any) {\n            lastError = error;\n\n            if (this.isSecondaryRateLimit(error)) {\n              // eslint-disable-next-line no-console\n              console.warn(\n                `Secondary rate limit hit (attempt ${attempt + 1}/${\n                  maxRetries + 1\n                })`,\n              );\n\n              const retryAfter = this.extractRetryAfter(error);\n              const backoffDelay = retryAfter || Math.pow(2, attempt) * 1000;\n\n              this.backoffMultiplier = Math.min(\n                this.backoffMultiplier * 2,\n                this.maxBackoff / this.minDelay,\n              );\n\n              if (attempt < maxRetries) {\n                await new Promise(res => setTimeout(res, backoffDelay));\n                continue;\n              }\n            } else if (this.isPrimaryRateLimit(error)) {\n              // Handle primary rate limit differently\n              const resetTime = this.extractRateLimitReset(error);\n              if (resetTime && attempt < maxRetries) {\n                const waitTime = resetTime - Date.now() + 1000; // Some buffer time\n                // eslint-disable-next-line no-console\n                console.warn(\n                  `Primary rate limit hit, waiting ${waitTime}ms until reset`,\n                );\n                await new Promise(res => setTimeout(res, waitTime));\n                continue;\n              }\n            }\n\n            // If we get here, either it's not a rate limit error or we've exhausted retries\n            break;\n          }\n        }\n\n        reject(\n          lastError || new Error('Unknown error during request execution'),\n        );\n      });\n\n      this.processQueue();\n    });\n  }\n\n  private isSecondaryRateLimit(error: any): boolean {\n    if (!error?.response) return false;\n\n    const status = error.response.status;\n    const message = error.message?.toLowerCase() || '';\n    const body = error.response.data?.message?.toLowerCase() || '';\n\n    // GitHub secondary rate limit indicators\n    return (\n      status === 403 &&\n      (message.includes('secondary rate limit') ||\n        body.includes('secondary rate limit') ||\n        body.includes('abuse detection') ||\n        body.includes('too many requests') ||\n        error.response?.headers?.['x-ratelimit-remaining'] !== '0')\n    );\n  }\n\n  private isPrimaryRateLimit(error: any): boolean {\n    if (!error?.response) return false;\n\n    const status = error.response.status;\n    const remaining = error.response?.headers?.['x-ratelimit-remaining'];\n\n    return status === 403 && remaining === '0';\n  }\n\n  private extractRetryAfter(error: any): number | null {\n    const retryAfter = error.response?.headers?.['retry-after'];\n    if (retryAfter) {\n      const seconds = parseInt(retryAfter, 10);\n      return isNaN(seconds) ? null : seconds * 1000;\n    }\n\n    const message = error.response?.data?.documentation_url;\n    if (message?.includes('secondary-rate-limits')) {\n      return 60000;\n    }\n\n    return null;\n  }\n\n  private extractRateLimitReset(error: any): number | null {\n    const reset = error.response?.headers?.['x-ratelimit-reset'];\n    if (reset) {\n      const resetTime = parseInt(reset, 10) * 1000;\n      return isNaN(resetTime) ? null : resetTime;\n    }\n    return null;\n  }\n\n  private async processQueue(): Promise<void> {\n    if (this.isProcessing || this.requestQueue.length === 0) {\n      return;\n    }\n\n    this.isProcessing = true;\n\n    while (this.requestQueue.length > 0) {\n      const request = this.requestQueue.shift()!;\n      await request();\n    }\n\n    this.isProcessing = false;\n  }\n}\n"],"names":[],"mappings":"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"}