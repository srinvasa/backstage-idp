{"version":3,"file":"usePullRequestsStatistics.esm.js","sources":["../../src/components/usePullRequestsStatistics.ts"],"sourcesContent":["/*\n * Copyright 2025 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useAsync } from 'react-use';\nimport { githubPullRequestsApiRef } from '../api';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { PullRequestState, SearchPullRequestsResponseData } from '../types';\nimport { Duration } from 'luxon';\nimport { useEntity } from '@backstage/plugin-catalog-react';\nimport { getHostname } from '../utils/githubUtils';\n\nexport type PullRequestStats = {\n  avgTimeUntilMerge: string;\n  avgCodingTime: string;\n  mergedToClosedRatio: string;\n  avgChangedLinesCount: number;\n  avgAdditions: number;\n  avgDeletions: number;\n  avgChangedFilesCount: number;\n};\n\nexport type PullRequestStatsCount = {\n  avgTimeUntilMerge: number;\n  avgCodingTime: number;\n  closedCount: number;\n  mergedCount: number;\n  changedLinesCount: number;\n  additions: number;\n  deletions: number;\n  changedFilesCount: number;\n};\nexport type PullRequestStatsData = {\n  createdAt: string;\n  firstCommitAt: string | null;\n  closedAt: string | null;\n  pullRequest: {\n    mergedAt: string | null;\n    additions: number;\n    deletions: number;\n    changedFiles: number;\n  };\n};\nfunction calculateStatistics(pullRequestsData: PullRequestStatsData[]) {\n  const result = pullRequestsData.reduce<PullRequestStatsCount>(\n    (acc, curr) => {\n      acc.avgTimeUntilMerge += curr.pullRequest.mergedAt\n        ? new Date(curr.pullRequest.mergedAt).getTime() -\n          new Date(curr.createdAt).getTime()\n        : 0;\n      // Ignore PRs without any commit\n      if (curr.firstCommitAt) {\n        const avgCodingTime =\n          new Date(curr.createdAt).getTime() -\n          new Date(curr.firstCommitAt).getTime();\n        acc.avgCodingTime += avgCodingTime > 0 ? avgCodingTime : 0;\n      }\n      acc.mergedCount += curr.pullRequest.mergedAt ? 1 : 0;\n      acc.closedCount += curr.closedAt ? 1 : 0;\n      acc.additions += curr.pullRequest.additions;\n      acc.deletions += curr.pullRequest.deletions;\n      acc.changedLinesCount +=\n        curr.pullRequest.additions + curr.pullRequest.deletions;\n      acc.changedFilesCount += curr.pullRequest.changedFiles;\n      return acc;\n    },\n    {\n      avgTimeUntilMerge: 0,\n      avgCodingTime: 0,\n      closedCount: 0,\n      mergedCount: 0,\n      changedLinesCount: 0,\n      changedFilesCount: 0,\n      additions: 0,\n      deletions: 0,\n    },\n  );\n\n  return {\n    ...result,\n    avgChangedLinesCount: Math.round(\n      result.changedLinesCount / pullRequestsData.length,\n    ),\n    avgChangedFilesCount: Math.round(\n      result.changedFilesCount / pullRequestsData.length,\n    ),\n    avgAdditions: Math.round(result.additions / pullRequestsData.length),\n    avgDeletions: Math.round(result.deletions / pullRequestsData.length),\n  };\n}\nexport function usePullRequestsStatistics({\n  owner,\n  repo,\n  branch,\n  pageSize,\n  state,\n}: {\n  owner: string;\n  repo: string;\n  branch?: string;\n  pageSize: number;\n  state: PullRequestState;\n}) {\n  const api = useApi(githubPullRequestsApiRef);\n  const { entity } = useEntity();\n  const hostname = getHostname(entity);\n  const {\n    loading,\n    value: statsData,\n    error,\n  } = useAsync(async (): Promise<PullRequestStats> => {\n    if (!repo) {\n      return {\n        avgTimeUntilMerge: 'Never',\n        avgCodingTime: 'Never',\n        mergedToClosedRatio: '0%',\n        avgChangedLinesCount: 0,\n        avgChangedFilesCount: 0,\n        avgAdditions: 0,\n        avgDeletions: 0,\n      };\n    }\n    const {\n      pullRequestsData,\n    }: {\n      pullRequestsData: SearchPullRequestsResponseData;\n    } = await api.listPullRequests({\n      search: `state:${state}`,\n      hostname,\n      owner,\n      repo,\n      pageSize,\n      page: 1,\n      branch,\n    });\n\n    const botUsernames = [\n      'github-actions[bot]',\n      'dependabot[bot]',\n      'roadie-bot',\n    ];\n    const transformedData = await Promise.all(\n      pullRequestsData.items\n        .filter(obj => {\n          const login = obj.user?.login;\n          return login && !botUsernames.includes(login);\n        })\n        .map(async pr => {\n          const repoData = await api.getRepositoryData({\n            url: pr.pull_request.url,\n            hostname,\n          });\n          const commitDate = await api.getCommitDetailsData({\n            hostname,\n            owner,\n            repo,\n            number: pr.number,\n          });\n\n          return {\n            createdAt: pr.created_at,\n            closedAt: pr.closed_at,\n            firstCommitAt: commitDate.firstCommitDate?.toString() ?? null,\n            pullRequest: {\n              mergedAt: pr.pull_request.merged_at,\n              additions: repoData.additions,\n              deletions: repoData.deletions,\n              changedFiles: repoData.changedFiles,\n            },\n          };\n        }),\n    );\n\n    const calcResult = calculateStatistics(transformedData);\n\n    if (calcResult.closedCount === 0 || calcResult.mergedCount === 0)\n      return {\n        ...calcResult,\n        avgTimeUntilMerge: 'Never',\n        avgCodingTime: 'Never',\n        mergedToClosedRatio: '0%',\n      };\n    const avgTimeUntilMergeDiff =\n      calcResult.avgTimeUntilMerge / calcResult.mergedCount;\n\n    const avgTimeUntilMerge = Duration.fromMillis(avgTimeUntilMergeDiff)\n      .shiftTo('months', 'days', 'hour')\n      .toHuman({ notation: 'compact' });\n\n    const avgCodingTimeUntilPRRaised =\n      calcResult.avgCodingTime / transformedData.length;\n\n    const avgCodingTime = Duration.fromMillis(avgCodingTimeUntilPRRaised)\n      .shiftTo('months', 'days', 'hour')\n      .toHuman({ notation: 'compact' });\n    return {\n      ...calcResult,\n      avgTimeUntilMerge,\n      avgCodingTime,\n      mergedToClosedRatio: `${Math.round(\n        (calcResult.mergedCount / calcResult.closedCount) * 100,\n      )}%`,\n    };\n  }, [pageSize, repo, owner]);\n\n  return [\n    {\n      loading,\n      statsData,\n      projectName: `${owner}/${repo}`,\n      error,\n    },\n  ] as const;\n}\n"],"names":[],"mappings":"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"}