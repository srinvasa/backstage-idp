{"version":3,"file":"usePullRequests.esm.js","sources":["../../src/components/usePullRequests.ts"],"sourcesContent":["/*\n * Copyright 2025 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useState } from 'react';\nimport { useAsyncRetry } from 'react-use';\nimport { githubPullRequestsApiRef } from '../api';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { SearchPullRequestsResponseData } from '../types';\nimport { DateTime } from 'luxon';\nimport { useEntity } from '@backstage/plugin-catalog-react';\nimport { getHostname } from '../utils/githubUtils';\n\nexport type PullRequest = {\n  id: number;\n  number: number;\n  url: string;\n  title: string;\n  updatedTime: string | null;\n  createdTime: string | null;\n  state: string;\n  draft: boolean;\n  merged: string | null;\n  creatorNickname?: string | null;\n  creatorProfileLink?: string | null;\n  body: string;\n};\n\nexport function usePullRequests({\n  search,\n  owner,\n  repo,\n  branch,\n}: {\n  search: string;\n  owner: string;\n  repo: string;\n  branch?: string;\n}) {\n  const api = useApi(githubPullRequestsApiRef);\n  const { entity } = useEntity();\n  const hostname = getHostname(entity);\n  const [total, setTotal] = useState(0);\n  const [totalResults, setTotalResults] = useState(0);\n  const [page, setPage] = useState(0);\n  const [pageSize, setPageSize] = useState(5);\n  const getElapsedTime = (start: string): string | null => {\n    return DateTime.fromISO(start).toRelative();\n  };\n\n  const handleTotal = (total_count: number) => {\n    setTotal(total_count > 1000 ? 1000 : total_count);\n    setTotalResults(total_count);\n  };\n\n  const {\n    loading,\n    value: prData,\n    retry,\n    error,\n  } = useAsyncRetry<PullRequest[]>(async () => {\n    if (!repo) {\n      return [];\n    }\n    return (\n      api\n        // GitHub API pagination count starts from 1\n        .listPullRequests({\n          search,\n          owner,\n          repo,\n          pageSize,\n          page: page + 1,\n          branch,\n          hostname,\n        })\n        .then(\n          ({\n            pullRequestsData: { total_count, items },\n          }: {\n            pullRequestsData: SearchPullRequestsResponseData;\n          }) => {\n            if (total_count >= 0) {\n              handleTotal(total_count);\n            }\n            return items.map(\n              ({\n                id,\n                html_url,\n                title,\n                number,\n                created_at,\n                updated_at,\n                user,\n                state: pr_state,\n                draft,\n                pull_request: { merged_at },\n                body,\n              }) => ({\n                url: html_url,\n                id,\n                number,\n                title,\n                body: body!,\n                state: pr_state,\n                draft,\n                merged: merged_at,\n                creatorNickname: user?.login,\n                creatorProfileLink: user?.html_url,\n                createdTime: getElapsedTime(created_at),\n                updatedTime: getElapsedTime(updated_at),\n              }),\n            );\n          },\n        )\n    );\n  }, [page, pageSize, repo, owner]);\n  useEffect(() => {\n    setPage(0);\n    retry();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [search]);\n  return [\n    {\n      page,\n      pageSize,\n      loading,\n      prData,\n      projectName: `${owner}/${repo}`,\n      total,\n      totalResults,\n      error,\n    },\n    {\n      prData,\n      setPage,\n      setPageSize,\n      retry,\n    },\n  ] as const;\n}\n"],"names":[],"mappings":"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"}