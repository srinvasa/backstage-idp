{"version":3,"file":"useGithubLoggedIn.esm.js","sources":["../../src/hooks/useGithubLoggedIn.ts"],"sourcesContent":["/*\n * Copyright 2025 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { useEffect, useMemo } from 'react';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { scmAuthApiRef } from '@backstage/integration-react';\nimport { create } from 'zustand';\n\ninterface LoginState {\n  statusMap: Map<string, boolean>;\n  getStatus: (hash: string) => boolean;\n}\n\nconst useGitHubLoginStatusStore = create<LoginState>((_set, getState) => ({\n  statusMap: new Map<string, boolean>(),\n  getStatus: (hash: string) => {\n    return getState().statusMap.has(hash)\n      ? getState().statusMap.get(hash)!\n      : false;\n  },\n}));\n\nexport const useGithubLoggedIn = (\n  hostname: string = 'github.com',\n  scope: string[] = ['repo'],\n) => {\n  const { getStatus } = useGitHubLoginStatusStore();\n  const scmAuth = useApi(scmAuthApiRef);\n  const url = useMemo(() => `https://${hostname}`, [hostname]);\n  const hash = useMemo(() => url + scope.toString(), [scope, url]);\n\n  useEffect(() => {\n    const doLogin = async () => {\n      const credentials = await scmAuth.getCredentials({\n        additionalScope: {\n          customScopes: { github: scope },\n        },\n        url: url,\n        optional: true,\n      });\n\n      if (credentials?.token) {\n        useGitHubLoginStatusStore.setState(prev => ({\n          ...prev,\n          statusMap: new Map(prev.statusMap).set(hash, true),\n        }));\n      }\n    };\n\n    if (!getStatus(hash)) {\n      doLogin();\n    }\n  }, [hash, hostname, scmAuth, scope, url, getStatus]);\n\n  return {\n    isLoggedIn: getStatus(hash),\n    addLoginStatus: () =>\n      useGitHubLoginStatusStore.setState(prev => ({\n        ...prev,\n        statusMap: new Map(prev.statusMap).set(hash, true),\n      })),\n  };\n};\n"],"names":[],"mappings":";;;;;AAyBA,MAAM,yBAA4B,GAAA,MAAA,CAAmB,CAAC,IAAA,EAAM,QAAc,MAAA;AAAA,EACxE,SAAA,sBAAe,GAAqB,EAAA;AAAA,EACpC,SAAA,EAAW,CAAC,IAAiB,KAAA;AAC3B,IAAO,OAAA,QAAA,EAAW,CAAA,SAAA,CAAU,GAAI,CAAA,IAAI,CAChC,GAAA,QAAA,EAAW,CAAA,SAAA,CAAU,GAAI,CAAA,IAAI,CAC7B,GAAA,KAAA;AAAA;AAER,CAAE,CAAA,CAAA;AAEK,MAAM,oBAAoB,CAC/B,QAAA,GAAmB,cACnB,KAAkB,GAAA,CAAC,MAAM,CACtB,KAAA;AACH,EAAM,MAAA,EAAE,SAAU,EAAA,GAAI,yBAA0B,EAAA;AAChD,EAAM,MAAA,OAAA,GAAU,OAAO,aAAa,CAAA;AACpC,EAAM,MAAA,GAAA,GAAM,QAAQ,MAAM,CAAA,QAAA,EAAW,QAAQ,CAAI,CAAA,EAAA,CAAC,QAAQ,CAAC,CAAA;AAC3D,EAAM,MAAA,IAAA,GAAO,OAAQ,CAAA,MAAM,GAAM,GAAA,KAAA,CAAM,UAAY,EAAA,CAAC,KAAO,EAAA,GAAG,CAAC,CAAA;AAE/D,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,MAAM,UAAU,YAAY;AAC1B,MAAM,MAAA,WAAA,GAAc,MAAM,OAAA,CAAQ,cAAe,CAAA;AAAA,QAC/C,eAAiB,EAAA;AAAA,UACf,YAAA,EAAc,EAAE,MAAA,EAAQ,KAAM;AAAA,SAChC;AAAA,QACA,GAAA;AAAA,QACA,QAAU,EAAA;AAAA,OACX,CAAA;AAED,MAAA,IAAI,aAAa,KAAO,EAAA;AACtB,QAAA,yBAAA,CAA0B,SAAS,CAAS,IAAA,MAAA;AAAA,UAC1C,GAAG,IAAA;AAAA,UACH,SAAA,EAAW,IAAI,GAAI,CAAA,IAAA,CAAK,SAAS,CAAE,CAAA,GAAA,CAAI,MAAM,IAAI;AAAA,SACjD,CAAA,CAAA;AAAA;AACJ,KACF;AAEA,IAAI,IAAA,CAAC,SAAU,CAAA,IAAI,CAAG,EAAA;AACpB,MAAQ,OAAA,EAAA;AAAA;AACV,GACF,EAAG,CAAC,IAAM,EAAA,QAAA,EAAU,SAAS,KAAO,EAAA,GAAA,EAAK,SAAS,CAAC,CAAA;AAEnD,EAAO,OAAA;AAAA,IACL,UAAA,EAAY,UAAU,IAAI,CAAA;AAAA,IAC1B,cAAgB,EAAA,MACd,yBAA0B,CAAA,QAAA,CAAS,CAAS,IAAA,MAAA;AAAA,MAC1C,GAAG,IAAA;AAAA,MACH,SAAA,EAAW,IAAI,GAAI,CAAA,IAAA,CAAK,SAAS,CAAE,CAAA,GAAA,CAAI,MAAM,IAAI;AAAA,KACjD,CAAA;AAAA,GACN;AACF;;;;"}