{"version":3,"file":"useRequest.esm.js","sources":["../../src/hooks/useRequest.ts"],"sourcesContent":["/*\n * Copyright 2021 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useAsync } from 'react-use';\nimport { Octokit } from '@octokit/rest';\nimport { Entity } from '@backstage/catalog-model';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { useProjectEntity } from './useProjectEntity';\nimport { useEntityGithubScmIntegration } from './useEntityGithubScmIntegration';\nimport { useStore } from '../components/store';\nimport { scmAuthApiRef } from '@backstage/integration-react';\n\nexport const useRequest = (\n  entity: Entity,\n  requestName: string,\n  perPage: number = 0,\n  maxResults: number = 0,\n) => {\n  const auth = useApi(scmAuthApiRef);\n  const { hostname, baseUrl } = useEntityGithubScmIntegration(entity);\n  const { owner, repo } = useProjectEntity(entity);\n\n  const { state: requestState, setState: setRequestState } = useStore(\n    state => state.request,\n  );\n\n  const { value, loading, error } = useAsync(async (): Promise<any> => {\n    let result;\n    try {\n      const { token } = await auth.getCredentials({\n        url: `https://${hostname}/`,\n        additionalScope: {\n          customScopes: {\n            github: ['repo'],\n          },\n        },\n      });\n\n      const octokit = new Octokit({ auth: token });\n\n      const response = await octokit.request(\n        `GET /repos/{owner}/{repo}/${requestName}`,\n        {\n          headers: { 'if-none-match': requestState[requestName].etag },\n          baseUrl,\n          owner,\n          repo,\n          ...(perPage && { per_page: perPage }),\n        },\n      );\n      const data = response.data;\n\n      result = {\n        data: maxResults ? data.slice(0, maxResults) : data,\n        etag: response.headers.etag ?? '',\n      };\n    } catch (e: any) {\n      if (e.status === 304) {\n        result = requestState[requestName];\n      }\n    }\n\n    return result;\n  }, [baseUrl, requestName]);\n\n  if (value?.data) {\n    setRequestState(requestName, value);\n  }\n\n  return {\n    value: value ? value.data : undefined,\n    loading,\n    error,\n  };\n};\n"],"names":[],"mappings":";;;;;;;;AAyBO,MAAM,aAAa,CACxB,MAAA,EACA,aACA,OAAkB,GAAA,CAAA,EAClB,aAAqB,CAClB,KAAA;AACH,EAAM,MAAA,IAAA,GAAO,OAAO,aAAa,CAAA;AACjC,EAAA,MAAM,EAAE,QAAA,EAAU,OAAQ,EAAA,GAAI,8BAA8B,MAAM,CAAA;AAClE,EAAA,MAAM,EAAE,KAAA,EAAO,IAAK,EAAA,GAAI,iBAAiB,MAAM,CAAA;AAE/C,EAAA,MAAM,EAAE,KAAA,EAAO,YAAc,EAAA,QAAA,EAAU,iBAAoB,GAAA,QAAA;AAAA,IACzD,WAAS,KAAM,CAAA;AAAA,GACjB;AAEA,EAAA,MAAM,EAAE,KAAO,EAAA,OAAA,EAAS,KAAM,EAAA,GAAI,SAAS,YAA0B;AACnE,IAAI,IAAA,MAAA;AACJ,IAAI,IAAA;AACF,MAAA,MAAM,EAAE,KAAA,EAAU,GAAA,MAAM,KAAK,cAAe,CAAA;AAAA,QAC1C,GAAA,EAAK,WAAW,QAAQ,CAAA,CAAA,CAAA;AAAA,QACxB,eAAiB,EAAA;AAAA,UACf,YAAc,EAAA;AAAA,YACZ,MAAA,EAAQ,CAAC,MAAM;AAAA;AACjB;AACF,OACD,CAAA;AAED,MAAA,MAAM,UAAU,IAAI,OAAA,CAAQ,EAAE,IAAA,EAAM,OAAO,CAAA;AAE3C,MAAM,MAAA,QAAA,GAAW,MAAM,OAAQ,CAAA,OAAA;AAAA,QAC7B,6BAA6B,WAAW,CAAA,CAAA;AAAA,QACxC;AAAA,UACE,SAAS,EAAE,eAAA,EAAiB,YAAa,CAAA,WAAW,EAAE,IAAK,EAAA;AAAA,UAC3D,OAAA;AAAA,UACA,KAAA;AAAA,UACA,IAAA;AAAA,UACA,GAAI,OAAA,IAAW,EAAE,QAAA,EAAU,OAAQ;AAAA;AACrC,OACF;AACA,MAAA,MAAM,OAAO,QAAS,CAAA,IAAA;AAEtB,MAAS,MAAA,GAAA;AAAA,QACP,MAAM,UAAa,GAAA,IAAA,CAAK,KAAM,CAAA,CAAA,EAAG,UAAU,CAAI,GAAA,IAAA;AAAA,QAC/C,IAAA,EAAM,QAAS,CAAA,OAAA,CAAQ,IAAQ,IAAA;AAAA,OACjC;AAAA,aACO,CAAQ,EAAA;AACf,MAAI,IAAA,CAAA,CAAE,WAAW,GAAK,EAAA;AACpB,QAAA,MAAA,GAAS,aAAa,WAAW,CAAA;AAAA;AACnC;AAGF,IAAO,OAAA,MAAA;AAAA,GACN,EAAA,CAAC,OAAS,EAAA,WAAW,CAAC,CAAA;AAEzB,EAAA,IAAI,OAAO,IAAM,EAAA;AACf,IAAA,eAAA,CAAgB,aAAa,KAAK,CAAA;AAAA;AAGpC,EAAO,OAAA;AAAA,IACL,KAAA,EAAO,KAAQ,GAAA,KAAA,CAAM,IAAO,GAAA,KAAA,CAAA;AAAA,IAC5B,OAAA;AAAA,IACA;AAAA,GACF;AACF;;;;"}