{"version":3,"file":"useComplianceHooks.esm.js","sources":["../../src/hooks/useComplianceHooks.ts"],"sourcesContent":["/*\n * Copyright 2025 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity } from '@backstage/catalog-model';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { Octokit } from '@octokit/rest';\nimport { OctokitResponse } from '@octokit/types';\nimport { useAsync } from 'react-use';\nimport { useProjectEntity } from './useProjectEntity';\nimport { useEntityGithubScmIntegration } from './useEntityGithubScmIntegration';\nimport { useStore } from '../components/store';\nimport { scmAuthApiRef } from '@backstage/integration-react';\n\nexport const NO_LICENSE_MSG = 'No license file found';\n\nexport const useProtectedBranches = (\n  entity: Entity,\n): { branches?: []; error?: Error; loading: boolean } => {\n  const auth = useApi(scmAuthApiRef);\n  const { baseUrl, hostname } = useEntityGithubScmIntegration(entity);\n  const { owner, repo } = useProjectEntity(entity);\n\n  const { state: branches, setState: setBranches } = useStore(\n    state => state.branches,\n  );\n\n  const { value, loading, error } = useAsync(async (): Promise<any> => {\n    let result;\n    try {\n      const { token } = await auth.getCredentials({\n        url: `https://${hostname}/`,\n        additionalScope: {\n          customScopes: {\n            github: ['repo'],\n          },\n        },\n      });\n\n      const octokit = new Octokit({ auth: token });\n\n      const response = await octokit.request(\n        'GET /repos/{owner}/{repo}/branches',\n        {\n          headers: {\n            'if-none-match': branches.etag,\n          },\n          baseUrl,\n          owner,\n          repo,\n          protected: true,\n        },\n      );\n\n      result = { data: response.data, etag: response.headers.etag ?? '' };\n    } catch (e: any) {\n      if (e.status === 304) {\n        result = branches;\n      }\n    }\n    return result;\n  }, [baseUrl]);\n\n  if (value) {\n    setBranches(value);\n  }\n\n  return {\n    branches: value ? value?.data : undefined,\n    loading,\n    error,\n  };\n};\n\nexport const useRepoLicence = (\n  entity: Entity,\n): { license?: string; error?: Error; loading: boolean } => {\n  const auth = useApi(scmAuthApiRef);\n  const { baseUrl, hostname } = useEntityGithubScmIntegration(entity);\n  const { owner, repo } = useProjectEntity(entity);\n\n  const { state: license, setState: setLicense } = useStore(\n    state => state.license,\n  );\n\n  const { value, loading, error } = useAsync(async (): Promise<any> => {\n    if (license.data === NO_LICENSE_MSG) {\n      return license;\n    }\n\n    const { token } = await auth.getCredentials({\n      url: `https://${hostname}/`,\n      additionalScope: {\n        customScopes: {\n          github: ['repo'],\n        },\n      },\n    });\n\n    const octokit = new Octokit({ auth: token });\n\n    let result;\n    try {\n      const response = (await octokit.request(\n        'GET /repos/{owner}/{repo}/contents/{path}',\n        {\n          headers: {\n            'if-none-match': license.etag,\n          },\n          baseUrl,\n          owner,\n          repo,\n          path: 'LICENSE',\n        },\n      )) as OctokitResponse<any>;\n\n      const licenseData = atob(response.data.content)\n        .split('\\n')\n        .map(line => line.trim())\n        .filter(Boolean)[0];\n      result = { etag: response.headers.etag ?? '', data: licenseData };\n    } catch (e: any) {\n      if (e.status === 304) {\n        return license;\n      } else if (e.status === 404) {\n        result = { etag: '', data: NO_LICENSE_MSG };\n      }\n    }\n    return result;\n  }, [baseUrl]);\n\n  if (value) {\n    setLicense(value);\n  }\n\n  return {\n    license: value ? value?.data : undefined,\n    loading,\n    error,\n  };\n};\n"],"names":[],"mappings":"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"}