{"version":3,"file":"GithubClient.esm.js","sources":["../../src/apis/GithubClient.ts"],"sourcesContent":["/*\n * Copyright 2022 Larder Software Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { GithubApi } from './GithubApi';\nimport { ConfigApi } from '@backstage/core-plugin-api';\nimport { Octokit } from '@octokit/rest';\nimport parseGitUrl from 'git-url-parse';\nimport { MarkdownContentProps } from '../components/Widgets/MarkdownContent/types';\nimport { readGithubIntegrationConfigs } from '@backstage/integration';\nimport { ScmAuthApi } from '@backstage/integration-react';\n\nconst mimeTypeMap: Record<string, string> = {\n  svg: 'image/svg+xml',\n  png: 'image/png',\n  jpg: 'image/jpeg',\n  jpeg: 'image/jpeg',\n  gif: 'image/gif',\n  webp: 'image/webp',\n};\n\nconst mimeTypeLookup = (href: string): string | undefined => {\n  const match = href.match(/\\.([a-zA-Z]*)$/);\n  const extension = match ? match[1] : undefined;\n  return extension ? mimeTypeMap[extension.toLowerCase()] : undefined;\n};\n\nconst getRepositoryDefaultBranch = (url: string) => {\n  return new URL(url).searchParams.get('ref');\n};\n\n/**\n * Combines a given path to a README file with a relative path, resulting in a new path\n * that resolves the relative path against the directory of the README file.\n * This function is particularly useful for scenarios where navigation relative\n * to a known file location is needed, such as linking to another file in a Git repository.\n *\n * @param readmePath The absolute path to a README file. This path should be in the form of\n *                   an absolute path starting from the root directory (e.g., /path/to/repo/README.md).\n * @param relativePath The relative path to resolve against the directory containing the README file.\n *                     This path can include various combinations of ./ and ../ to navigate\n *                     up and down the directory tree (e.g., ../../../other/file.txt).\n * @return The resulting path after combining and resolving the relative path against the\n *         directory of the README file. The returned path is formatted as an absolute path\n *         starting from the root directory, without any protocol prefixes.\n *\n * Example:\n * const readmePath = '/path/to/repo/README.md';\n * const relativePath = '../../../other/file.txt';\n * const resultPath = combinePaths(readmePath, relativePath);\n * console.log(resultPath); // Outputs: '/path/other/file.txt'\n */\nconst combinePaths = (readmePath: string, relativePath: string): string => {\n  // Ensure readmePath is a full path\n  // Create a new URL object with the readmePath\n  const readmeUrl = new URL(`file://${readmePath}`);\n\n  // Get the directory path by navigating to the parent directory\n  const dirUrl = new URL('.', readmeUrl);\n\n  // Create a new URL object with the relative path and the directory path as base\n  const combinedUrl = new URL(relativePath, dirUrl);\n\n  return combinedUrl.pathname.startsWith('/')\n    ? combinedUrl.pathname\n    : `/${combinedUrl.pathname}`;\n};\n\nexport class GithubClient implements GithubApi {\n  private readonly configApi: ConfigApi;\n  private readonly scmAuthApi: ScmAuthApi;\n\n  constructor(options: { configApi: ConfigApi; scmAuthApi: ScmAuthApi }) {\n    this.configApi = options.configApi;\n    this.scmAuthApi = options.scmAuthApi;\n  }\n\n  private async getOctokit(hostname: string = 'github.com'): Promise<Octokit> {\n    const { token } = await this.scmAuthApi.getCredentials({\n      url: `https://${hostname}/`,\n      additionalScope: {\n        customScopes: {\n          github: ['repo'],\n        },\n      },\n    });\n    const configs = readGithubIntegrationConfigs(\n      this.configApi.getOptionalConfigArray('integrations.github') ?? [],\n    );\n    const githubIntegrationConfig = configs.find(v => v.host === hostname);\n    const baseUrl = githubIntegrationConfig?.apiBaseUrl;\n    return new Octokit({ auth: token, baseUrl });\n  }\n\n  async getContent(props: MarkdownContentProps): Promise<{\n    content: string;\n    media: Record<string, string>;\n    links: Record<string, string>;\n  }> {\n    const { path: customReadmePath, repo, owner, branch, hostname } = props;\n\n    const octokit = await this.getOctokit(hostname);\n\n    let query = 'readme';\n    if (customReadmePath) {\n      query = `contents/${customReadmePath}`;\n    }\n\n    const readmePath = query;\n\n    const response = await octokit.request(\n      `GET /repos/{owner}/{repo}/${query}`,\n      {\n        owner,\n        repo,\n        ...(branch && { ref: branch }),\n      },\n    );\n    const content = Buffer.from(response.data.content, 'base64').toString(\n      'utf8',\n    );\n\n    const mediaLinks = [\n      ...content.matchAll(\n        /!\\[([^\\]]*)\\]\\(([^)]+\\.(?:png|jpg|jpeg|gif|webp|svg))\\)/gi,\n      ),\n    ].map(match => [match[2], match[3]].join(''));\n\n    const media: Record<string, string> = {};\n\n    const { ref, resource: domain, protocol } = parseGitUrl(response.data.url);\n    const domainLowerCased = domain.toLocaleLowerCase('en-US');\n    for (const mediaLink of mediaLinks) {\n      const mimeType = mimeTypeLookup(mediaLink);\n      if (!mimeType) {\n        continue;\n      }\n\n      const getUrl = () => {\n        const linkLowerCased = mediaLink.toLocaleLowerCase('en-US');\n        if (!linkLowerCased.startsWith('http')) {\n          return new URL(mediaLink, response.data.url);\n        }\n\n        if (linkLowerCased.includes(domainLowerCased)) {\n          const {\n            owner: ownerLink,\n            name: repoLink,\n            ref: refLink,\n            filepath,\n          } = parseGitUrl(mediaLink);\n          if (filepath) {\n            return `/repos/${ownerLink}/${repoLink}/contents/${filepath}${\n              refLink && `?ref=${refLink}`\n            }`;\n          }\n        }\n        return undefined;\n      };\n\n      const url = getUrl();\n      if (url) {\n        try {\n          const contentResponse = await octokit.request(`GET ${url}`);\n          media[\n            mediaLink\n          ] = `data:${mimeType};base64,${contentResponse.data.content.replaceAll(\n            '\\n',\n            '',\n          )}`;\n        } catch (e: any) {\n          /* eslint no-console: [\"error\", { allow: [\"warn\"] }] */\n          console.warn(\n            `There was a problem loading the image content at ${url} via the GitHub API due to error: ${e.message}`,\n          );\n        }\n      }\n    }\n\n    const markdownLinks = [\n      ...content.matchAll(/\\[([^\\[\\]]*)\\]\\((?!https?:\\/\\/)(.*?)(\\.md)\\)/gim),\n    ].map(match => [match[2], match[3]].join(''));\n\n    const links: Record<string, string> = {};\n\n    const loadFromBranch =\n      branch || ref || getRepositoryDefaultBranch(response.data.url);\n\n    for (const markdownLink of markdownLinks) {\n      const basicLink = `${protocol}://${domain}/${owner}/${repo}/blob/${loadFromBranch}`;\n\n      const combinedPath = combinePaths(readmePath, markdownLink);\n      links[markdownLink] = `${basicLink}${combinedPath}`;\n    }\n    return { content, media, links };\n  }\n}\n"],"names":[],"mappings":";;;;AAwBA,MAAM,WAAsC,GAAA;AAAA,EAC1C,GAAK,EAAA,eAAA;AAAA,EACL,GAAK,EAAA,WAAA;AAAA,EACL,GAAK,EAAA,YAAA;AAAA,EACL,IAAM,EAAA,YAAA;AAAA,EACN,GAAK,EAAA,WAAA;AAAA,EACL,IAAM,EAAA;AACR,CAAA;AAEA,MAAM,cAAA,GAAiB,CAAC,IAAqC,KAAA;AAC3D,EAAM,MAAA,KAAA,GAAQ,IAAK,CAAA,KAAA,CAAM,gBAAgB,CAAA;AACzC,EAAA,MAAM,SAAY,GAAA,KAAA,GAAQ,KAAM,CAAA,CAAC,CAAI,GAAA,KAAA,CAAA;AACrC,EAAA,OAAO,SAAY,GAAA,WAAA,CAAY,SAAU,CAAA,WAAA,EAAa,CAAI,GAAA,KAAA,CAAA;AAC5D,CAAA;AAEA,MAAM,0BAAA,GAA6B,CAAC,GAAgB,KAAA;AAClD,EAAA,OAAO,IAAI,GAAI,CAAA,GAAG,CAAE,CAAA,YAAA,CAAa,IAAI,KAAK,CAAA;AAC5C,CAAA;AAuBA,MAAM,YAAA,GAAe,CAAC,UAAA,EAAoB,YAAiC,KAAA;AAGzE,EAAA,MAAM,SAAY,GAAA,IAAI,GAAI,CAAA,CAAA,OAAA,EAAU,UAAU,CAAE,CAAA,CAAA;AAGhD,EAAA,MAAM,MAAS,GAAA,IAAI,GAAI,CAAA,GAAA,EAAK,SAAS,CAAA;AAGrC,EAAA,MAAM,WAAc,GAAA,IAAI,GAAI,CAAA,YAAA,EAAc,MAAM,CAAA;AAEhD,EAAO,OAAA,WAAA,CAAY,SAAS,UAAW,CAAA,GAAG,IACtC,WAAY,CAAA,QAAA,GACZ,CAAI,CAAA,EAAA,WAAA,CAAY,QAAQ,CAAA,CAAA;AAC9B,CAAA;AAEO,MAAM,YAAkC,CAAA;AAAA,EAC5B,SAAA;AAAA,EACA,UAAA;AAAA,EAEjB,YAAY,OAA2D,EAAA;AACrE,IAAA,IAAA,CAAK,YAAY,OAAQ,CAAA,SAAA;AACzB,IAAA,IAAA,CAAK,aAAa,OAAQ,CAAA,UAAA;AAAA;AAC5B,EAEA,MAAc,UAAW,CAAA,QAAA,GAAmB,YAAgC,EAAA;AAC1E,IAAA,MAAM,EAAE,KAAM,EAAA,GAAI,MAAM,IAAA,CAAK,WAAW,cAAe,CAAA;AAAA,MACrD,GAAA,EAAK,WAAW,QAAQ,CAAA,CAAA,CAAA;AAAA,MACxB,eAAiB,EAAA;AAAA,QACf,YAAc,EAAA;AAAA,UACZ,MAAA,EAAQ,CAAC,MAAM;AAAA;AACjB;AACF,KACD,CAAA;AACD,IAAA,MAAM,OAAU,GAAA,4BAAA;AAAA,MACd,IAAK,CAAA,SAAA,CAAU,sBAAuB,CAAA,qBAAqB,KAAK;AAAC,KACnE;AACA,IAAA,MAAM,0BAA0B,OAAQ,CAAA,IAAA,CAAK,CAAK,CAAA,KAAA,CAAA,CAAE,SAAS,QAAQ,CAAA;AACrE,IAAA,MAAM,UAAU,uBAAyB,EAAA,UAAA;AACzC,IAAA,OAAO,IAAI,OAAQ,CAAA,EAAE,IAAM,EAAA,KAAA,EAAO,SAAS,CAAA;AAAA;AAC7C,EAEA,MAAM,WAAW,KAId,EAAA;AACD,IAAA,MAAM,EAAE,IAAM,EAAA,gBAAA,EAAkB,MAAM,KAAO,EAAA,MAAA,EAAQ,UAAa,GAAA,KAAA;AAElE,IAAA,MAAM,OAAU,GAAA,MAAM,IAAK,CAAA,UAAA,CAAW,QAAQ,CAAA;AAE9C,IAAA,IAAI,KAAQ,GAAA,QAAA;AACZ,IAAA,IAAI,gBAAkB,EAAA;AACpB,MAAA,KAAA,GAAQ,YAAY,gBAAgB,CAAA,CAAA;AAAA;AAGtC,IAAA,MAAM,UAAa,GAAA,KAAA;AAEnB,IAAM,MAAA,QAAA,GAAW,MAAM,OAAQ,CAAA,OAAA;AAAA,MAC7B,6BAA6B,KAAK,CAAA,CAAA;AAAA,MAClC;AAAA,QACE,KAAA;AAAA,QACA,IAAA;AAAA,QACA,GAAI,MAAA,IAAU,EAAE,GAAA,EAAK,MAAO;AAAA;AAC9B,KACF;AACA,IAAA,MAAM,UAAU,MAAO,CAAA,IAAA,CAAK,SAAS,IAAK,CAAA,OAAA,EAAS,QAAQ,CAAE,CAAA,QAAA;AAAA,MAC3D;AAAA,KACF;AAEA,IAAA,MAAM,UAAa,GAAA;AAAA,MACjB,GAAG,OAAQ,CAAA,QAAA;AAAA,QACT;AAAA;AACF,KACA,CAAA,GAAA,CAAI,CAAS,KAAA,KAAA,CAAC,KAAM,CAAA,CAAC,CAAG,EAAA,KAAA,CAAM,CAAC,CAAC,CAAE,CAAA,IAAA,CAAK,EAAE,CAAC,CAAA;AAE5C,IAAA,MAAM,QAAgC,EAAC;AAEvC,IAAM,MAAA,EAAE,KAAK,QAAU,EAAA,MAAA,EAAQ,UAAa,GAAA,WAAA,CAAY,QAAS,CAAA,IAAA,CAAK,GAAG,CAAA;AACzE,IAAM,MAAA,gBAAA,GAAmB,MAAO,CAAA,iBAAA,CAAkB,OAAO,CAAA;AACzD,IAAA,KAAA,MAAW,aAAa,UAAY,EAAA;AAClC,MAAM,MAAA,QAAA,GAAW,eAAe,SAAS,CAAA;AACzC,MAAA,IAAI,CAAC,QAAU,EAAA;AACb,QAAA;AAAA;AAGF,MAAA,MAAM,SAAS,MAAM;AACnB,QAAM,MAAA,cAAA,GAAiB,SAAU,CAAA,iBAAA,CAAkB,OAAO,CAAA;AAC1D,QAAA,IAAI,CAAC,cAAA,CAAe,UAAW,CAAA,MAAM,CAAG,EAAA;AACtC,UAAA,OAAO,IAAI,GAAA,CAAI,SAAW,EAAA,QAAA,CAAS,KAAK,GAAG,CAAA;AAAA;AAG7C,QAAI,IAAA,cAAA,CAAe,QAAS,CAAA,gBAAgB,CAAG,EAAA;AAC7C,UAAM,MAAA;AAAA,YACJ,KAAO,EAAA,SAAA;AAAA,YACP,IAAM,EAAA,QAAA;AAAA,YACN,GAAK,EAAA,OAAA;AAAA,YACL;AAAA,WACF,GAAI,YAAY,SAAS,CAAA;AACzB,UAAA,IAAI,QAAU,EAAA;AACZ,YAAO,OAAA,CAAA,OAAA,EAAU,SAAS,CAAA,CAAA,EAAI,QAAQ,CAAA,UAAA,EAAa,QAAQ,CACzD,EAAA,OAAA,IAAW,CAAQ,KAAA,EAAA,OAAO,CAC5B,CAAA,CAAA,CAAA;AAAA;AACF;AAEF,QAAO,OAAA,KAAA,CAAA;AAAA,OACT;AAEA,MAAA,MAAM,MAAM,MAAO,EAAA;AACnB,MAAA,IAAI,GAAK,EAAA;AACP,QAAI,IAAA;AACF,UAAA,MAAM,kBAAkB,MAAM,OAAA,CAAQ,OAAQ,CAAA,CAAA,IAAA,EAAO,GAAG,CAAE,CAAA,CAAA;AAC1D,UAAA,KAAA,CACE,SACF,CAAI,GAAA,CAAA,KAAA,EAAQ,QAAQ,CAAW,QAAA,EAAA,eAAA,CAAgB,KAAK,OAAQ,CAAA,UAAA;AAAA,YAC1D,IAAA;AAAA,YACA;AAAA,WACD,CAAA,CAAA;AAAA,iBACM,CAAQ,EAAA;AAEf,UAAQ,OAAA,CAAA,IAAA;AAAA,YACN,CAAoD,iDAAA,EAAA,GAAG,CAAqC,kCAAA,EAAA,CAAA,CAAE,OAAO,CAAA;AAAA,WACvG;AAAA;AACF;AACF;AAGF,IAAA,MAAM,aAAgB,GAAA;AAAA,MACpB,GAAG,OAAQ,CAAA,QAAA,CAAS,iDAAiD;AAAA,KACrE,CAAA,GAAA,CAAI,CAAS,KAAA,KAAA,CAAC,KAAM,CAAA,CAAC,CAAG,EAAA,KAAA,CAAM,CAAC,CAAC,CAAE,CAAA,IAAA,CAAK,EAAE,CAAC,CAAA;AAE5C,IAAA,MAAM,QAAgC,EAAC;AAEvC,IAAA,MAAM,iBACJ,MAAU,IAAA,GAAA,IAAO,0BAA2B,CAAA,QAAA,CAAS,KAAK,GAAG,CAAA;AAE/D,IAAA,KAAA,MAAW,gBAAgB,aAAe,EAAA;AACxC,MAAM,MAAA,SAAA,GAAY,CAAG,EAAA,QAAQ,CAAM,GAAA,EAAA,MAAM,IAAI,KAAK,CAAA,CAAA,EAAI,IAAI,CAAA,MAAA,EAAS,cAAc,CAAA,CAAA;AAEjF,MAAM,MAAA,YAAA,GAAe,YAAa,CAAA,UAAA,EAAY,YAAY,CAAA;AAC1D,MAAA,KAAA,CAAM,YAAY,CAAA,GAAI,CAAG,EAAA,SAAS,GAAG,YAAY,CAAA,CAAA;AAAA;AAEnD,IAAO,OAAA,EAAE,OAAS,EAAA,KAAA,EAAO,KAAM,EAAA;AAAA;AAEnC;;;;"}