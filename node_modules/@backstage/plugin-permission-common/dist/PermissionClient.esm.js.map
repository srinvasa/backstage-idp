{"version":3,"file":"PermissionClient.esm.js","sources":["../src/PermissionClient.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { ResponseError } from '@backstage/errors';\nimport fetch from 'cross-fetch';\nimport * as uuid from 'uuid';\nimport { z } from 'zod';\nimport {\n  AuthorizeResult,\n  PermissionMessageBatch,\n  PermissionCriteria,\n  PermissionCondition,\n  PermissionEvaluator,\n  QueryPermissionRequest,\n  AuthorizePermissionRequest,\n  AuthorizePermissionResponse,\n  QueryPermissionResponse,\n  IdentifiedPermissionMessage,\n} from './types/api';\nimport { DiscoveryApi } from './types/discovery';\nimport {\n  AuthorizeRequestOptions,\n  BasicPermission,\n  ResourcePermission,\n} from './types/permission';\nimport { isResourcePermission } from './permissions';\n\nconst permissionCriteriaSchema: z.ZodSchema<\n  PermissionCriteria<PermissionCondition>\n> = z.lazy(() =>\n  z\n    .object({\n      rule: z.string(),\n      resourceType: z.string(),\n      params: z.record(z.any()).optional(),\n    })\n    .or(z.object({ anyOf: z.array(permissionCriteriaSchema).nonempty() }))\n    .or(z.object({ allOf: z.array(permissionCriteriaSchema).nonempty() }))\n    .or(z.object({ not: permissionCriteriaSchema })),\n);\n\nconst authorizePermissionResponseSchema: z.ZodSchema<AuthorizePermissionResponse> =\n  z.object({\n    result: z\n      .literal(AuthorizeResult.ALLOW)\n      .or(z.literal(AuthorizeResult.DENY)),\n  });\n\nconst authorizePermissionResponseBatchSchema = z\n  .object({\n    result: z.array(\n      z.union([\n        z.literal(AuthorizeResult.ALLOW),\n        z.literal(AuthorizeResult.DENY),\n      ]),\n    ),\n  })\n  .or(authorizePermissionResponseSchema);\n\nconst queryPermissionResponseSchema: z.ZodSchema<QueryPermissionResponse> =\n  z.union([\n    z.object({\n      result: z\n        .literal(AuthorizeResult.ALLOW)\n        .or(z.literal(AuthorizeResult.DENY)),\n    }),\n    z.object({\n      result: z.literal(AuthorizeResult.CONDITIONAL),\n      pluginId: z.string(),\n      resourceType: z.string(),\n      conditions: permissionCriteriaSchema,\n    }),\n  ]);\n\nconst responseSchema = <T>(\n  itemSchema: z.ZodSchema<T>,\n  ids: Set<string>,\n): z.ZodSchema<PermissionMessageBatch<T>> =>\n  z.object({\n    items: z\n      .array(\n        z.intersection(\n          z.object({\n            id: z.string(),\n          }),\n          itemSchema,\n        ),\n      )\n      .refine(\n        items =>\n          items.length === ids.size && items.every(({ id }) => ids.has(id)),\n        {\n          message: 'Items in response do not match request',\n        },\n      ),\n  });\n\n/**\n * Options for {@link PermissionClient} requests.\n *\n * @public\n */\nexport type PermissionClientRequestOptions = {\n  token?: string;\n};\n\n/**\n * An isomorphic client for requesting authorization for Backstage permissions.\n * @public\n */\nexport class PermissionClient implements PermissionEvaluator {\n  private readonly enabled: boolean;\n  private readonly discovery: DiscoveryApi;\n  private readonly enableBatchedRequests: boolean;\n\n  constructor(options: { discovery: DiscoveryApi; config: Config }) {\n    this.discovery = options.discovery;\n    this.enabled =\n      options.config.getOptionalBoolean('permission.enabled') ?? false;\n\n    this.enableBatchedRequests =\n      options.config.getOptionalBoolean(\n        'permission.EXPERIMENTAL_enableBatchedRequests',\n      ) ?? false;\n  }\n\n  /**\n   * {@inheritdoc PermissionEvaluator.authorize}\n   */\n  async authorize(\n    requests: AuthorizePermissionRequest[],\n    options?: PermissionClientRequestOptions,\n  ): Promise<AuthorizePermissionResponse[]> {\n    if (!this.enabled) {\n      return requests.map(_ => ({ result: AuthorizeResult.ALLOW }));\n    }\n\n    if (this.enableBatchedRequests) {\n      return this.makeBatchedRequest(requests, options);\n    }\n\n    return this.makeRequest(\n      requests,\n      authorizePermissionResponseSchema,\n      options,\n    );\n  }\n\n  /**\n   * {@inheritdoc PermissionEvaluator.authorizeConditional}\n   */\n  async authorizeConditional(\n    queries: QueryPermissionRequest[],\n    options?: PermissionClientRequestOptions,\n  ): Promise<QueryPermissionResponse[]> {\n    if (!this.enabled) {\n      return queries.map(_ => ({ result: AuthorizeResult.ALLOW }));\n    }\n\n    return this.makeRequest(queries, queryPermissionResponseSchema, options);\n  }\n\n  private async makeRequest<TQuery, TResult>(\n    queries: TQuery[],\n    itemSchema: z.ZodSchema<TResult>,\n    options?: AuthorizeRequestOptions,\n  ) {\n    const request: PermissionMessageBatch<TQuery> = {\n      items: queries.map(query => ({\n        id: uuid.v4(),\n        ...query,\n      })),\n    };\n\n    const parsedResponse = await this.makeRawRequest(\n      request,\n      itemSchema,\n      options,\n    );\n\n    const responsesById = parsedResponse.items.reduce((acc, r) => {\n      acc[r.id] = r;\n      return acc;\n    }, {} as Record<string, z.infer<typeof itemSchema>>);\n\n    return request.items.map(query => responsesById[query.id]);\n  }\n\n  private async makeBatchedRequest(\n    queries: AuthorizePermissionRequest[],\n    options?: AuthorizeRequestOptions,\n  ) {\n    const request: Record<string, BatchedAuthorizePermissionRequest> = {};\n\n    for (const query of queries) {\n      const { permission, resourceRef } = query;\n\n      if (isResourcePermission(permission)) {\n        request[permission.name] ||= {\n          permission,\n          resourceRef: [],\n          id: uuid.v4(),\n        };\n\n        if (resourceRef) {\n          request[permission.name].resourceRef?.push(resourceRef);\n        }\n      } else {\n        request[permission.name] ||= {\n          permission,\n          id: uuid.v4(),\n        };\n      }\n    }\n\n    const parsedResponse = await this.makeRawRequest(\n      { items: Object.values(request) },\n      authorizePermissionResponseBatchSchema,\n      options,\n    );\n\n    const responsesById = parsedResponse.items.reduce((acc, r) => {\n      acc[r.id] = r;\n      return acc;\n    }, {} as Record<string, (typeof parsedResponse)['items'][number]>);\n\n    return queries.map(query => {\n      const { id } = request[query.permission.name];\n\n      const item = responsesById[id];\n\n      if (Array.isArray(item.result)) {\n        return {\n          result: query.resourceRef ? item.result.shift()! : item.result[0],\n        };\n      }\n      return { result: item.result };\n    });\n  }\n\n  private async makeRawRequest<TQuery, TResult>(\n    request: PermissionMessageBatch<TQuery>,\n    itemSchema: z.ZodSchema<TResult>,\n    options?: AuthorizeRequestOptions,\n  ) {\n    const permissionApi = await this.discovery.getBaseUrl('permission');\n    const response = await fetch(`${permissionApi}/authorize`, {\n      method: 'POST',\n      body: JSON.stringify(request),\n      headers: {\n        ...this.getAuthorizationHeader(options?.token),\n        'content-type': 'application/json',\n      },\n    });\n    if (!response.ok) {\n      throw await ResponseError.fromResponse(response);\n    }\n\n    const responseBody = await response.json();\n\n    return responseSchema(\n      itemSchema,\n      new Set(request.items.map(({ id }) => id)),\n    ).parse(responseBody);\n  }\n\n  private getAuthorizationHeader(token?: string): Record<string, string> {\n    return token ? { Authorization: `Bearer ${token}` } : {};\n  }\n}\n\n/**\n * @internal\n */\nexport type BatchedAuthorizePermissionRequest = IdentifiedPermissionMessage<\n  | {\n      permission: BasicPermission;\n      resourceRef?: undefined;\n    }\n  | { permission: ResourcePermission; resourceRef: string[] }\n>;\n"],"names":[],"mappings":"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"}