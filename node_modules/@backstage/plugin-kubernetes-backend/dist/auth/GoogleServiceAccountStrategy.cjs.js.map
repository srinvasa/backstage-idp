{"version":3,"file":"GoogleServiceAccountStrategy.cjs.js","sources":["../../src/auth/GoogleServiceAccountStrategy.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthMetadata,\n  AuthenticationStrategy,\n  KubernetesCredential,\n} from '@backstage/plugin-kubernetes-node';\nimport * as container from '@google-cloud/container';\nimport { Config } from '@backstage/config';\n\n/**\n * GoogleServiceAccountStrategy provides authentication using Google Service Account credentials.\n *\n * Credentials can be provided via configuration:\n * ```yaml\n * kubernetes:\n *   googleServiceAccountCredentials: |\n *     {\n *       \"type\": \"service_account\",\n *       \"project_id\": \"your-project-id\",\n *       \"private_key_id\": \"key-id\",\n *       \"private_key\": \"-----BEGIN PRIVATE KEY-----\\n...\\n-----END PRIVATE KEY-----\\n\",\n *       \"client_email\": \"your-service-account@your-project.iam.gserviceaccount.com\",\n *       \"client_id\": \"client-id\",\n *       \"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\",\n *       \"token_uri\": \"https://oauth2.googleapis.com/token\",\n *       \"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\",\n *       \"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/...\"\n *     }\n * ```\n *\n * If no credentials are provided in config, falls back to GOOGLE_APPLICATION_CREDENTIALS or ADC.\n *\n * @public\n */\nexport class GoogleServiceAccountStrategy implements AuthenticationStrategy {\n  private readonly credentials?: string;\n\n  constructor(opts: { config: Config }) {\n    this.credentials = opts.config.getOptionalString(\n      'kubernetes.googleServiceAccountCredentials',\n    );\n  }\n  public async getCredential(): Promise<KubernetesCredential> {\n    let client: container.v1.ClusterManagerClient;\n\n    if (this.credentials) {\n      // Use credentials from config\n      try {\n        const credentialsObject = JSON.parse(this.credentials);\n\n        client = new container.v1.ClusterManagerClient({\n          credentials: credentialsObject,\n        });\n      } catch (error) {\n        throw new Error(\n          `Failed to parse Google Service Account credentials from config: ${\n            error instanceof Error ? error.message : 'Invalid JSON'\n          }`,\n        );\n      }\n    } else {\n      // Fall back to Application Default Credentials or GOOGLE_APPLICATION_CREDENTIALS\n      client = new container.v1.ClusterManagerClient();\n    }\n\n    const token = await client.auth.getAccessToken();\n\n    if (!token) {\n      throw new Error(\n        'Unable to obtain access token for Google Cloud authentication. Check your credentials configuration.',\n      );\n    }\n    return { type: 'bearer token', token };\n  }\n\n  public validateCluster(): Error[] {\n    return [];\n  }\n\n  public presentAuthMetadata(_authMetadata: AuthMetadata): AuthMetadata {\n    return {};\n  }\n}\n"],"names":["container"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAiDO,MAAM,4BAAA,CAA+D;AAAA,EACzD,WAAA;AAAA,EAEjB,YAAY,IAAA,EAA0B;AACpC,IAAA,IAAA,CAAK,WAAA,GAAc,KAAK,MAAA,CAAO,iBAAA;AAAA,MAC7B;AAAA,KACF;AAAA,EACF;AAAA,EACA,MAAa,aAAA,GAA+C;AAC1D,IAAA,IAAI,MAAA;AAEJ,IAAA,IAAI,KAAK,WAAA,EAAa;AAEpB,MAAA,IAAI;AACF,QAAA,MAAM,iBAAA,GAAoB,IAAA,CAAK,KAAA,CAAM,IAAA,CAAK,WAAW,CAAA;AAErD,QAAA,MAAA,GAAS,IAAIA,oBAAA,CAAU,EAAA,CAAG,oBAAA,CAAqB;AAAA,UAC7C,WAAA,EAAa;AAAA,SACd,CAAA;AAAA,MACH,SAAS,KAAA,EAAO;AACd,QAAA,MAAM,IAAI,KAAA;AAAA,UACR,CAAA,gEAAA,EACE,KAAA,YAAiB,KAAA,GAAQ,KAAA,CAAM,UAAU,cAC3C,CAAA;AAAA,SACF;AAAA,MACF;AAAA,IACF,CAAA,MAAO;AAEL,MAAA,MAAA,GAAS,IAAIA,oBAAA,CAAU,EAAA,CAAG,oBAAA,EAAqB;AAAA,IACjD;AAEA,IAAA,MAAM,KAAA,GAAQ,MAAM,MAAA,CAAO,IAAA,CAAK,cAAA,EAAe;AAE/C,IAAA,IAAI,CAAC,KAAA,EAAO;AACV,MAAA,MAAM,IAAI,KAAA;AAAA,QACR;AAAA,OACF;AAAA,IACF;AACA,IAAA,OAAO,EAAE,IAAA,EAAM,cAAA,EAAgB,KAAA,EAAM;AAAA,EACvC;AAAA,EAEO,eAAA,GAA2B;AAChC,IAAA,OAAO,EAAC;AAAA,EACV;AAAA,EAEO,oBAAoB,aAAA,EAA2C;AACpE,IAAA,OAAO,EAAC;AAAA,EACV;AACF;;;;"}