{"version":3,"file":"ConfigClusterLocator.cjs.js","sources":["../../src/cluster-locator/ConfigClusterLocator.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport {\n  ANNOTATION_KUBERNETES_AUTH_PROVIDER,\n  ANNOTATION_KUBERNETES_AWS_ASSUME_ROLE,\n  ANNOTATION_KUBERNETES_AWS_EXTERNAL_ID,\n  ANNOTATION_KUBERNETES_OIDC_TOKEN_PROVIDER,\n} from '@backstage/plugin-kubernetes-common';\nimport {\n  ClusterDetails,\n  KubernetesClustersSupplier,\n  AuthenticationStrategy,\n} from '@backstage/plugin-kubernetes-node';\n\nexport class ConfigClusterLocator implements KubernetesClustersSupplier {\n  private readonly clusterDetails: ClusterDetails[];\n\n  constructor(clusterDetails: ClusterDetails[]) {\n    this.clusterDetails = clusterDetails;\n  }\n\n  static fromConfig(\n    config: Config,\n    authStrategy: AuthenticationStrategy,\n  ): ConfigClusterLocator {\n    const clusterNames = new Set();\n    return new ConfigClusterLocator(\n      config.getConfigArray('clusters').map(c => {\n        const authMetadataBlock = c.getOptional<{\n          [ANNOTATION_KUBERNETES_AUTH_PROVIDER]?: string;\n        }>('authMetadata');\n        const name = c.getString('name');\n        if (clusterNames.has(name)) {\n          throw new Error(`Duplicate cluster name '${name}'`);\n        }\n        clusterNames.add(name);\n        const authProvider =\n          authMetadataBlock?.[ANNOTATION_KUBERNETES_AUTH_PROVIDER] ??\n          c.getOptionalString('authProvider');\n        if (!authProvider) {\n          throw new Error(\n            `cluster '${name}' has no auth provider configured; this must be ` +\n              `specified via the 'authProvider' or ` +\n              `'authMetadata.${ANNOTATION_KUBERNETES_AUTH_PROVIDER}' parameter`,\n          );\n        }\n        const title = c.getOptionalString('title');\n        const clusterDetails: ClusterDetails = {\n          name,\n          ...(title && { title }),\n          url: c.getString('url'),\n          skipTLSVerify: c.getOptionalBoolean('skipTLSVerify') ?? false,\n          skipMetricsLookup: c.getOptionalBoolean('skipMetricsLookup') ?? false,\n          caData: c.getOptionalString('caData'),\n          caFile: c.getOptionalString('caFile'),\n          authMetadata: {\n            [ANNOTATION_KUBERNETES_AUTH_PROVIDER]: authProvider,\n            ...ConfigClusterLocator.parseAuthMetadata(c),\n            ...authMetadataBlock,\n          },\n        };\n\n        const customResources = c.getOptionalConfigArray('customResources');\n        if (customResources) {\n          clusterDetails.customResources = customResources.map(cr => {\n            return {\n              group: cr.getString('group'),\n              apiVersion: cr.getString('apiVersion'),\n              plural: cr.getString('plural'),\n            };\n          });\n        }\n\n        const dashboardUrl = c.getOptionalString('dashboardUrl');\n        if (dashboardUrl) {\n          clusterDetails.dashboardUrl = dashboardUrl;\n        }\n        const dashboardApp = c.getOptionalString('dashboardApp');\n        if (dashboardApp) {\n          clusterDetails.dashboardApp = dashboardApp;\n        }\n        if (c.has('dashboardParameters')) {\n          clusterDetails.dashboardParameters = c.get('dashboardParameters');\n        }\n\n        const validationErrors = authStrategy.validateCluster(\n          clusterDetails.authMetadata,\n        );\n        if (validationErrors.length !== 0) {\n          throw new Error(\n            `Invalid cluster '${clusterDetails.name}': ${validationErrors\n              .map(e => e.message)\n              .join(', ')}`,\n          );\n        }\n        return clusterDetails;\n      }),\n    );\n  }\n\n  private static parseAuthMetadata(\n    clusterConfig: Config,\n  ): Record<string, string> | undefined {\n    const serviceAccountToken = clusterConfig.getOptionalString(\n      'serviceAccountToken',\n    );\n    const assumeRole = clusterConfig.getOptionalString('assumeRole');\n    const externalId = clusterConfig.getOptionalString('externalId');\n    const oidcTokenProvider =\n      clusterConfig.getOptionalString('oidcTokenProvider');\n\n    return serviceAccountToken || assumeRole || externalId || oidcTokenProvider\n      ? {\n          ...(serviceAccountToken && { serviceAccountToken }),\n          ...(assumeRole && {\n            [ANNOTATION_KUBERNETES_AWS_ASSUME_ROLE]: assumeRole,\n          }),\n          ...(externalId && {\n            [ANNOTATION_KUBERNETES_AWS_EXTERNAL_ID]: externalId,\n          }),\n          ...(oidcTokenProvider && {\n            [ANNOTATION_KUBERNETES_OIDC_TOKEN_PROVIDER]: oidcTokenProvider,\n          }),\n        }\n      : undefined;\n  }\n\n  async getClusters(): Promise<ClusterDetails[]> {\n    return this.clusterDetails;\n  }\n}\n"],"names":["ANNOTATION_KUBERNETES_AUTH_PROVIDER","ANNOTATION_KUBERNETES_AWS_ASSUME_ROLE","ANNOTATION_KUBERNETES_AWS_EXTERNAL_ID","ANNOTATION_KUBERNETES_OIDC_TOKEN_PROVIDER"],"mappings":"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"}