{"version":3,"file":"GkeClusterLocator.cjs.js","sources":["../../src/cluster-locator/GkeClusterLocator.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ANNOTATION_KUBERNETES_AUTH_PROVIDER } from '@backstage/plugin-kubernetes-common';\nimport { Config } from '@backstage/config';\nimport { ForwardedError } from '@backstage/errors';\nimport * as container from '@google-cloud/container';\nimport { Duration } from 'luxon';\nimport { runPeriodically } from '../service/runPeriodically';\nimport {\n  ClusterDetails,\n  KubernetesClustersSupplier,\n} from '@backstage/plugin-kubernetes-node';\nimport packageinfo from '../../package.json';\n\ninterface MatchResourceLabelEntry {\n  key: string;\n  value: string;\n}\n\ntype GkeClusterLocatorOptions = {\n  projectId: string;\n  authProvider: string;\n  region?: string;\n  skipTLSVerify?: boolean;\n  skipMetricsLookup?: boolean;\n  exposeDashboard?: boolean;\n  matchingResourceLabels?: MatchResourceLabelEntry[];\n};\n\nexport class GkeClusterLocator implements KubernetesClustersSupplier {\n  private readonly options: GkeClusterLocatorOptions;\n  private readonly client: container.v1.ClusterManagerClient;\n  private clusterDetails: ClusterDetails[] | undefined;\n  private hasClusterDetails: boolean;\n\n  constructor(\n    options: GkeClusterLocatorOptions,\n    client: container.v1.ClusterManagerClient,\n    clusterDetails: ClusterDetails[] | undefined = undefined,\n    hasClusterDetails: boolean = false,\n  ) {\n    this.options = options;\n    this.client = client;\n    this.clusterDetails = clusterDetails;\n    this.hasClusterDetails = hasClusterDetails;\n  }\n\n  static fromConfigWithClient(\n    config: Config,\n    client: container.v1.ClusterManagerClient,\n    refreshInterval?: Duration,\n  ): GkeClusterLocator {\n    const matchingResourceLabels: MatchResourceLabelEntry[] =\n      config.getOptionalConfigArray('matchingResourceLabels')?.map(mrl => {\n        return { key: mrl.getString('key'), value: mrl.getString('value') };\n      }) ?? [];\n\n    const storeAuthProviderString =\n      config.getOptionalString('authProvider') === 'googleServiceAccount'\n        ? 'googleServiceAccount'\n        : 'google';\n\n    const options = {\n      projectId: config.getString('projectId'),\n      authProvider: storeAuthProviderString,\n      region: config.getOptionalString('region') ?? '-',\n      skipTLSVerify: config.getOptionalBoolean('skipTLSVerify') ?? false,\n      skipMetricsLookup:\n        config.getOptionalBoolean('skipMetricsLookup') ?? false,\n      exposeDashboard: config.getOptionalBoolean('exposeDashboard') ?? false,\n      matchingResourceLabels,\n    };\n    const gkeClusterLocator = new GkeClusterLocator(options, client);\n    if (refreshInterval) {\n      runPeriodically(\n        () => gkeClusterLocator.refreshClusters(),\n        refreshInterval.toMillis(),\n      );\n    }\n    return gkeClusterLocator;\n  }\n\n  // Added an `x-goog-api-client` header to API requests made by the GKE cluster locator to clearly identify API requests from this plugin.\n  static fromConfig(\n    config: Config,\n    refreshInterval: Duration | undefined = undefined,\n  ): GkeClusterLocator {\n    return GkeClusterLocator.fromConfigWithClient(\n      config,\n      new container.v1.ClusterManagerClient({\n        libName: `backstage/kubernetes-backend.GkeClusterLocator`,\n        libVersion: packageinfo.version,\n      }),\n      refreshInterval,\n    );\n  }\n\n  async getClusters(): Promise<ClusterDetails[]> {\n    if (!this.hasClusterDetails) {\n      // refresh at least once when first called, when retries are disabled and in tests\n      await this.refreshClusters();\n    }\n    return this.clusterDetails ?? [];\n  }\n\n  // TODO pass caData into the object\n  async refreshClusters(): Promise<void> {\n    const {\n      projectId,\n      region,\n      authProvider,\n      skipTLSVerify,\n      skipMetricsLookup,\n      exposeDashboard,\n      matchingResourceLabels,\n    } = this.options;\n    const request = {\n      parent: `projects/${projectId}/locations/${region}`,\n    };\n\n    try {\n      const [response] = await this.client.listClusters(request);\n      this.clusterDetails = (response.clusters ?? [])\n        .filter(r => {\n          return matchingResourceLabels?.every(mrl => {\n            if (!r.resourceLabels) {\n              return false;\n            }\n            return r.resourceLabels[mrl.key] === mrl.value;\n          });\n        })\n        .map(r => ({\n          // TODO filter out clusters which don't have name or endpoint\n          name: r.name ?? 'unknown',\n          url: `https://${r.endpoint ?? ''}`,\n          authMetadata: { [ANNOTATION_KUBERNETES_AUTH_PROVIDER]: authProvider },\n          skipTLSVerify,\n          skipMetricsLookup,\n          ...(exposeDashboard\n            ? {\n                dashboardApp: 'gke',\n                dashboardParameters: {\n                  projectId,\n                  region,\n                  clusterName: r.name,\n                },\n              }\n            : {}),\n        }));\n      this.hasClusterDetails = true;\n    } catch (e) {\n      throw new ForwardedError(\n        `There was an error retrieving clusters from GKE for projectId=${projectId} region=${region}`,\n        e,\n      );\n    }\n  }\n}\n"],"names":["runPeriodically","container","packageinfo","ANNOTATION_KUBERNETES_AUTH_PROVIDER","ForwardedError"],"mappings":"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"}