{"version":3,"file":"KubernetesInitializer.cjs.js","sources":["../../src/service/KubernetesInitializer.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthenticationStrategy,\n  CustomResource,\n  KubernetesClustersSupplier,\n  KubernetesClusterSupplierFactory,\n  KubernetesFetcher,\n  KubernetesFetcherFactory,\n  KubernetesObjectsProviderFactory,\n  KubernetesObjectTypes,\n  KubernetesServiceLocator,\n  KubernetesServiceLocatorFactory,\n  ObjectToFetch,\n} from '@backstage/plugin-kubernetes-node';\nimport { KubernetesClientBasedFetcher } from './KubernetesFetcher';\nimport {\n  AuthService,\n  LoggerService,\n  RootConfigService,\n} from '@backstage/backend-plugin-api';\nimport { buildDefaultAuthStrategyMap } from '../auth/buildDefaultAuthStrategyMap';\nimport { Duration } from 'luxon';\nimport { getCombinedClusterSupplier } from '../cluster-locator';\nimport { DispatchStrategy } from '../auth/DispatchStrategy';\nimport { CatalogService } from '@backstage/plugin-catalog-node';\nimport { buildDefaultServiceLocator } from '../service-locator/buildDefaultServiceLocator';\nimport {\n  ALL_OBJECTS,\n  DEFAULT_OBJECTS,\n  KubernetesFanOutHandler,\n} from './KubernetesFanOutHandler';\n\ntype Opts = {\n  fetcher?: KubernetesFetcherFactory;\n  clusterSupplier?: KubernetesClusterSupplierFactory;\n  serviceLocator?: KubernetesServiceLocatorFactory;\n  objectsProvider?: KubernetesObjectsProviderFactory;\n  authStrategyMap?: Map<string, AuthenticationStrategy>;\n  logger: LoggerService;\n  config: RootConfigService;\n  catalog: CatalogService;\n  auth: AuthService;\n};\n\nexport class KubernetesInitializer {\n  private readonly opts: Opts;\n\n  constructor(opts: Opts) {\n    this.opts = opts;\n  }\n\n  static create(opts: Opts) {\n    return new KubernetesInitializer(opts);\n  }\n\n  private async defaultFetcher() {\n    return new KubernetesClientBasedFetcher({\n      logger: this.opts.logger,\n    });\n  }\n\n  private async defaultAuthStrategy() {\n    return buildDefaultAuthStrategyMap({\n      logger: this.opts.logger,\n      config: this.opts.config,\n    });\n  }\n\n  private async defaultClusterSupplier(opts: {\n    authStrategyMap: Map<string, AuthenticationStrategy>;\n  }) {\n    const refreshInterval = Duration.fromObject({\n      minutes: 60,\n    });\n\n    return getCombinedClusterSupplier(\n      this.opts.config,\n      this.opts.catalog,\n      new DispatchStrategy({\n        authStrategyMap: Object.fromEntries(opts.authStrategyMap.entries()),\n      }),\n      this.opts.logger,\n      refreshInterval,\n      this.opts.auth,\n    );\n  }\n\n  private async defaultServiceLocator(opts: {\n    clusterSupplier: KubernetesClustersSupplier;\n  }) {\n    return buildDefaultServiceLocator({\n      config: this.opts.config,\n      clusterSupplier: opts.clusterSupplier,\n    });\n  }\n\n  private async defaultObjectsProvider(opts: {\n    clusterSupplier: KubernetesClustersSupplier;\n    authStrategyMap: Map<string, AuthenticationStrategy>;\n    fetcher: KubernetesFetcher;\n    serviceLocator: KubernetesServiceLocator;\n    customResources: CustomResource[];\n    objectTypesToFetch: ObjectToFetch[];\n  }) {\n    return new KubernetesFanOutHandler({\n      logger: this.opts.logger,\n      config: this.opts.config,\n      fetcher: opts.fetcher,\n      serviceLocator: opts.serviceLocator,\n      customResources: opts.customResources,\n      objectTypesToFetch: opts.objectTypesToFetch,\n      authStrategy: new DispatchStrategy({\n        authStrategyMap: Object.fromEntries(opts.authStrategyMap.entries()),\n      }),\n    });\n  }\n\n  private async defaultObjectsProviderOptions() {\n    const customResources: CustomResource[] = (\n      this.opts.config.getOptionalConfigArray('kubernetes.customResources') ??\n      []\n    ).map(\n      c =>\n        ({\n          group: c.getString('group'),\n          apiVersion: c.getString('apiVersion'),\n          plural: c.getString('plural'),\n          objectType: 'customresources',\n        } as CustomResource),\n    );\n    const objectTypesToFetchStrings = this.opts.config.getOptionalStringArray(\n      'kubernetes.objectTypes',\n    ) as KubernetesObjectTypes[];\n\n    const apiVersionOverrides = this.opts.config.getOptionalConfig(\n      'kubernetes.apiVersionOverrides',\n    );\n\n    let objectTypesToFetch: ObjectToFetch[] | undefined = undefined;\n\n    if (objectTypesToFetchStrings) {\n      objectTypesToFetch = ALL_OBJECTS.filter(obj =>\n        objectTypesToFetchStrings.includes(obj.objectType),\n      );\n    }\n\n    if (apiVersionOverrides) {\n      objectTypesToFetch ??= DEFAULT_OBJECTS;\n\n      for (const obj of objectTypesToFetch) {\n        if (apiVersionOverrides.has(obj.objectType)) {\n          obj.apiVersion = apiVersionOverrides.getString(obj.objectType);\n        }\n      }\n    }\n\n    return {\n      customResources,\n      objectTypesToFetch: objectTypesToFetch ?? DEFAULT_OBJECTS,\n    };\n  }\n\n  async init() {\n    const fetcher =\n      (await this.opts.fetcher?.({\n        getDefault: () => this.defaultFetcher(),\n      })) ?? (await this.defaultFetcher());\n\n    const authStrategyMap =\n      this.opts.authStrategyMap ?? (await this.defaultAuthStrategy());\n\n    const clusterSupplier =\n      (await this.opts.clusterSupplier?.({\n        getDefault: () => this.defaultClusterSupplier({ authStrategyMap }),\n      })) ?? (await this.defaultClusterSupplier({ authStrategyMap }));\n\n    const serviceLocator =\n      (await this.opts.serviceLocator?.({\n        getDefault: () => this.defaultServiceLocator({ clusterSupplier }),\n        clusterSupplier,\n      })) ?? (await this.defaultServiceLocator({ clusterSupplier }));\n\n    const { customResources, objectTypesToFetch } =\n      await this.defaultObjectsProviderOptions();\n\n    const objectsProvider =\n      (await this.opts.objectsProvider?.({\n        getDefault: () =>\n          this.defaultObjectsProvider({\n            clusterSupplier,\n            authStrategyMap,\n            fetcher,\n            serviceLocator,\n            customResources,\n            objectTypesToFetch,\n          }),\n        clusterSupplier,\n        serviceLocator,\n        customResources,\n        objectTypesToFetch,\n        authStrategy: new DispatchStrategy({\n          authStrategyMap: Object.fromEntries(authStrategyMap.entries()),\n        }),\n      })) ??\n      (await this.defaultObjectsProvider({\n        clusterSupplier,\n        authStrategyMap,\n        fetcher,\n        serviceLocator,\n        customResources,\n        objectTypesToFetch,\n      }));\n\n    return {\n      fetcher,\n      authStrategyMap,\n      clusterSupplier,\n      serviceLocator,\n      objectsProvider,\n    };\n  }\n}\n"],"names":["KubernetesClientBasedFetcher","buildDefaultAuthStrategyMap","Duration","getCombinedClusterSupplier","DispatchStrategy","buildDefaultServiceLocator","KubernetesFanOutHandler","ALL_OBJECTS","DEFAULT_OBJECTS"],"mappings":"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"}