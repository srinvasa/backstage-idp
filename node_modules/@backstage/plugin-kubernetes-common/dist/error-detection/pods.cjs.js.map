{"version":3,"file":"pods.cjs.js","sources":["../../src/error-detection/pods.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Pod, IContainerStatus, IContainer } from 'kubernetes-models/v1';\nimport { DetectedError, ErrorMapper, ProposedFix } from './types';\nimport { detectErrorsInObjects } from './common';\nimport lodash from 'lodash';\nimport { DateTime } from 'luxon';\n\nfunction isPodReadinessProbeUnready({\n  container,\n  containerStatus,\n}: ContainerSpecAndStatus): boolean {\n  if (\n    containerStatus.ready ||\n    containerStatus.state?.running?.startedAt === undefined ||\n    !container.readinessProbe\n  ) {\n    return false;\n  }\n  const startDateTime = DateTime.fromISO(\n    containerStatus.state?.running?.startedAt,\n  )\n    // Add initial delay\n    .plus({\n      seconds: container.readinessProbe?.initialDelaySeconds ?? 0,\n    })\n    // Add failure threshold\n    .plus({\n      seconds:\n        (container.readinessProbe?.periodSeconds ?? 0) *\n        (container.readinessProbe?.failureThreshold ?? 0),\n    });\n  return startDateTime < DateTime.now();\n}\n\ninterface ContainerSpecAndStatus {\n  container: IContainer;\n  containerStatus: IContainerStatus;\n}\n\nconst podToContainerSpecsAndStatuses = (pod: Pod): ContainerSpecAndStatus[] => {\n  const specs = lodash.groupBy(pod.spec?.containers ?? [], value => value.name);\n\n  const result: ContainerSpecAndStatus[] = [];\n\n  for (const cs of pod.status?.containerStatuses ?? []) {\n    const spec = specs[cs.name];\n    if (spec.length > 0) {\n      result.push({\n        container: spec[0],\n        containerStatus: cs,\n      });\n    }\n  }\n\n  return result;\n};\n\nconst readinessProbeProposedFixes = (pod: Pod): ProposedFix | undefined => {\n  const firstUnreadyContainerStatus = pod.status?.containerStatuses?.find(\n    cs => {\n      return cs.ready === false;\n    },\n  );\n\n  return {\n    errorType: 'ReadinessProbeFailed',\n    rootCauseExplanation: `The container ${firstUnreadyContainerStatus?.name} failed to start properly, but is not crashing`,\n    actions: [\n      'Ensure that the container starts correctly locally',\n      \"Check the container's logs looking for error during startup\",\n    ],\n    type: 'events',\n    podName: pod.metadata?.name ?? '',\n  };\n};\n\nconst restartingPodProposedFixes = (pod: Pod): ProposedFix | undefined => {\n  const lastTerminatedCs = (pod.status?.containerStatuses ?? []).find(\n    cs => cs.lastState?.terminated !== undefined,\n  );\n\n  const lastTerminated = lastTerminatedCs?.lastState?.terminated;\n\n  if (!lastTerminated) {\n    return undefined;\n  }\n\n  switch (lastTerminated?.reason) {\n    case 'Unknown':\n      return {\n        // TODO check this one, it's more likely a cluster issue\n        errorType: 'Unknown',\n        rootCauseExplanation: `This container has exited with a non-zero exit code (${lastTerminated.exitCode})`,\n        actions: ['Check the crash logs for stacktraces'],\n        container: lastTerminatedCs.name,\n        type: 'logs',\n      };\n    case 'Error':\n      return {\n        errorType: 'Error',\n        rootCauseExplanation: `This container has exited with a non-zero exit code (${lastTerminated.exitCode})`,\n        actions: ['Check the crash logs for stacktraces'],\n        container: lastTerminatedCs.name,\n        type: 'logs',\n      };\n    case 'OOMKilled':\n      return {\n        errorType: 'OOMKilled',\n        rootCauseExplanation: `The container \"${lastTerminatedCs.name}\" has crashed because it has tried to use more memory that it has been allocated`,\n        actions: [\n          `Increase the amount of memory assigned to the container`,\n          'Ensure the application is memory bounded and is not trying to consume too much memory',\n        ],\n        docsLink:\n          'https://kubernetes.io/docs/tasks/configure-pod-container/assign-memory-resource/#exceed-a-container-s-memory-limit',\n        type: 'docs',\n      };\n    default:\n      return undefined;\n  }\n};\n\nconst waitingProposedFix = (pod: Pod): ProposedFix | undefined => {\n  const waitingCs = (pod.status?.containerStatuses ?? []).find(\n    cs => cs.state?.waiting !== undefined,\n  );\n\n  const waiting = (pod.status?.containerStatuses ?? [])\n    .map(cs => cs.state?.waiting)\n    .find(w => w?.reason !== undefined);\n\n  switch (waiting?.reason) {\n    case 'InvalidImageName':\n      return {\n        errorType: 'InvalidImageName',\n        rootCauseExplanation: 'The image in the pod is invalid',\n        actions: ['Ensure the image name is correct and valid image name'],\n        type: 'docs',\n        docsLink:\n          'https://docs.docker.com/engine/reference/commandline/tag/#extended-description',\n      };\n    case 'ImagePullBackOff':\n      return {\n        errorType: 'ImagePullBackOff',\n        rootCauseExplanation:\n          'The image either could not be found or Kubernetes does not have permission to pull it',\n        actions: [\n          'Ensure the image name is correct',\n          'Ensure Kubernetes has permission to pull this image',\n        ],\n        type: 'docs',\n        docsLink:\n          'https://kubernetes.io/docs/concepts/containers/images/#imagepullbackoff',\n      };\n    case 'CrashLoopBackOff':\n      return {\n        errorType: 'CrashLoopBackOff',\n        rootCauseExplanation: `The container ${waitingCs?.name} has crashed many times, it will be exponentially restarted until it stops crashing`,\n        actions: ['Check the crash logs for stacktraces'],\n        type: 'logs',\n        container: waitingCs?.name ?? 'unknown',\n      };\n    case 'CreateContainerConfigError':\n      return {\n        errorType: 'CreateContainerConfigError',\n        rootCauseExplanation:\n          'There is missing or mismatching configuration required to start the container',\n        actions: [\n          'Ensure ConfigMaps references in the Deployment manifest are correct and the keys exist',\n          'Ensure Secrets references in the Deployment manifest are correct and the keys exist',\n        ],\n        type: 'docs',\n        docsLink:\n          'https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/',\n      };\n    default:\n      return undefined;\n  }\n};\n\nconst podErrorMappers: ErrorMapper<Pod>[] = [\n  {\n    detectErrors: pod => {\n      return podToContainerSpecsAndStatuses(pod)\n        .filter(isPodReadinessProbeUnready)\n        .map(cs => ({\n          type: 'readiness-probe-taking-too-long',\n          message: `The container ${cs.container.name} failed to start properly, but is not crashing`,\n          severity: 4,\n          proposedFix: readinessProbeProposedFixes(pod),\n          sourceRef: {\n            name: pod.metadata?.name ?? 'unknown pod',\n            namespace: pod.metadata?.namespace ?? 'unknown namespace',\n            kind: 'Pod',\n            apiGroup: 'v1',\n          },\n          occurrenceCount: 1,\n        }));\n    },\n  },\n  {\n    detectErrors: pod => {\n      return (pod.status?.containerStatuses ?? [])\n        .filter(cs => cs.state?.waiting?.message !== undefined)\n        .map(cs => ({\n          type: 'container-waiting',\n          message: cs.state?.waiting?.message ?? 'container waiting',\n          severity: 4,\n          proposedFix: waitingProposedFix(pod),\n          sourceRef: {\n            name: pod.metadata?.name ?? 'unknown pod',\n            namespace: pod.metadata?.namespace ?? 'unknown namespace',\n            kind: 'Pod',\n            apiGroup: 'v1',\n          },\n          occurrenceCount: 1,\n        }));\n    },\n  },\n  {\n    detectErrors: pod => {\n      return (pod.status?.containerStatuses ?? [])\n        .filter(cs => cs.restartCount > 0)\n        .map(cs => ({\n          type: 'containers-restarting',\n          message: `container=${cs.name} restarted ${cs.restartCount} times`,\n          severity: 4,\n          proposedFix: restartingPodProposedFixes(pod),\n          sourceRef: {\n            name: pod.metadata?.name ?? 'unknown pod',\n            namespace: pod.metadata?.namespace ?? 'unknown namespace',\n            kind: 'Pod',\n            apiGroup: 'v1',\n          },\n          occurrenceCount: cs.restartCount,\n        }));\n    },\n  },\n];\n\nexport const detectErrorsInPods = (pods: Pod[]): DetectedError[] =>\n  detectErrorsInObjects(pods, podErrorMappers);\n"],"names":["DateTime","lodash","detectErrorsInObjects"],"mappings":"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"}