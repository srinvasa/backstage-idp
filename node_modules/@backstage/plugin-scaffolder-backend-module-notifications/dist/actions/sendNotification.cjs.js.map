{"version":3,"file":"sendNotification.cjs.js","sources":["../../src/actions/sendNotification.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  NotificationRecipients,\n  NotificationService,\n} from '@backstage/plugin-notifications-node';\nimport { NotificationPayload } from '@backstage/plugin-notifications-common';\nimport { createTemplateAction } from '@backstage/plugin-scaffolder-node';\nimport { examples } from './sendNotification.examples';\n\n/**\n * @public\n */\nexport function createSendNotificationAction(options: {\n  notifications: NotificationService;\n}) {\n  const { notifications } = options;\n  return createTemplateAction({\n    id: 'notification:send',\n    description: 'Sends a notification using NotificationService',\n    examples,\n    schema: {\n      input: {\n        recipients: z =>\n          z\n            .enum(['broadcast', 'entity'])\n            .describe(\n              'The recipient of the notification, either broadcast or entity. If using entity, also entityRef must be provided',\n            ),\n        entityRefs: z =>\n          z\n            .array(z.string())\n            .optional()\n            .describe(\n              'The entity references to send the notification to, required if using recipient of entity',\n            ),\n        title: z => z.string().describe('Notification title'),\n        info: z => z.string().optional().describe('Notification description'),\n        link: z => z.string().optional().describe('Notification link'),\n        severity: z =>\n          z\n            .enum(['low', 'normal', 'high', 'critical'])\n            .optional()\n            .describe('Notification severity'),\n        scope: z => z.string().optional().describe('Notification scope'),\n        topic: z => z.string().optional().describe('Notification topic'),\n        optional: z =>\n          z\n            .boolean()\n            .optional()\n            .describe(\n              'Do not fail the action if the notification sending fails',\n            ),\n      },\n    },\n    async handler(ctx) {\n      const {\n        recipients,\n        entityRefs,\n        title,\n        info,\n        link,\n        severity,\n        topic,\n        scope,\n        optional,\n      } = ctx.input;\n\n      ctx.logger.info(`Sending notification to ${recipients}`);\n      if (recipients === 'entity' && !entityRefs) {\n        if (optional !== true) {\n          throw new Error('Entity references must be provided');\n        }\n        return;\n      }\n\n      const notificationRecipients: NotificationRecipients =\n        recipients === 'broadcast'\n          ? { type: 'broadcast' }\n          : { type: 'entity', entityRef: entityRefs! };\n      const payload: NotificationPayload = {\n        title,\n        description: info,\n        link,\n        severity,\n        topic,\n        scope,\n      };\n\n      try {\n        await ctx.checkpoint({\n          key: `send.notification.${payload.title}`,\n          fn: async () => {\n            await notifications.send({\n              recipients: notificationRecipients,\n              payload,\n            });\n          },\n        });\n      } catch (e) {\n        ctx.logger.error(`Failed to send notification: ${e}`);\n        if (optional !== true) {\n          throw e;\n        }\n      }\n    },\n  });\n}\n"],"names":["createTemplateAction","examples"],"mappings":"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"}