{"version":3,"file":"TemplateActionRegistry.cjs.js","sources":["../../../src/scaffolder/actions/TemplateActionRegistry.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ConflictError, NotFoundError } from '@backstage/errors';\nimport { TemplateAction } from '@backstage/plugin-scaffolder-node';\nimport { ActionsService } from '@backstage/backend-plugin-api/alpha';\nimport {\n  BackstageCredentials,\n  LoggerService,\n} from '@backstage/backend-plugin-api';\nimport { isPlainObject } from 'lodash';\nimport { Schema } from 'jsonschema';\nimport { JsonObject } from '@backstage/types';\n\n/**\n * @internal\n */\nexport interface TemplateActionRegistry {\n  register(action: TemplateAction<any, any, any>): void;\n  get(\n    actionId: string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<TemplateAction<any, any, any>>;\n  list(options: {\n    credentials: BackstageCredentials;\n  }): Promise<Map<string, TemplateAction<any, any, any>>>;\n}\n\n/**\n * Registry of all registered template actions.\n */\nexport class DefaultTemplateActionRegistry implements TemplateActionRegistry {\n  private readonly actions = new Map<string, TemplateAction>();\n\n  constructor(\n    private readonly actionsRegistry: ActionsService,\n    private readonly logger: LoggerService,\n  ) {}\n\n  register(action: TemplateAction<any, any, any>) {\n    if (this.actions.has(action.id)) {\n      throw new ConflictError(\n        `Template action with ID '${action.id}' has already been registered`,\n      );\n    }\n\n    this.actions.set(action.id, action);\n  }\n\n  async get(\n    actionId: string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<TemplateAction<any, any, any>> {\n    const action = (await this.list(options)).get(actionId);\n    if (!action) {\n      throw new NotFoundError(\n        `Template action with ID '${actionId}' is not registered. See https://backstage.io/docs/features/software-templates/builtin-actions/ on how to add a new action module.`,\n      );\n    }\n    return action;\n  }\n\n  async list(options: {\n    credentials: BackstageCredentials;\n  }): Promise<Map<string, TemplateAction<any, any, any>>> {\n    const ret = new Map(this.actions);\n\n    const { actions } = await this.actionsRegistry.list({\n      credentials: options.credentials,\n    });\n\n    for (const action of actions) {\n      if (ret.has(action.id)) {\n        this.logger.warn(\n          `Template action with ID '${action.id}' has already been registered, skipping action provided by actions service`,\n        );\n        continue;\n      }\n\n      ret.set(action.id, {\n        id: action.id,\n        description: action.description,\n        examples: [],\n        supportsDryRun:\n          action.attributes?.readOnly === true &&\n          action.attributes?.destructive === false,\n        handler: async ctx => {\n          const { output } = await this.actionsRegistry.invoke({\n            id: action.id,\n            input: ctx.input,\n            credentials: await ctx.getInitiatorCredentials(),\n          });\n\n          if (isPlainObject(output)) {\n            for (const [key, value] of Object.entries(output as JsonObject)) {\n              ctx.output(key as keyof typeof output, value);\n            }\n          }\n        },\n        schema: {\n          input: action.schema.input as Schema,\n          output: action.schema.output as Schema,\n        },\n      });\n    }\n    return ret;\n  }\n}\n"],"names":["ConflictError","NotFoundError","isPlainObject"],"mappings":";;;;;AA4CO,MAAM,6BAAA,CAAgE;AAAA,EAG3E,WAAA,CACmB,iBACA,MAAA,EACjB;AAFiB,IAAA,IAAA,CAAA,eAAA,GAAA,eAAA;AACA,IAAA,IAAA,CAAA,MAAA,GAAA,MAAA;AAAA,EAChB;AAAA,EALc,OAAA,uBAAc,GAAA,EAA4B;AAAA,EAO3D,SAAS,MAAA,EAAuC;AAC9C,IAAA,IAAI,IAAA,CAAK,OAAA,CAAQ,GAAA,CAAI,MAAA,CAAO,EAAE,CAAA,EAAG;AAC/B,MAAA,MAAM,IAAIA,oBAAA;AAAA,QACR,CAAA,yBAAA,EAA4B,OAAO,EAAE,CAAA,6BAAA;AAAA,OACvC;AAAA,IACF;AAEA,IAAA,IAAA,CAAK,OAAA,CAAQ,GAAA,CAAI,MAAA,CAAO,EAAA,EAAI,MAAM,CAAA;AAAA,EACpC;AAAA,EAEA,MAAM,GAAA,CACJ,QAAA,EACA,OAAA,EACwC;AACxC,IAAA,MAAM,UAAU,MAAM,IAAA,CAAK,KAAK,OAAO,CAAA,EAAG,IAAI,QAAQ,CAAA;AACtD,IAAA,IAAI,CAAC,MAAA,EAAQ;AACX,MAAA,MAAM,IAAIC,oBAAA;AAAA,QACR,4BAA4B,QAAQ,CAAA,kIAAA;AAAA,OACtC;AAAA,IACF;AACA,IAAA,OAAO,MAAA;AAAA,EACT;AAAA,EAEA,MAAM,KAAK,OAAA,EAE6C;AACtD,IAAA,MAAM,GAAA,GAAM,IAAI,GAAA,CAAI,IAAA,CAAK,OAAO,CAAA;AAEhC,IAAA,MAAM,EAAE,OAAA,EAAQ,GAAI,MAAM,IAAA,CAAK,gBAAgB,IAAA,CAAK;AAAA,MAClD,aAAa,OAAA,CAAQ;AAAA,KACtB,CAAA;AAED,IAAA,KAAA,MAAW,UAAU,OAAA,EAAS;AAC5B,MAAA,IAAI,GAAA,CAAI,GAAA,CAAI,MAAA,CAAO,EAAE,CAAA,EAAG;AACtB,QAAA,IAAA,CAAK,MAAA,CAAO,IAAA;AAAA,UACV,CAAA,yBAAA,EAA4B,OAAO,EAAE,CAAA,0EAAA;AAAA,SACvC;AACA,QAAA;AAAA,MACF;AAEA,MAAA,GAAA,CAAI,GAAA,CAAI,OAAO,EAAA,EAAI;AAAA,QACjB,IAAI,MAAA,CAAO,EAAA;AAAA,QACX,aAAa,MAAA,CAAO,WAAA;AAAA,QACpB,UAAU,EAAC;AAAA,QACX,gBACE,MAAA,CAAO,UAAA,EAAY,aAAa,IAAA,IAChC,MAAA,CAAO,YAAY,WAAA,KAAgB,KAAA;AAAA,QACrC,OAAA,EAAS,OAAM,GAAA,KAAO;AACpB,UAAA,MAAM,EAAE,MAAA,EAAO,GAAI,MAAM,IAAA,CAAK,gBAAgB,MAAA,CAAO;AAAA,YACnD,IAAI,MAAA,CAAO,EAAA;AAAA,YACX,OAAO,GAAA,CAAI,KAAA;AAAA,YACX,WAAA,EAAa,MAAM,GAAA,CAAI,uBAAA;AAAwB,WAChD,CAAA;AAED,UAAA,IAAIC,oBAAA,CAAc,MAAM,CAAA,EAAG;AACzB,YAAA,KAAA,MAAW,CAAC,GAAA,EAAK,KAAK,KAAK,MAAA,CAAO,OAAA,CAAQ,MAAoB,CAAA,EAAG;AAC/D,cAAA,GAAA,CAAI,MAAA,CAAO,KAA4B,KAAK,CAAA;AAAA,YAC9C;AAAA,UACF;AAAA,QACF,CAAA;AAAA,QACA,MAAA,EAAQ;AAAA,UACN,KAAA,EAAO,OAAO,MAAA,CAAO,KAAA;AAAA,UACrB,MAAA,EAAQ,OAAO,MAAA,CAAO;AAAA;AACxB,OACD,CAAA;AAAA,IACH;AACA,IAAA,OAAO,GAAA;AAAA,EACT;AACF;;;;"}