{"version":3,"file":"useExternalRedirect.esm.js","sources":["../../../../src/reader/components/TechDocsReaderPage/useExternalRedirect.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect, useRef } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport useAsync from 'react-use/esm/useAsync';\nimport { useApi, useRouteRef } from '@backstage/core-plugin-api';\nimport { catalogApiRef } from '@backstage/plugin-catalog-react';\nimport {\n  CompoundEntityRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { buildTechDocsURL } from '@backstage/plugin-techdocs-react';\nimport { TECHDOCS_EXTERNAL_ANNOTATION } from '@backstage/plugin-techdocs-common';\nimport { rootDocsRouteRef } from '../../../routes';\n\n/**\n * Hook to handle external TechDocs redirects based on entity annotations.\n * Checks if an entity has the `backstage.io/techdocs-entity` annotation and\n * redirects to the external TechDocs URL if present.\n *\n * @param entityRef - The entity reference to check for external redirects\n * @returns Object containing loading state and whether a redirect is in progress\n *\n * @internal\n */\nexport function useExternalRedirect(entityRef: CompoundEntityRef): {\n  loading: boolean;\n  shouldShowProgress: boolean;\n} {\n  const catalogApi = useApi(catalogApiRef);\n  const navigate = useNavigate();\n  const viewTechdocLink = useRouteRef(rootDocsRouteRef);\n\n  // Create a stable string key for the entity to use as a dependency.\n  // This ensures the useAsync hook only re-runs when the entity changes,\n  // preventing redundant API calls during sub-page navigation within the same entity's documentation.\n  const entityKey = stringifyEntityRef(entityRef);\n  // Track which entity we've already checked to avoid redundant checks\n  // when navigating between pages within the same entity's documentation.\n  const checkedEntityRef = useRef<string | null>(null);\n  const shouldCheckForRedirect = checkedEntityRef.current !== entityKey;\n\n  // Check if this entity should redirect to external TechDocs\n  const externalRedirectResult = useAsync(async () => {\n    try {\n      const catalogEntity = await catalogApi.getEntityByRef(entityRef);\n\n      if (\n        catalogEntity?.metadata?.annotations?.[TECHDOCS_EXTERNAL_ANNOTATION]\n      ) {\n        return buildTechDocsURL(catalogEntity, viewTechdocLink);\n      }\n    } catch (error) {\n      // Ignore errors and allow the current entity's TechDocs to load.\n      // This handles cases where the catalog API is unavailable or the entity doesn't exist.\n    }\n\n    return undefined;\n  }, [entityKey, catalogApi]);\n\n  useEffect(() => {\n    // Navigate to external TechDocs if a redirect URL is available\n    if (!externalRedirectResult.loading && externalRedirectResult.value) {\n      navigate(externalRedirectResult.value, { replace: true });\n    }\n\n    // Mark entity as checked once we've determined there's no redirect needed.\n    // This prevents the entire page from unmounting/remounting (showing Progress spinner)\n    // on subsequent sub-page navigation within the same entity.\n    if (!externalRedirectResult.loading && !externalRedirectResult.value) {\n      checkedEntityRef.current = entityKey;\n    }\n  }, [\n    externalRedirectResult.loading,\n    externalRedirectResult.value,\n    navigate,\n    entityKey,\n  ]);\n\n  // Determine if we should show a loading indicator (which replaces the entire page with a Progress spinner).\n  // Only show it when: 1) checking a new/unchecked entity, or 2) we have a redirect URL and are navigating.\n  const shouldShowProgress =\n    (shouldCheckForRedirect && externalRedirectResult.loading) ||\n    !!externalRedirectResult.value;\n\n  return {\n    loading: externalRedirectResult.loading,\n    shouldShowProgress,\n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;AAuCO,SAAS,oBAAoB,SAAA,EAGlC;AACA,EAAA,MAAM,UAAA,GAAa,OAAO,aAAa,CAAA;AACvC,EAAA,MAAM,WAAW,WAAA,EAAY;AAC7B,EAAA,MAAM,eAAA,GAAkB,YAAY,gBAAgB,CAAA;AAKpD,EAAA,MAAM,SAAA,GAAY,mBAAmB,SAAS,CAAA;AAG9C,EAAA,MAAM,gBAAA,GAAmB,OAAsB,IAAI,CAAA;AACnD,EAAA,MAAM,sBAAA,GAAyB,iBAAiB,OAAA,KAAY,SAAA;AAG5D,EAAA,MAAM,sBAAA,GAAyB,SAAS,YAAY;AAClD,IAAA,IAAI;AACF,MAAA,MAAM,aAAA,GAAgB,MAAM,UAAA,CAAW,cAAA,CAAe,SAAS,CAAA;AAE/D,MAAA,IACE,aAAA,EAAe,QAAA,EAAU,WAAA,GAAc,4BAA4B,CAAA,EACnE;AACA,QAAA,OAAO,gBAAA,CAAiB,eAAe,eAAe,CAAA;AAAA,MACxD;AAAA,IACF,SAAS,KAAA,EAAO;AAAA,IAGhB;AAEA,IAAA,OAAO,MAAA;AAAA,EACT,CAAA,EAAG,CAAC,SAAA,EAAW,UAAU,CAAC,CAAA;AAE1B,EAAA,SAAA,CAAU,MAAM;AAEd,IAAA,IAAI,CAAC,sBAAA,CAAuB,OAAA,IAAW,sBAAA,CAAuB,KAAA,EAAO;AACnE,MAAA,QAAA,CAAS,sBAAA,CAAuB,KAAA,EAAO,EAAE,OAAA,EAAS,MAAM,CAAA;AAAA,IAC1D;AAKA,IAAA,IAAI,CAAC,sBAAA,CAAuB,OAAA,IAAW,CAAC,uBAAuB,KAAA,EAAO;AACpE,MAAA,gBAAA,CAAiB,OAAA,GAAU,SAAA;AAAA,IAC7B;AAAA,EACF,CAAA,EAAG;AAAA,IACD,sBAAA,CAAuB,OAAA;AAAA,IACvB,sBAAA,CAAuB,KAAA;AAAA,IACvB,QAAA;AAAA,IACA;AAAA,GACD,CAAA;AAID,EAAA,MAAM,qBACH,sBAAA,IAA0B,sBAAA,CAAuB,OAAA,IAClD,CAAC,CAAC,sBAAA,CAAuB,KAAA;AAE3B,EAAA,OAAO;AAAA,IACL,SAAS,sBAAA,CAAuB,OAAA;AAAA,IAChC;AAAA,GACF;AACF;;;;"}