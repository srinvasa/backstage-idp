{"version":3,"file":"FieldFormatEntityPolicy.cjs.js","sources":["../../../src/entity/policies/FieldFormatEntityPolicy.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EntityPolicy } from './types';\nimport {\n  CommonValidatorFunctions,\n  KubernetesValidatorFunctions,\n  makeValidator,\n  Validators,\n} from '../../validation';\nimport { Entity } from '../Entity';\n\n/**\n * Ensures that the format of individual fields of the entity envelope\n * is valid.\n *\n * @remarks\n *\n * This does not take into account machine generated fields such as uid and etag.\n *\n * @public\n */\nexport class FieldFormatEntityPolicy implements EntityPolicy {\n  private readonly validators: Validators;\n\n  constructor(validators: Validators = makeValidator()) {\n    this.validators = validators;\n  }\n\n  async enforce(entity: Entity): Promise<Entity> {\n    function require(\n      field: string,\n      value: any,\n      validator: (value: any) => boolean,\n    ) {\n      if (value === undefined || value === null) {\n        throw new Error(`${field} must have a value`);\n      }\n\n      let isValid: boolean;\n      try {\n        isValid = validator(value);\n      } catch (e) {\n        throw new Error(`${field} could not be validated, ${e}`);\n      }\n\n      if (!isValid) {\n        let expectation;\n        switch (\n          validator.name as\n            | keyof typeof KubernetesValidatorFunctions\n            | keyof typeof CommonValidatorFunctions\n        ) {\n          case 'isValidLabelValue':\n          case 'isValidObjectName':\n            expectation =\n              'a string that is sequences of [a-zA-Z0-9] separated by any of [-_.], at most 63 characters in total';\n            break;\n          case 'isValidLabelKey':\n          case 'isValidApiVersion':\n          case 'isValidAnnotationKey':\n            expectation = 'a valid prefix and/or suffix';\n            break;\n          case 'isValidNamespace':\n          case 'isValidDnsLabel':\n            expectation =\n              'a string that is sequences of [a-z0-9] separated by [-], at most 63 characters in total';\n            break;\n          case 'isValidTag':\n            expectation =\n              'a string that is sequences of [a-z0-9+#] separated by [-], at most 63 characters in total';\n            break;\n          case 'isValidAnnotationValue':\n            expectation = 'a string';\n            break;\n          case 'isValidKind':\n            expectation =\n              'a string that is a sequence of [a-zA-Z][a-z0-9A-Z], at most 63 characters in total';\n            break;\n          case 'isValidUrl':\n            expectation = 'a string that is a valid url';\n            break;\n          case 'isValidString':\n          case 'isNonEmptyString':\n            expectation = 'a non empty string';\n            break;\n          default:\n            expectation = undefined;\n            break;\n        }\n\n        // ensure that if there are other/future validators, the error message defaults to a general \"is not valid, visit link\"\n        const message = expectation\n          ? ` expected ${expectation} but found \"${value}\".`\n          : '';\n\n        throw new Error(\n          `\"${field}\" is not valid;${message} To learn more about catalog file format, visit: https://github.com/backstage/backstage/blob/master/docs/architecture-decisions/adr002-default-catalog-file-format.md`,\n        );\n      }\n    }\n\n    function optional(\n      field: string,\n      value: any,\n      validator: (value: any) => boolean,\n    ) {\n      return value === undefined || require(field, value, validator);\n    }\n\n    require('apiVersion', entity.apiVersion, this.validators.isValidApiVersion);\n    require('kind', entity.kind, this.validators.isValidKind);\n\n    require('metadata.name', entity.metadata.name, this.validators\n      .isValidEntityName);\n    optional(\n      'metadata.namespace',\n      entity.metadata.namespace,\n      this.validators.isValidNamespace,\n    );\n\n    for (const [k, v] of Object.entries(entity.metadata.labels ?? [])) {\n      require(`labels.${k}`, k, this.validators.isValidLabelKey);\n      require(`labels.${k}`, v, this.validators.isValidLabelValue);\n    }\n\n    for (const [k, v] of Object.entries(entity.metadata.annotations ?? [])) {\n      require(`annotations.${k}`, k, this.validators.isValidAnnotationKey);\n      require(`annotations.${k}`, v, this.validators.isValidAnnotationValue);\n    }\n\n    const tags = entity.metadata.tags ?? [];\n\n    for (let i = 0; i < tags.length; ++i) {\n      require(`tags.${i}`, tags[i], this.validators.isValidTag);\n    }\n\n    const links = entity.metadata.links ?? [];\n\n    for (let i = 0; i < links.length; ++i) {\n      require(`links.${i}.url`, links[i]\n        ?.url, CommonValidatorFunctions.isValidUrl);\n      optional(\n        `links.${i}.title`,\n        links[i]?.title,\n        CommonValidatorFunctions.isNonEmptyString,\n      );\n      optional(\n        `links.${i}.icon`,\n        links[i]?.icon,\n        CommonValidatorFunctions.isNonEmptyString,\n      );\n    }\n\n    return entity;\n  }\n}\n"],"names":["makeValidator","CommonValidatorFunctions"],"mappings":"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"}