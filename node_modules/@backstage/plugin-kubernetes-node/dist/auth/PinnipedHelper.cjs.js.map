{"version":3,"file":"PinnipedHelper.cjs.js","sources":["../../src/auth/PinnipedHelper.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { LoggerService } from '@backstage/backend-plugin-api';\nimport * as https from 'https';\nimport fetch, { RequestInit } from 'node-fetch';\nimport { ClusterDetails } from '../types/types';\n\n/**\n *\n * @public\n */\nexport type PinnipedClientCerts = {\n  key: string;\n  cert: string;\n  expirationTimestamp: string;\n};\n\n/**\n *\n * @public\n */\nexport type PinnipedParameters = {\n  clusterScopedIdToken: string;\n  authenticator: {\n    apiGroup: string;\n    kind: string;\n    name: string;\n  };\n  tokenCredentialRequest?: {\n    apiGroup?: string;\n  };\n};\n\n/**\n *\n * @public\n */\nexport class PinnipedHelper {\n  private readonly logger: LoggerService;\n\n  constructor(logger: LoggerService) {\n    this.logger = logger;\n  }\n\n  public async tokenCredentialRequest(\n    clusterDetails: ClusterDetails,\n    pinnipedParams: PinnipedParameters,\n  ): Promise<PinnipedClientCerts> {\n    this.logger.debug('Pinniped: Requesting client Certs to Concierge');\n    return await this.exchangeClusterTokentoClientCerts(\n      clusterDetails,\n      pinnipedParams,\n    );\n  }\n\n  private async exchangeClusterTokentoClientCerts(\n    clusterDetails: ClusterDetails,\n    pinnipedParams: PinnipedParameters,\n  ): Promise<PinnipedClientCerts> {\n    const url: URL = new URL(clusterDetails.url);\n    const apiGroup =\n      pinnipedParams.tokenCredentialRequest?.apiGroup ??\n      'login.concierge.pinniped.dev/v1alpha1';\n\n    url.pathname = `/apis/${apiGroup}/tokencredentialrequests`;\n\n    const requestInit = await this.buildRequestForPinniped(\n      url,\n      clusterDetails,\n      pinnipedParams,\n    );\n\n    this.logger.info(\n      'Fetching client certs for mTLS authentication on Pinniped',\n    );\n    let response;\n    try {\n      response = await fetch(url, requestInit);\n    } catch (error) {\n      this.logger.error('Pinniped request error', error);\n      throw error;\n    }\n\n    const data: any = await response.json();\n\n    if (data.status.credential) {\n      const result = {\n        key: data.status.credential.clientKeyData,\n        cert: data.status.credential.clientCertificateData,\n        expirationTimestamp: data.status.credential.expirationTimestamp,\n      };\n      return Promise.resolve(result);\n    }\n\n    this.logger.error('Unable to fetch client certs,', data.status);\n    return Promise.reject(data.status.message);\n  }\n\n  private async buildRequestForPinniped(\n    url: URL,\n    clusterDetails: ClusterDetails,\n    pinnipedParams: PinnipedParameters,\n  ): Promise<fetch.RequestInit> {\n    const { bufferFromFileOrString } = await import('@kubernetes/client-node');\n\n    const body = {\n      apiVersion:\n        pinnipedParams.tokenCredentialRequest?.apiGroup ??\n        'login.concierge.pinniped.dev/v1alpha1',\n      kind: 'TokenCredentialRequest',\n      spec: {\n        authenticator: pinnipedParams.authenticator,\n        token: pinnipedParams.clusterScopedIdToken,\n      },\n    };\n    const requestInit: RequestInit = {\n      method: 'POST',\n      headers: {\n        Accept: 'application/json',\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(body),\n    };\n\n    if (url.protocol === 'https:') {\n      requestInit.agent = new https.Agent({\n        ca:\n          bufferFromFileOrString(\n            clusterDetails.caFile,\n            clusterDetails.caData,\n          ) ?? undefined,\n        rejectUnauthorized: !clusterDetails.skipTLSVerify,\n      });\n    }\n\n    return requestInit;\n  }\n}\n"],"names":["fetch","https"],"mappings":"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"}