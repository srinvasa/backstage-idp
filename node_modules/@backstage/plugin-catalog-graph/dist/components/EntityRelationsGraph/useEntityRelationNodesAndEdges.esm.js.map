{"version":3,"file":"useEntityRelationNodesAndEdges.esm.js","sources":["../../../src/components/EntityRelationsGraph/useEntityRelationNodesAndEdges.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { MouseEvent, useState } from 'react';\nimport useDebounce from 'react-use/esm/useDebounce';\nimport { RelationPairs } from '../../lib/types';\nimport { EntityEdge, EntityNode } from '../../lib/types';\nimport { useEntityRelationGraph } from './useEntityRelationGraph';\nimport { Entity, DEFAULT_NAMESPACE } from '@backstage/catalog-model';\nimport { useRelations } from '../../hooks/useRelations';\nimport { buildGraph } from '../../lib/graph';\nimport {\n  BuiltInTransformations,\n  builtInTransformations,\n  GraphTransformer,\n  TransformationContext,\n} from '../../lib/graph-transformations';\n\n/**\n * Generate nodes and edges to render the entity graph.\n */\nexport function useEntityRelationNodesAndEdges({\n  rootEntityRefs,\n  maxDepth = Number.POSITIVE_INFINITY,\n  unidirectional = true,\n  mergeRelations = true,\n  kinds,\n  relations,\n  entityFilter,\n  onNodeClick,\n  relationPairs: incomingRelationPairs,\n}: {\n  rootEntityRefs: string[];\n  maxDepth?: number;\n  unidirectional?: boolean;\n  mergeRelations?: boolean;\n  kinds?: string[];\n  relations?: string[];\n  entityFilter?: (entity: Entity) => boolean;\n  onNodeClick?: (value: EntityNode, event: MouseEvent<unknown>) => void;\n  relationPairs?: RelationPairs;\n}): {\n  loading: boolean;\n  nodes?: EntityNode[];\n  edges?: EntityEdge[];\n  error?: Error;\n} {\n  const [nodesAndEdges, setNodesAndEdges] = useState<{\n    nodes?: EntityNode[];\n    edges?: EntityEdge[];\n  }>({});\n  const { entities, loading, error } = useEntityRelationGraph({\n    rootEntityRefs,\n    filter: {\n      maxDepth,\n      kinds,\n      relations,\n      entityFilter,\n    },\n  });\n\n  const { relationPairs, includeRelation } = useRelations({\n    relations,\n    relationPairs: incomingRelationPairs,\n  });\n\n  useDebounce(\n    () => {\n      if (!entities || Object.keys(entities).length === 0) {\n        setNodesAndEdges({});\n        return;\n      }\n\n      const nodes = Object.entries(entities).map(([entityRef, entity]) => {\n        const focused = rootEntityRefs.includes(entityRef);\n        const node: EntityNode = {\n          id: entityRef,\n          entity,\n          focused,\n          color: focused ? 'secondary' : 'primary',\n          // @deprecated\n          kind: entity.kind,\n          name: entity.metadata.name,\n          namespace: entity.metadata.namespace || DEFAULT_NAMESPACE,\n          title: entity.metadata.title,\n          spec: entity.spec,\n        };\n\n        if (onNodeClick) {\n          node.onClick = event => onNodeClick(node, event);\n        }\n\n        return node;\n      });\n\n      const edges = buildGraph({\n        rootEntityRefs,\n        entities,\n        includeRelation,\n        kinds,\n        mergeRelations,\n        relationPairs,\n        unidirectional,\n      });\n\n      const transformationContext: TransformationContext = {\n        nodeDistances: new Map(),\n        edges,\n        nodes,\n\n        rootEntityRefs,\n        unidirectional,\n        maxDepth,\n      };\n\n      const runTransformation = (\n        transformation: BuiltInTransformations | GraphTransformer,\n      ) => {\n        if (typeof transformation === 'function') {\n          transformation(transformationContext);\n        } else {\n          builtInTransformations[transformation](transformationContext);\n        }\n      };\n\n      runTransformation('reduce-edges');\n      runTransformation('set-distances');\n      if (unidirectional) {\n        runTransformation('strip-distant-edges');\n      }\n      if (mergeRelations || unidirectional) {\n        // Merge relations even if only unidirectional, the next transformer\n        // 'remove-backward-edges' needs to know about all relations before it\n        // strips away the backward ones\n        runTransformation('merge-relations');\n      }\n      if (unidirectional && !mergeRelations) {\n        runTransformation('order-forward');\n        runTransformation('remove-backward-edges');\n      }\n\n      setNodesAndEdges({\n        nodes: transformationContext.nodes,\n        edges: transformationContext.edges,\n      });\n    },\n    100,\n    [\n      maxDepth,\n      entities,\n      rootEntityRefs,\n      kinds,\n      includeRelation,\n      unidirectional,\n      mergeRelations,\n      onNodeClick,\n      relationPairs,\n    ],\n  );\n\n  return {\n    loading,\n    error,\n    ...nodesAndEdges,\n  };\n}\n"],"names":[],"mappings":"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"}