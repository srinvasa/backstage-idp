{"version":3,"file":"pod.esm.js","sources":["../../src/utils/pod.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type {\n  V1Pod,\n  V1PodCondition,\n  V1DeploymentCondition,\n} from '@kubernetes/client-node';\nimport { Fragment, ReactNode } from 'react';\nimport Chip from '@material-ui/core/Chip';\nimport {\n  StatusAborted,\n  StatusError,\n  StatusOK,\n  SubvalueCell,\n} from '@backstage/core-components';\nimport { ClientPodStatus } from '@backstage/plugin-kubernetes-common';\nimport { Pod } from 'kubernetes-models/v1/Pod';\nimport { bytesToMiB, formatMillicores } from './resources';\n\nexport const imageChips = (pod: V1Pod): ReactNode => {\n  const containerStatuses = pod.status?.containerStatuses ?? [];\n  const images = containerStatuses.map((cs, i) => {\n    return <Chip key={i} label={`${cs.name}=${cs.image}`} size=\"small\" />;\n  });\n\n  return <div>{images}</div>;\n};\n\nexport const containersReady = (pod: Pod): string => {\n  const containerStatuses = pod.status?.containerStatuses ?? [];\n  const containersReadyItem = containerStatuses.filter(cs => cs.ready).length;\n\n  return `${containersReadyItem}/${containerStatuses.length}`;\n};\n\nexport const totalRestarts = (pod: Pod): number => {\n  const containerStatuses = pod.status?.containerStatuses ?? [];\n  return containerStatuses?.reduce((a, b) => a + b.restartCount, 0);\n};\n\nexport const containerStatuses = (pod: Pod): ReactNode => {\n  const containerStatusesItem = pod.status?.containerStatuses ?? [];\n  const errors = containerStatusesItem.reduce((accum, next) => {\n    if (next.state === undefined) {\n      return accum;\n    }\n\n    const waiting = next.state.waiting;\n    const terminated = next.state.terminated;\n\n    const renderCell = (reason: string | undefined) => (\n      <Fragment key={`${pod.metadata?.name}-${next.name}`}>\n        <SubvalueCell\n          value={\n            reason === 'Completed' ? (\n              <StatusOK>Container: {next.name}</StatusOK>\n            ) : (\n              <StatusError>Container: {next.name}</StatusError>\n            )\n          }\n          subvalue={reason}\n        />\n        <br />\n      </Fragment>\n    );\n\n    if (waiting) {\n      accum.push(renderCell(waiting.reason));\n    }\n\n    if (terminated) {\n      accum.push(renderCell(terminated.reason));\n    }\n\n    return accum;\n  }, [] as ReactNode[]);\n\n  if (errors.length === 0) {\n    return <StatusOK>OK</StatusOK>;\n  }\n\n  return errors;\n};\n\nexport const renderCondition = (\n  condition: V1PodCondition | V1DeploymentCondition,\n): [string, ReactNode] => {\n  const status = condition.status;\n\n  if (status === 'True') {\n    return [condition.type, <StatusOK>True</StatusOK>];\n  } else if (status === 'False') {\n    return [\n      condition.type,\n      <SubvalueCell\n        value={<StatusError>False</StatusError>}\n        subvalue={condition.message ?? ''}\n      />,\n    ];\n  }\n  return [condition.type, <StatusAborted />];\n};\n\n// visible for testing\nexport const currentToDeclaredResourceToPerc = (\n  current: number | string,\n  resource: number | string,\n): string => {\n  if (Number(resource) === 0) return `0%`;\n\n  if (typeof current === 'number' && typeof resource === 'number') {\n    return `${Math.round((current / resource) * 100)}%`;\n  }\n\n  const numerator: bigint = BigInt(\n    typeof current === 'number' ? Math.round(current) : Number(current),\n  );\n  const denominator: bigint = BigInt(\n    typeof resource === 'number' ? Math.round(resource) : Number(resource),\n  );\n\n  return `${(numerator * BigInt(100)) / denominator}%`;\n};\n\nexport const podStatusToCpuUtil = (podStatus: ClientPodStatus): ReactNode => {\n  const cpuUtil = podStatus.cpu;\n\n  return (\n    <SubvalueCell\n      value={`requests: ${currentToDeclaredResourceToPerc(\n        cpuUtil.currentUsage,\n        cpuUtil.requestTotal,\n      )} of ${formatMillicores(cpuUtil.requestTotal)}`}\n      subvalue={`limits: ${currentToDeclaredResourceToPerc(\n        cpuUtil.currentUsage,\n        cpuUtil.limitTotal,\n      )} of ${formatMillicores(cpuUtil.limitTotal)}`}\n    />\n  );\n};\n\nexport const podStatusToMemoryUtil = (\n  podStatus: ClientPodStatus,\n): ReactNode => {\n  const memUtil = podStatus.memory;\n\n  return (\n    <SubvalueCell\n      value={`requests: ${currentToDeclaredResourceToPerc(\n        memUtil.currentUsage,\n        memUtil.requestTotal,\n      )} of ${bytesToMiB(memUtil.requestTotal)}`}\n      subvalue={`limits: ${currentToDeclaredResourceToPerc(\n        memUtil.currentUsage,\n        memUtil.limitTotal,\n      )} of ${bytesToMiB(memUtil.limitTotal)}`}\n    />\n  );\n};\n"],"names":["containerStatuses"],"mappings":";;;;;;AA0CO,MAAM,eAAA,GAAkB,CAAC,GAAA,KAAqB;AACnD,EAAA,MAAMA,kBAAAA,GAAoB,GAAA,CAAI,MAAA,EAAQ,iBAAA,IAAqB,EAAC;AAC5D,EAAA,MAAM,sBAAsBA,kBAAAA,CAAkB,MAAA,CAAO,CAAA,EAAA,KAAM,EAAA,CAAG,KAAK,CAAA,CAAE,MAAA;AAErE,EAAA,OAAO,CAAA,EAAG,mBAAmB,CAAA,CAAA,EAAIA,kBAAAA,CAAkB,MAAM,CAAA,CAAA;AAC3D;AAEO,MAAM,aAAA,GAAgB,CAAC,GAAA,KAAqB;AACjD,EAAA,MAAMA,kBAAAA,GAAoB,GAAA,CAAI,MAAA,EAAQ,iBAAA,IAAqB,EAAC;AAC5D,EAAA,OAAOA,kBAAAA,EAAmB,OAAO,CAAC,CAAA,EAAG,MAAM,CAAA,GAAI,CAAA,CAAE,cAAc,CAAC,CAAA;AAClE;AAEO,MAAM,iBAAA,GAAoB,CAAC,GAAA,KAAwB;AACxD,EAAA,MAAM,qBAAA,GAAwB,GAAA,CAAI,MAAA,EAAQ,iBAAA,IAAqB,EAAC;AAChE,EAAA,MAAM,MAAA,GAAS,qBAAA,CAAsB,MAAA,CAAO,CAAC,OAAO,IAAA,KAAS;AAC3D,IAAA,IAAI,IAAA,CAAK,UAAU,MAAA,EAAW;AAC5B,MAAA,OAAO,KAAA;AAAA,IACT;AAEA,IAAA,MAAM,OAAA,GAAU,KAAK,KAAA,CAAM,OAAA;AAC3B,IAAA,MAAM,UAAA,GAAa,KAAK,KAAA,CAAM,UAAA;AAE9B,IAAA,MAAM,UAAA,GAAa,CAAC,MAAA,qBAClB,IAAA,CAAC,QAAA,EAAA,EACC,QAAA,EAAA;AAAA,sBAAA,GAAA;AAAA,QAAC,YAAA;AAAA,QAAA;AAAA,UACC,KAAA,EACE,MAAA,KAAW,WAAA,mBACT,IAAA,CAAC,QAAA,EAAA,EAAS,QAAA,EAAA;AAAA,YAAA,aAAA;AAAA,YAAY,IAAA,CAAK;AAAA,WAAA,EAAK,CAAA,wBAE/B,WAAA,EAAA,EAAY,QAAA,EAAA;AAAA,YAAA,aAAA;AAAA,YAAY,IAAA,CAAK;AAAA,WAAA,EAAK,CAAA;AAAA,UAGvC,QAAA,EAAU;AAAA;AAAA,OACZ;AAAA,0BACC,IAAA,EAAA,EAAG;AAAA,KAAA,EAAA,EAXS,GAAG,GAAA,CAAI,QAAA,EAAU,IAAI,CAAA,CAAA,EAAI,IAAA,CAAK,IAAI,CAAA,CAYjD,CAAA;AAGF,IAAA,IAAI,OAAA,EAAS;AACX,MAAA,KAAA,CAAM,IAAA,CAAK,UAAA,CAAW,OAAA,CAAQ,MAAM,CAAC,CAAA;AAAA,IACvC;AAEA,IAAA,IAAI,UAAA,EAAY;AACd,MAAA,KAAA,CAAM,IAAA,CAAK,UAAA,CAAW,UAAA,CAAW,MAAM,CAAC,CAAA;AAAA,IAC1C;AAEA,IAAA,OAAO,KAAA;AAAA,EACT,CAAA,EAAG,EAAiB,CAAA;AAEpB,EAAA,IAAI,MAAA,CAAO,WAAW,CAAA,EAAG;AACvB,IAAA,uBAAO,GAAA,CAAC,YAAS,QAAA,EAAA,IAAA,EAAE,CAAA;AAAA,EACrB;AAEA,EAAA,OAAO,MAAA;AACT;AAEO,MAAM,eAAA,GAAkB,CAC7B,SAAA,KACwB;AACxB,EAAA,MAAM,SAAS,SAAA,CAAU,MAAA;AAEzB,EAAA,IAAI,WAAW,MAAA,EAAQ;AACrB,IAAA,OAAO,CAAC,SAAA,CAAU,IAAA,kBAAM,GAAA,CAAC,QAAA,EAAA,EAAS,kBAAI,CAAW,CAAA;AAAA,EACnD,CAAA,MAAA,IAAW,WAAW,OAAA,EAAS;AAC7B,IAAA,OAAO;AAAA,MACL,SAAA,CAAU,IAAA;AAAA,sBACV,GAAA;AAAA,QAAC,YAAA;AAAA,QAAA;AAAA,UACC,KAAA,kBAAO,GAAA,CAAC,WAAA,EAAA,EAAY,QAAA,EAAA,OAAA,EAAK,CAAA;AAAA,UACzB,QAAA,EAAU,UAAU,OAAA,IAAW;AAAA;AAAA;AACjC,KACF;AAAA,EACF;AACA,EAAA,OAAO,CAAC,SAAA,CAAU,IAAA,kBAAM,GAAA,CAAC,iBAAc,CAAE,CAAA;AAC3C;AAGO,MAAM,+BAAA,GAAkC,CAC7C,OAAA,EACA,QAAA,KACW;AACX,EAAA,IAAI,MAAA,CAAO,QAAQ,CAAA,KAAM,CAAA,EAAG,OAAO,CAAA,EAAA,CAAA;AAEnC,EAAA,IAAI,OAAO,OAAA,KAAY,QAAA,IAAY,OAAO,aAAa,QAAA,EAAU;AAC/D,IAAA,OAAO,GAAG,IAAA,CAAK,KAAA,CAAO,OAAA,GAAU,QAAA,GAAY,GAAG,CAAC,CAAA,CAAA,CAAA;AAAA,EAClD;AAEA,EAAA,MAAM,SAAA,GAAoB,MAAA;AAAA,IACxB,OAAO,YAAY,QAAA,GAAW,IAAA,CAAK,MAAM,OAAO,CAAA,GAAI,OAAO,OAAO;AAAA,GACpE;AACA,EAAA,MAAM,WAAA,GAAsB,MAAA;AAAA,IAC1B,OAAO,aAAa,QAAA,GAAW,IAAA,CAAK,MAAM,QAAQ,CAAA,GAAI,OAAO,QAAQ;AAAA,GACvE;AAEA,EAAA,OAAO,CAAA,EAAI,SAAA,GAAY,MAAA,CAAO,GAAG,IAAK,WAAW,CAAA,CAAA,CAAA;AACnD;AAEO,MAAM,kBAAA,GAAqB,CAAC,SAAA,KAA0C;AAC3E,EAAA,MAAM,UAAU,SAAA,CAAU,GAAA;AAE1B,EAAA,uBACE,GAAA;AAAA,IAAC,YAAA;AAAA,IAAA;AAAA,MACC,OAAO,CAAA,UAAA,EAAa,+BAAA;AAAA,QAClB,OAAA,CAAQ,YAAA;AAAA,QACR,OAAA,CAAQ;AAAA,OACT,CAAA,IAAA,EAAO,gBAAA,CAAiB,OAAA,CAAQ,YAAY,CAAC,CAAA,CAAA;AAAA,MAC9C,UAAU,CAAA,QAAA,EAAW,+BAAA;AAAA,QACnB,OAAA,CAAQ,YAAA;AAAA,QACR,OAAA,CAAQ;AAAA,OACT,CAAA,IAAA,EAAO,gBAAA,CAAiB,OAAA,CAAQ,UAAU,CAAC,CAAA;AAAA;AAAA,GAC9C;AAEJ;AAEO,MAAM,qBAAA,GAAwB,CACnC,SAAA,KACc;AACd,EAAA,MAAM,UAAU,SAAA,CAAU,MAAA;AAE1B,EAAA,uBACE,GAAA;AAAA,IAAC,YAAA;AAAA,IAAA;AAAA,MACC,OAAO,CAAA,UAAA,EAAa,+BAAA;AAAA,QAClB,OAAA,CAAQ,YAAA;AAAA,QACR,OAAA,CAAQ;AAAA,OACT,CAAA,IAAA,EAAO,UAAA,CAAW,OAAA,CAAQ,YAAY,CAAC,CAAA,CAAA;AAAA,MACxC,UAAU,CAAA,QAAA,EAAW,+BAAA;AAAA,QACnB,OAAA,CAAQ,YAAA;AAAA,QACR,OAAA,CAAQ;AAAA,OACT,CAAA,IAAA,EAAO,UAAA,CAAW,OAAA,CAAQ,UAAU,CAAC,CAAA;AAAA;AAAA,GACxC;AAEJ;;;;"}