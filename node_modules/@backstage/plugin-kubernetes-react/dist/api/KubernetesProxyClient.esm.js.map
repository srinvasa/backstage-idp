{"version":3,"file":"KubernetesProxyClient.esm.js","sources":["../../src/api/KubernetesProxyClient.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { KubernetesApi } from './types';\nimport { Event } from 'kubernetes-models/v1';\n\n/**\n * A client for common requests through the proxy endpoint of the kubernetes backend plugin.\n *\n * @public\n */\nexport class KubernetesProxyClient {\n  private readonly kubernetesApi: KubernetesApi;\n\n  constructor(options: { kubernetesApi: KubernetesApi }) {\n    this.kubernetesApi = options.kubernetesApi;\n  }\n\n  private async handleText(response: Response): Promise<string> {\n    if (!response.ok) {\n      const payload = await response.text();\n      let message;\n      switch (response.status) {\n        default:\n          message = `Proxy request failed with ${response.status} ${response.statusText}, ${payload}`;\n      }\n      throw new Error(message);\n    }\n\n    return await response.text();\n  }\n\n  private async handleJson(response: Response): Promise<any> {\n    if (!response.ok) {\n      const payload = await response.text();\n      let message = `Request failed with ${response.status} ${response.statusText}, ${payload}`;\n      switch (response.status) {\n        case 404:\n          message = `Proxy request failed with ${response.status} ${response.statusText}, ${payload}`;\n          break;\n        default:\n          message = `Request failed with ${response.status} ${response.statusText}, ${payload}`;\n      }\n      throw new Error(message);\n    }\n\n    return await response.json();\n  }\n\n  async getEventsByInvolvedObjectName({\n    clusterName,\n    involvedObjectName,\n    namespace,\n  }: {\n    clusterName: string;\n    involvedObjectName: string;\n    namespace: string;\n  }): Promise<Event[]> {\n    return await this.kubernetesApi\n      .proxy({\n        clusterName,\n        path: `/api/v1/namespaces/${namespace}/events?fieldSelector=involvedObject.name=${involvedObjectName}`,\n        init: {\n          method: 'GET',\n        },\n      })\n      .then(response => this.handleJson(response))\n      .then(eventList => eventList.items);\n  }\n\n  async getPodLogs({\n    podName,\n    namespace,\n    clusterName,\n    containerName,\n    previous,\n  }: {\n    podName: string;\n    namespace: string;\n    clusterName: string;\n    containerName: string;\n    previous?: boolean;\n  }): Promise<{ text: string }> {\n    const params = new URLSearchParams({\n      container: containerName,\n    });\n    if (previous) {\n      params.append('previous', '');\n    }\n    return await this.kubernetesApi\n      .proxy({\n        clusterName: clusterName,\n        path: `/api/v1/namespaces/${namespace}/pods/${podName}/log?${params.toString()}`,\n        init: {\n          method: 'GET',\n        },\n      })\n      .then(response => this.handleText(response))\n      .then(text => ({ text }));\n  }\n\n  async deletePod({\n    podName,\n    namespace,\n    clusterName,\n  }: {\n    podName: string;\n    namespace: string;\n    clusterName: string;\n  }): Promise<{ text: string }> {\n    return await this.kubernetesApi\n      .proxy({\n        clusterName: clusterName,\n        path: `/api/v1/namespaces/${namespace}/pods/${podName}`,\n        init: {\n          method: 'DELETE',\n        },\n      })\n      .then(response => this.handleText(response))\n      .then(text => ({ text }));\n  }\n}\n"],"names":[],"mappings":"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"}