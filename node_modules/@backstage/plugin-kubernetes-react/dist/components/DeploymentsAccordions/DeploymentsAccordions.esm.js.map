{"version":3,"file":"DeploymentsAccordions.esm.js","sources":["../../../src/components/DeploymentsAccordions/DeploymentsAccordions.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ReactNode, useContext } from 'react';\nimport Accordion from '@material-ui/core/Accordion';\nimport AccordionDetails from '@material-ui/core/AccordionDetails';\nimport AccordionSummary from '@material-ui/core/AccordionSummary';\nimport Grid from '@material-ui/core/Grid';\nimport Typography from '@material-ui/core/Typography';\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\nimport type {\n  V1Deployment,\n  V1Pod,\n  V2HorizontalPodAutoscaler,\n} from '@kubernetes/client-node';\nimport { PodsTable } from '../Pods';\nimport { DeploymentDrawer } from './DeploymentDrawer';\nimport { HorizontalPodAutoscalerDrawer } from '../HorizontalPodAutoscalers';\nimport {\n  getOwnedPodsThroughReplicaSets,\n  getMatchingHpa,\n} from '../../utils/owner';\nimport {\n  GroupedResponsesContext,\n  PodNamesWithErrorsContext,\n} from '../../hooks';\nimport { StatusError, StatusOK } from '@backstage/core-components';\nimport { READY_COLUMNS, RESOURCE_COLUMNS } from '../Pods/PodsTable';\n\ntype DeploymentsAccordionsProps = {\n  children?: ReactNode;\n};\n\ntype DeploymentAccordionProps = {\n  deployment: V1Deployment;\n  ownedPods: V1Pod[];\n  matchingHpa?: V2HorizontalPodAutoscaler;\n  children?: ReactNode;\n};\n\ntype DeploymentSummaryProps = {\n  deployment: V1Deployment;\n  numberOfCurrentPods: number;\n  numberOfPodsWithErrors: number;\n  hpa?: V2HorizontalPodAutoscaler;\n  children?: ReactNode;\n};\n\nconst DeploymentSummary = ({\n  deployment,\n  numberOfCurrentPods,\n  numberOfPodsWithErrors,\n  hpa,\n}: DeploymentSummaryProps) => {\n  const specCpuUtil = hpa?.spec?.metrics?.find(\n    metric => metric.type === 'Resource' && metric.resource?.name === 'cpu',\n  )?.resource?.target.averageUtilization;\n\n  const cpuUtil = hpa?.status?.currentMetrics?.find(\n    metric => metric.type === 'Resource' && metric.resource?.name === 'cpu',\n  )?.resource?.current.averageUtilization;\n\n  return (\n    <Grid\n      container\n      direction=\"row\"\n      justifyContent=\"space-between\"\n      alignItems=\"center\"\n      spacing={0}\n    >\n      <Grid xs={4} item>\n        <DeploymentDrawer deployment={deployment} />\n      </Grid>\n      {hpa && (\n        <Grid item xs={4}>\n          <HorizontalPodAutoscalerDrawer hpa={hpa}>\n            <Grid\n              item\n              container\n              direction=\"column\"\n              justifyContent=\"flex-start\"\n              alignItems=\"flex-start\"\n              spacing={0}\n            >\n              <Grid item>\n                <Typography variant=\"subtitle2\">\n                  min replicas {hpa.spec?.minReplicas ?? '?'} / max replicas{' '}\n                  {hpa.spec?.maxReplicas ?? '?'}\n                </Typography>\n              </Grid>\n              <Grid item>\n                <Typography variant=\"subtitle2\">\n                  current CPU usage: {cpuUtil ?? '?'}%\n                </Typography>\n              </Grid>\n              <Grid item>\n                <Typography variant=\"subtitle2\">\n                  target CPU usage: {specCpuUtil ?? '?'}%\n                </Typography>\n              </Grid>\n            </Grid>\n          </HorizontalPodAutoscalerDrawer>\n        </Grid>\n      )}\n      <Grid\n        item\n        container\n        xs={4}\n        direction=\"column\"\n        justifyContent=\"flex-start\"\n        alignItems=\"flex-end\"\n        spacing={0}\n      >\n        <Grid item>\n          <StatusOK>{numberOfCurrentPods} pods</StatusOK>\n        </Grid>\n        <Grid item>\n          {numberOfPodsWithErrors > 0 ? (\n            <StatusError>\n              {numberOfPodsWithErrors} pod\n              {numberOfPodsWithErrors > 1 ? 's' : ''} with errors\n            </StatusError>\n          ) : (\n            <StatusOK>No pods with errors</StatusOK>\n          )}\n        </Grid>\n      </Grid>\n    </Grid>\n  );\n};\n\nconst DeploymentAccordion = ({\n  deployment,\n  ownedPods,\n  matchingHpa,\n}: DeploymentAccordionProps) => {\n  const podNamesWithErrors = useContext(PodNamesWithErrorsContext);\n\n  const podsWithErrors = ownedPods.filter(p =>\n    podNamesWithErrors.has(p.metadata?.name ?? ''),\n  );\n\n  return (\n    <Accordion TransitionProps={{ unmountOnExit: true }} variant=\"outlined\">\n      <AccordionSummary expandIcon={<ExpandMoreIcon />}>\n        <DeploymentSummary\n          deployment={deployment}\n          numberOfCurrentPods={ownedPods.length}\n          numberOfPodsWithErrors={podsWithErrors.length}\n          hpa={matchingHpa}\n        />\n      </AccordionSummary>\n      <AccordionDetails>\n        <PodsTable\n          pods={ownedPods}\n          extraColumns={[READY_COLUMNS, RESOURCE_COLUMNS]}\n        />\n      </AccordionDetails>\n    </Accordion>\n  );\n};\n\nexport const DeploymentsAccordions = ({}: DeploymentsAccordionsProps) => {\n  const groupedResponses = useContext(GroupedResponsesContext);\n\n  return (\n    <Grid\n      container\n      direction=\"column\"\n      justifyContent=\"flex-start\"\n      alignItems=\"flex-start\"\n    >\n      {groupedResponses.deployments.map((deployment, i) => (\n        <Grid container item key={i} xs>\n          <Grid item xs>\n            <DeploymentAccordion\n              matchingHpa={getMatchingHpa(\n                {\n                  name: deployment.metadata?.name,\n                  namespace: deployment.metadata?.namespace,\n                  kind: 'deployment',\n                },\n                groupedResponses.horizontalPodAutoscalers,\n              )}\n              ownedPods={getOwnedPodsThroughReplicaSets(\n                deployment,\n                groupedResponses.replicaSets,\n                groupedResponses.pods,\n              )}\n              deployment={deployment}\n            />\n          </Grid>\n        </Grid>\n      ))}\n    </Grid>\n  );\n};\n"],"names":[],"mappings":"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"}