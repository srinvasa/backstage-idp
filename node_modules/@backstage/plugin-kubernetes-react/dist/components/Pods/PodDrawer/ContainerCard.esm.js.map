{"version":3,"file":"ContainerCard.esm.js","sources":["../../../../src/components/Pods/PodDrawer/ContainerCard.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { StructuredMetadataTable } from '@backstage/core-components';\nimport { ClientContainerStatus } from '@backstage/plugin-kubernetes-common';\nimport Card from '@material-ui/core/Card';\nimport CardActions from '@material-ui/core/CardActions';\nimport CardContent from '@material-ui/core/CardContent';\nimport CardHeader from '@material-ui/core/CardHeader';\nimport Grid from '@material-ui/core/Grid';\nimport Typography from '@material-ui/core/Typography';\nimport { IContainer, IContainerStatus } from 'kubernetes-models/v1';\nimport { DateTime } from 'luxon';\nimport { FC } from 'react';\n\nimport { useIsPodExecTerminalEnabled } from '../../../hooks';\nimport { bytesToMiB, formatMillicores } from '../../../utils/resources';\nimport { PodExecTerminalDialog } from '../../PodExecTerminal/PodExecTerminalDialog';\nimport { ResourceUtilization } from '../../ResourceUtilization';\nimport { PodLogsDialog, PodScope } from '../PodLogs';\n\nconst getContainerHealthChecks = (\n  containerSpec: IContainer,\n  containerStatus: IContainerStatus,\n): { [key: string]: boolean } => {\n  const healthCheck = {\n    'not waiting to start': containerStatus.state?.waiting === undefined,\n    'no restarts': containerStatus.restartCount === 0,\n  };\n  if (containerStatus.state?.terminated?.reason === 'Completed') {\n    return healthCheck;\n  }\n  Object.assign(\n    healthCheck,\n    { started: !!containerStatus.started },\n    { ready: containerStatus.ready },\n    { 'readiness probe set': containerSpec?.readinessProbe !== undefined },\n  );\n  if (containerSpec && containerSpec?.livenessProbe !== undefined) {\n    Object.assign(healthCheck, {\n      'liveness probe set': containerSpec.livenessProbe,\n    });\n  }\n  return healthCheck;\n};\n\nconst getCurrentState = (containerStatus: IContainerStatus): string => {\n  return (\n    containerStatus.state?.waiting?.reason ||\n    containerStatus.state?.terminated?.reason ||\n    (containerStatus.state?.running !== undefined ? 'Running' : 'Unknown')\n  );\n};\n\nconst getStartedAtTime = (\n  containerStatus: IContainerStatus,\n): string | undefined => {\n  return (\n    containerStatus.state?.running?.startedAt ||\n    containerStatus.state?.terminated?.startedAt\n  );\n};\n\ninterface ContainerDatetimeProps {\n  prefix: string;\n  dateTime: string;\n}\n\nconst ContainerDatetime = ({ prefix, dateTime }: ContainerDatetimeProps) => {\n  return (\n    <Typography variant=\"subtitle2\">\n      {prefix}:{' '}\n      {DateTime.fromISO(dateTime).toRelative({\n        locale: 'en',\n      })}\n    </Typography>\n  );\n};\n\n/**\n * Props for ContainerCard\n *\n * @public\n */\nexport interface ContainerCardProps {\n  podScope: PodScope;\n  containerSpec?: IContainer;\n  containerStatus: IContainerStatus;\n  containerMetrics?: ClientContainerStatus;\n}\n\n/**\n * Shows details about a container within a pod\n *\n * @public\n */\nexport const ContainerCard: FC<ContainerCardProps> = ({\n  podScope,\n  containerSpec,\n  containerStatus,\n  containerMetrics,\n}: ContainerCardProps) => {\n  const isPodExecTerminalEnabled = useIsPodExecTerminalEnabled();\n\n  // This should never be undefined\n  if (containerSpec === undefined) {\n    return <Typography>error reading pod from cluster</Typography>;\n  }\n  const containerStartedTime = getStartedAtTime(containerStatus);\n  const containerFinishedTime = containerStatus.state?.terminated?.finishedAt;\n\n  return (\n    <Card>\n      <CardHeader\n        title={containerStatus.name}\n        subheader={containerStatus.image}\n      />\n      <CardContent>\n        <Grid container>\n          <Grid item xs={12}>\n            {containerStartedTime && (\n              <ContainerDatetime\n                prefix=\"Started\"\n                dateTime={containerStartedTime}\n              />\n            )}\n            {containerFinishedTime && (\n              <ContainerDatetime\n                prefix=\"Completed\"\n                dateTime={containerFinishedTime}\n              />\n            )}\n            {containerStartedTime && containerFinishedTime && (\n              <Typography variant=\"subtitle2\">\n                Execution time:{' '}\n                {DateTime.fromISO(containerFinishedTime)\n                  .diff(DateTime.fromISO(containerStartedTime), [\n                    'hours',\n                    'minutes',\n                    'seconds',\n                  ])\n                  .toHuman()}\n              </Typography>\n            )}\n          </Grid>\n          <Grid item xs={12}>\n            <Typography variant=\"subtitle2\">\n              Status: {getCurrentState(containerStatus)}\n            </Typography>\n          </Grid>\n          {containerStatus.restartCount > 0 && (\n            <Grid item xs={12}>\n              <Typography variant=\"subtitle2\">\n                Restarts: {containerStatus.restartCount}\n              </Typography>\n            </Grid>\n          )}\n          <Grid item xs={12}>\n            <Typography variant=\"subtitle2\">Container health</Typography>\n          </Grid>\n          <Grid item xs={12}>\n            <StructuredMetadataTable\n              metadata={getContainerHealthChecks(\n                containerSpec,\n                containerStatus,\n              )}\n              options={{ nestedValuesAsYaml: true }}\n            />\n          </Grid>\n          {containerMetrics && (\n            <Grid container item xs={12} spacing={0}>\n              <Grid item xs={12}>\n                <Typography variant=\"subtitle1\">\n                  Resource utilization\n                </Typography>\n              </Grid>\n              <Grid item xs={12} style={{ minHeight: '5rem' }}>\n                <ResourceUtilization\n                  compressed\n                  title=\"CPU requests\"\n                  usage={containerMetrics.cpuUsage.currentUsage}\n                  total={containerMetrics.cpuUsage.requestTotal}\n                  totalFormatted={formatMillicores(\n                    containerMetrics.cpuUsage.requestTotal,\n                  )}\n                />\n                <ResourceUtilization\n                  compressed\n                  title=\"CPU limits\"\n                  usage={containerMetrics.cpuUsage.currentUsage}\n                  total={containerMetrics.cpuUsage.limitTotal}\n                  totalFormatted={formatMillicores(\n                    containerMetrics.cpuUsage.limitTotal,\n                  )}\n                />\n                <ResourceUtilization\n                  compressed\n                  title=\"Memory requests\"\n                  usage={containerMetrics.memoryUsage.currentUsage}\n                  total={containerMetrics.memoryUsage.requestTotal}\n                  totalFormatted={bytesToMiB(\n                    containerMetrics.memoryUsage.requestTotal,\n                  )}\n                />\n                <ResourceUtilization\n                  compressed\n                  title=\"Memory limits\"\n                  usage={containerMetrics.memoryUsage.currentUsage}\n                  total={containerMetrics.memoryUsage.limitTotal}\n                  totalFormatted={bytesToMiB(\n                    containerMetrics.memoryUsage.limitTotal,\n                  )}\n                />\n              </Grid>\n            </Grid>\n          )}\n        </Grid>\n      </CardContent>\n      <CardActions>\n        <PodLogsDialog\n          containerScope={{\n            containerName: containerStatus.name,\n            ...podScope,\n          }}\n        />\n        {isPodExecTerminalEnabled && (\n          <PodExecTerminalDialog\n            cluster={podScope.cluster}\n            containerName={containerStatus.name}\n            podName={podScope.podName}\n            podNamespace={podScope.podNamespace}\n          />\n        )}\n      </CardActions>\n    </Card>\n  );\n};\n"],"names":[],"mappings":"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"}