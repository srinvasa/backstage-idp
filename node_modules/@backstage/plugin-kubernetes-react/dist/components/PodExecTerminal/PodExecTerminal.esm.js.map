{"version":3,"file":"PodExecTerminal.esm.js","sources":["../../../src/components/PodExecTerminal/PodExecTerminal.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport '@xterm/xterm/css/xterm.css';\n\nimport { discoveryApiRef, useApi } from '@backstage/core-plugin-api';\nimport { ClusterAttributes } from '@backstage/plugin-kubernetes-common';\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles';\nimport { useRef, useEffect, useMemo, useState } from 'react';\nimport { Terminal } from '@xterm/xterm';\nimport { FitAddon } from '@xterm/addon-fit';\n\nimport { PodExecTerminalAttachAddon } from './PodExecTerminalAttachAddon';\n\n/**\n * Props drilled down to the PodExecTerminal component\n *\n * @public\n */\nexport interface PodExecTerminalProps {\n  cluster: ClusterAttributes;\n  containerName: string;\n  podName: string;\n  podNamespace: string;\n}\n\nconst hasSocketProtocol = (url: string | URL) =>\n  /wss?:\\/\\//.test(url.toString());\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    podExecTerminal: {\n      width: '100%',\n      height: '100%',\n      '& .xterm-screen': { padding: theme.spacing(1) },\n    },\n  }),\n);\n\n/**\n * Executes a `/bin/sh` process in the given pod's container and opens a terminal connected to it\n *\n * @public\n */\nexport const PodExecTerminal = (props: PodExecTerminalProps) => {\n  const classes = useStyles();\n  const { containerName, podNamespace, podName } = props;\n\n  const [baseUrl, setBaseUrl] = useState(window.location.host);\n\n  const terminalRef = useRef(null);\n  const discoveryApi = useApi(discoveryApiRef);\n  const namespace = podNamespace ?? 'default';\n\n  useEffect(() => {\n    discoveryApi\n      .getBaseUrl('kubernetes')\n      .then(url => url ?? window.location.host)\n      .then(url => url.replace(/^http(s?):\\/\\//, 'ws$1://'))\n      .then(url => setBaseUrl(url));\n  }, [discoveryApi]);\n\n  const urlParams = useMemo(() => {\n    const params = new URLSearchParams({\n      container: containerName,\n      stdin: 'true',\n      stdout: 'true',\n      stderr: 'true',\n      tty: 'true',\n      command: '/bin/sh',\n    });\n    return params;\n  }, [containerName]);\n\n  const socketUrl = useMemo(() => {\n    if (!hasSocketProtocol(baseUrl)) {\n      return '';\n    }\n\n    return new URL(\n      `${baseUrl}/proxy/api/v1/namespaces/${namespace}/pods/${podName}/exec?${urlParams}`,\n    );\n  }, [baseUrl, namespace, podName, urlParams]);\n\n  useEffect(() => {\n    if (!hasSocketProtocol(socketUrl)) {\n      return () => {};\n    }\n\n    const terminal = new Terminal();\n    const fitAddon = new FitAddon();\n    terminal.loadAddon(fitAddon);\n\n    if (terminalRef.current) {\n      terminal.open(terminalRef.current);\n      fitAddon.fit();\n    }\n\n    terminal.writeln('Starting terminal, please wait...');\n\n    const socket = new WebSocket(socketUrl, ['channel.k8s.io']);\n\n    socket.onopen = () => {\n      terminal.clear();\n      const attachAddon = new PodExecTerminalAttachAddon(socket, {\n        bidirectional: true,\n      });\n\n      terminal.loadAddon(attachAddon);\n    };\n\n    socket.onclose = () => {\n      terminal.writeln('Socket connection closed');\n    };\n\n    return () => {\n      terminal?.clear();\n      socket?.close();\n    };\n  }, [baseUrl, socketUrl]);\n\n  return (\n    <div\n      data-testid=\"terminal\"\n      ref={terminalRef}\n      className={classes.podExecTerminal}\n    />\n  );\n};\n"],"names":[],"mappings":"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"}