{"version":3,"file":"jwks.cjs.js","sources":["../../../../src/entrypoints/auth/external/jwks.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { jwtVerify, createRemoteJWKSet, JWTVerifyGetKey } from 'jose';\nimport {\n  createExternalTokenHandler,\n  readAccessRestrictionsFromConfig,\n  readStringOrStringArrayFromConfig,\n} from './helpers';\nimport { AccessRestrictionsMap } from './types';\n\ntype JWKSTokenContext = {\n  algorithms?: string[];\n  audiences?: string[];\n  issuers?: string[];\n  subjectPrefix?: string;\n  url: URL;\n  jwks: JWTVerifyGetKey;\n  allAccessRestrictions?: AccessRestrictionsMap;\n};\n\nexport const jwksTokenHandler = createExternalTokenHandler<JWKSTokenContext>({\n  type: 'jwks',\n  initialize({ options }): JWKSTokenContext {\n    if (!options.getString('url').match(/^\\S+$/)) {\n      throw new Error(\n        'Illegal JWKS URL, must be a set of non-space characters',\n      );\n    }\n\n    const algorithms = readStringOrStringArrayFromConfig(options, 'algorithm');\n    const issuers = readStringOrStringArrayFromConfig(options, 'issuer');\n    const audiences = readStringOrStringArrayFromConfig(options, 'audience');\n    const subjectPrefix = options.getOptionalString('subjectPrefix');\n    const url = new URL(options.getString('url'));\n    const jwks = createRemoteJWKSet(url);\n    const allAccessRestrictions = readAccessRestrictionsFromConfig(options);\n    return {\n      algorithms,\n      audiences,\n      issuers,\n      jwks,\n      subjectPrefix,\n      url,\n      allAccessRestrictions,\n    };\n  },\n\n  async verifyToken(token: string, context: JWKSTokenContext) {\n    try {\n      const {\n        payload: { sub },\n      } = await jwtVerify(token, context.jwks, {\n        algorithms: context.algorithms,\n        issuer: context.issuers,\n        audience: context.audiences,\n      });\n\n      if (sub) {\n        const prefix = context.subjectPrefix\n          ? `external:${context.subjectPrefix}:`\n          : 'external:';\n        return {\n          subject: `${prefix}${sub}`,\n        };\n      }\n    } catch {\n      return undefined;\n    }\n    return undefined;\n  },\n});\n"],"names":["createExternalTokenHandler","readStringOrStringArrayFromConfig","createRemoteJWKSet","readAccessRestrictionsFromConfig","jwtVerify"],"mappings":";;;;;AAkCO,MAAM,mBAAmBA,kCAAA,CAA6C;AAAA,EAC3E,IAAA,EAAM,MAAA;AAAA,EACN,UAAA,CAAW,EAAE,OAAA,EAAQ,EAAqB;AACxC,IAAA,IAAI,CAAC,OAAA,CAAQ,SAAA,CAAU,KAAK,CAAA,CAAE,KAAA,CAAM,OAAO,CAAA,EAAG;AAC5C,MAAA,MAAM,IAAI,KAAA;AAAA,QACR;AAAA,OACF;AAAA,IACF;AAEA,IAAA,MAAM,UAAA,GAAaC,yCAAA,CAAkC,OAAA,EAAS,WAAW,CAAA;AACzE,IAAA,MAAM,OAAA,GAAUA,yCAAA,CAAkC,OAAA,EAAS,QAAQ,CAAA;AACnE,IAAA,MAAM,SAAA,GAAYA,yCAAA,CAAkC,OAAA,EAAS,UAAU,CAAA;AACvE,IAAA,MAAM,aAAA,GAAgB,OAAA,CAAQ,iBAAA,CAAkB,eAAe,CAAA;AAC/D,IAAA,MAAM,MAAM,IAAI,GAAA,CAAI,OAAA,CAAQ,SAAA,CAAU,KAAK,CAAC,CAAA;AAC5C,IAAA,MAAM,IAAA,GAAOC,wBAAmB,GAAG,CAAA;AACnC,IAAA,MAAM,qBAAA,GAAwBC,yCAAiC,OAAO,CAAA;AACtE,IAAA,OAAO;AAAA,MACL,UAAA;AAAA,MACA,SAAA;AAAA,MACA,OAAA;AAAA,MACA,IAAA;AAAA,MACA,aAAA;AAAA,MACA,GAAA;AAAA,MACA;AAAA,KACF;AAAA,EACF,CAAA;AAAA,EAEA,MAAM,WAAA,CAAY,KAAA,EAAe,OAAA,EAA2B;AAC1D,IAAA,IAAI;AACF,MAAA,MAAM;AAAA,QACJ,OAAA,EAAS,EAAE,GAAA;AAAI,OACjB,GAAI,MAAMC,cAAA,CAAU,KAAA,EAAO,QAAQ,IAAA,EAAM;AAAA,QACvC,YAAY,OAAA,CAAQ,UAAA;AAAA,QACpB,QAAQ,OAAA,CAAQ,OAAA;AAAA,QAChB,UAAU,OAAA,CAAQ;AAAA,OACnB,CAAA;AAED,MAAA,IAAI,GAAA,EAAK;AACP,QAAA,MAAM,SAAS,OAAA,CAAQ,aAAA,GACnB,CAAA,SAAA,EAAY,OAAA,CAAQ,aAAa,CAAA,CAAA,CAAA,GACjC,WAAA;AACJ,QAAA,OAAO;AAAA,UACL,OAAA,EAAS,CAAA,EAAG,MAAM,CAAA,EAAG,GAAG,CAAA;AAAA,SAC1B;AAAA,MACF;AAAA,IACF,CAAA,CAAA,MAAQ;AACN,MAAA,OAAO,MAAA;AAAA,IACT;AACA,IAAA,OAAO,MAAA;AAAA,EACT;AACF,CAAC;;;;"}