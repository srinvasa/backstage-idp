{"version":3,"file":"legacy.cjs.js","sources":["../../../../src/entrypoints/auth/external/legacy.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { base64url, decodeJwt, decodeProtectedHeader, jwtVerify } from 'jose';\n\nimport { ExternalTokenHandler } from './types';\n\nexport type LegacyConfigWrapper = {\n  legacy: boolean;\n  config: Config;\n};\n\ntype LegacyTokenHandlerContext = {\n  key: Uint8Array;\n\n  subject: string;\n};\n\ntype LegacyTokenHandlerOverloaded =\n  ExternalTokenHandler<LegacyTokenHandlerContext> & {\n    initialize(ctx: {\n      options: Config;\n      legacy: true;\n    }): LegacyTokenHandlerContext;\n  };\n\nexport const legacyTokenHandler: LegacyTokenHandlerOverloaded = {\n  type: 'legacy',\n  initialize(ctx: {\n    options: Config;\n    legacy?: true;\n  }): LegacyTokenHandlerContext {\n    const secret = ctx.options.getString('secret');\n    const subject = ctx.legacy\n      ? 'external:backstage-plugin'\n      : ctx.options.getString('subject');\n\n    if (!secret.match(/^\\S+$/)) {\n      throw new Error('Illegal secret, must be a valid base64 string');\n    } else if (!subject.match(/^\\S+$/)) {\n      throw new Error('Illegal subject, must be a set of non-space characters');\n    }\n\n    try {\n      return {\n        key: base64url.decode(secret),\n        subject,\n      };\n    } catch {\n      throw new Error('Illegal secret, must be a valid base64 string');\n    }\n  },\n\n  async verifyToken(token: string, context: LegacyTokenHandlerContext) {\n    // First do a duck typing check to see if it remotely looks like a legacy token\n    try {\n      // We do a fair amount of checking upfront here. Since we aren't certain\n      // that it's even the right type of key that we're looking at, we can't\n      // defer eg the alg check to jwtVerify, because it won't be possible to\n      // discern different reasons for key verification failures from each other\n      // easily\n      const { alg } = decodeProtectedHeader(token);\n      if (alg !== 'HS256') {\n        return undefined;\n      }\n      const { sub, aud } = decodeJwt(token);\n      if (sub !== 'backstage-server' || aud) {\n        return undefined;\n      }\n    } catch (e) {\n      // Doesn't look like a jwt at all\n      return undefined;\n    }\n\n    try {\n      await jwtVerify(token, context.key);\n      return {\n        subject: context.subject,\n      };\n    } catch (error) {\n      if (error.code !== 'ERR_JWS_SIGNATURE_VERIFICATION_FAILED') {\n        throw error;\n      }\n    }\n\n    // None of the signing keys matched\n    return undefined;\n  },\n};\n"],"names":["base64url","decodeProtectedHeader","decodeJwt","jwtVerify"],"mappings":";;;;AAwCO,MAAM,kBAAA,GAAmD;AAAA,EAC9D,IAAA,EAAM,QAAA;AAAA,EACN,WAAW,GAAA,EAGmB;AAC5B,IAAA,MAAM,MAAA,GAAS,GAAA,CAAI,OAAA,CAAQ,SAAA,CAAU,QAAQ,CAAA;AAC7C,IAAA,MAAM,UAAU,GAAA,CAAI,MAAA,GAChB,8BACA,GAAA,CAAI,OAAA,CAAQ,UAAU,SAAS,CAAA;AAEnC,IAAA,IAAI,CAAC,MAAA,CAAO,KAAA,CAAM,OAAO,CAAA,EAAG;AAC1B,MAAA,MAAM,IAAI,MAAM,+CAA+C,CAAA;AAAA,IACjE,CAAA,MAAA,IAAW,CAAC,OAAA,CAAQ,KAAA,CAAM,OAAO,CAAA,EAAG;AAClC,MAAA,MAAM,IAAI,MAAM,wDAAwD,CAAA;AAAA,IAC1E;AAEA,IAAA,IAAI;AACF,MAAA,OAAO;AAAA,QACL,GAAA,EAAKA,cAAA,CAAU,MAAA,CAAO,MAAM,CAAA;AAAA,QAC5B;AAAA,OACF;AAAA,IACF,CAAA,CAAA,MAAQ;AACN,MAAA,MAAM,IAAI,MAAM,+CAA+C,CAAA;AAAA,IACjE;AAAA,EACF,CAAA;AAAA,EAEA,MAAM,WAAA,CAAY,KAAA,EAAe,OAAA,EAAoC;AAEnE,IAAA,IAAI;AAMF,MAAA,MAAM,EAAE,GAAA,EAAI,GAAIC,0BAAA,CAAsB,KAAK,CAAA;AAC3C,MAAA,IAAI,QAAQ,OAAA,EAAS;AACnB,QAAA,OAAO,KAAA,CAAA;AAAA,MACT;AACA,MAAA,MAAM,EAAE,GAAA,EAAK,GAAA,EAAI,GAAIC,eAAU,KAAK,CAAA;AACpC,MAAA,IAAI,GAAA,KAAQ,sBAAsB,GAAA,EAAK;AACrC,QAAA,OAAO,KAAA,CAAA;AAAA,MACT;AAAA,IACF,SAAS,CAAA,EAAG;AAEV,MAAA,OAAO,MAAA;AAAA,IACT;AAEA,IAAA,IAAI;AACF,MAAA,MAAMC,cAAA,CAAU,KAAA,EAAO,OAAA,CAAQ,GAAG,CAAA;AAClC,MAAA,OAAO;AAAA,QACL,SAAS,OAAA,CAAQ;AAAA,OACnB;AAAA,IACF,SAAS,KAAA,EAAO;AACd,MAAA,IAAI,KAAA,CAAM,SAAS,uCAAA,EAAyC;AAC1D,QAAA,MAAM,KAAA;AAAA,MACR;AAAA,IACF;AAGA,IAAA,OAAO,MAAA;AAAA,EACT;AACF;;;;"}