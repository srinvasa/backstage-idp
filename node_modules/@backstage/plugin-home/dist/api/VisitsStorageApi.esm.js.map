{"version":3,"file":"VisitsStorageApi.esm.js","sources":["../../src/api/VisitsStorageApi.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { IdentityApi, StorageApi } from '@backstage/core-plugin-api';\nimport {\n  Visit,\n  VisitsApi,\n  VisitsApiQueryParams,\n  VisitsApiSaveParams,\n} from './VisitsApi';\n\n/**\n * @public\n * Type definition for visit data before it's saved (without auto-generated fields)\n */\nexport type VisitInput = {\n  name: string;\n  pathname: string;\n  entityRef?: string;\n};\n\n/** @public */\nexport type VisitsStorageApiOptions = {\n  limit?: number;\n  storageApi: StorageApi;\n  identityApi: IdentityApi;\n  transformPathname?: (pathname: string) => string;\n  canSave?: (visit: VisitInput) => boolean | Promise<boolean>;\n  enrichVisit?: (\n    visit: VisitInput,\n  ) => Promise<Record<string, any>> | Record<string, any>;\n};\n\ntype ArrayElement<A> = A extends readonly (infer T)[] ? T : never;\n\nconst DEFAULT_LIST_LIMIT = 8;\n\n/**\n * @public\n * This is an implementation of VisitsApi that relies on a StorageApi.\n * Beware that filtering and ordering are done in memory therefore it is\n * prudent to keep limit to a reasonable size.\n */\nexport class VisitsStorageApi implements VisitsApi {\n  private readonly limit: number;\n  private readonly storageApi: StorageApi;\n  private readonly storageKeyPrefix = '@backstage/plugin-home:visits';\n  private readonly identityApi: IdentityApi;\n  private readonly transformPathnameImpl?: (pathname: string) => string;\n  private readonly canSaveImpl?: (\n    visit: VisitInput,\n  ) => boolean | Promise<boolean>;\n  private readonly enrichVisitImpl?: (\n    visit: VisitInput,\n  ) => Promise<Record<string, any>> | Record<string, any>;\n\n  static create(options: VisitsStorageApiOptions) {\n    return new VisitsStorageApi(options);\n  }\n\n  private constructor(options: VisitsStorageApiOptions) {\n    this.limit = Math.abs(options.limit ?? 100);\n    this.storageApi = options.storageApi;\n    this.identityApi = options.identityApi;\n    this.transformPathnameImpl = options.transformPathname;\n    this.canSaveImpl = options.canSave;\n    this.enrichVisitImpl = options.enrichVisit;\n  }\n\n  /**\n   * Returns a list of visits through the visitsApi\n   */\n  async list(queryParams?: VisitsApiQueryParams): Promise<Visit[]> {\n    let visits = [...(await this.retrieveAll())];\n\n    // reversing order to guarantee orderBy priority\n    (queryParams?.orderBy ?? []).reverse().forEach(order => {\n      if (order.direction === 'asc') {\n        visits.sort((a, b) => this.compare(order, a, b));\n      } else {\n        visits.sort((a, b) => this.compare(order, b, a));\n      }\n    });\n\n    // reversing order to guarantee filterBy priority\n    (queryParams?.filterBy ?? []).reverse().forEach(filter => {\n      visits = visits.filter(visit => {\n        const field = visit[filter.field] as number | string;\n        if (filter.operator === '>') return field > filter.value;\n        if (filter.operator === '>=') return field >= filter.value;\n        if (filter.operator === '<') return field < filter.value;\n        if (filter.operator === '<=') return field <= filter.value;\n        if (filter.operator === '==') return field === filter.value;\n        if (filter.operator === '!=') return field !== filter.value;\n        if (filter.operator === 'contains')\n          return `${field}`.includes(`${filter.value}`);\n        return false;\n      });\n    });\n\n    return visits.slice(0, queryParams?.limit ?? DEFAULT_LIST_LIMIT);\n  }\n\n  /**\n   * Transform the pathname before it is considered for any other processing.\n   * @param pathname - the original pathname\n   * @returns the transformed pathname\n   */\n  transformPathname(pathname: string): string {\n    return this.transformPathnameImpl?.(pathname) ?? pathname;\n  }\n\n  /**\n   * Determine whether a visit should be saved.\n   * @param visit - page visit data\n   */\n  async canSave(visit: VisitInput): Promise<boolean> {\n    if (!this.canSaveImpl) {\n      return true;\n    }\n    return Promise.resolve(this.canSaveImpl(visit));\n  }\n\n  /**\n   * Add additional data to the visit before saving.\n   * @param visit - page visit data\n   */\n  async enrichVisit(visit: VisitInput): Promise<Record<string, any>> {\n    if (!this.enrichVisitImpl) {\n      return {};\n    }\n    return Promise.resolve(this.enrichVisitImpl(visit));\n  }\n\n  /**\n   * Saves a visit through the visitsApi\n   */\n  async save(saveParams: VisitsApiSaveParams): Promise<Visit> {\n    let visit = saveParams.visit;\n\n    // Transform pathname if needed\n    visit = {\n      ...visit,\n      pathname: this.transformPathname(visit.pathname),\n    };\n\n    // Check if visit should be saved\n    if (!(await this.canSave(visit))) {\n      // Return a minimal visit object without saving\n      return {\n        ...visit,\n        id: '',\n        hits: 0,\n        timestamp: Date.now(),\n      };\n    }\n\n    // Enrich the visit\n    const enrichedData = await this.enrichVisit(visit);\n    const enrichedVisit = { ...visit, ...enrichedData };\n\n    const visits: Visit[] = [...(await this.retrieveAll())];\n\n    const visitToSave: Visit = {\n      ...enrichedVisit,\n      id: window.crypto.randomUUID(),\n      hits: 1,\n      timestamp: Date.now(),\n    };\n\n    // Updates entry if pathname is already registered\n    const visitIndex = visits.findIndex(\n      e => e.pathname === visitToSave.pathname,\n    );\n    if (visitIndex >= 0) {\n      visitToSave.id = visits[visitIndex].id;\n      visitToSave.hits = visits[visitIndex].hits + 1;\n      visits[visitIndex] = visitToSave;\n    } else {\n      visits.push(visitToSave);\n    }\n\n    // Sort by time, most recent first\n    visits.sort((a, b) => b.timestamp - a.timestamp);\n    // Keep the most recent items up to limit\n    await this.persistAll(visits.splice(0, this.limit));\n    return visitToSave;\n  }\n\n  private async persistAll(visits: Array<Visit>) {\n    const storageKey = await this.getStorageKey();\n    return this.storageApi.set<Array<Visit>>(storageKey, visits);\n  }\n\n  private async retrieveAll(): Promise<Array<Visit>> {\n    const storageKey = await this.getStorageKey();\n    // Handles for case when snapshot is and is not referenced per storage type used\n    const snapshot = this.storageApi.snapshot<Array<Visit>>(storageKey);\n    if (snapshot?.presence !== 'unknown') {\n      return snapshot?.value ?? [];\n    }\n\n    return new Promise((resolve, reject) => {\n      const subscription = this.storageApi\n        .observe$<Visit[]>(storageKey)\n        .subscribe({\n          next: next => {\n            const visits = next.value ?? [];\n            subscription.unsubscribe();\n            resolve(visits);\n          },\n          error: err => {\n            subscription.unsubscribe();\n            reject(err);\n          },\n        });\n    });\n  }\n\n  private async getStorageKey(): Promise<string> {\n    const { userEntityRef } = await this.identityApi.getBackstageIdentity();\n    const storageKey = `${this.storageKeyPrefix}:${userEntityRef}`;\n    return storageKey;\n  }\n\n  // This assumes Visit fields are either numbers or strings\n  private compare(\n    order: ArrayElement<VisitsApiQueryParams['orderBy']>,\n    a: Visit,\n    b: Visit,\n  ): number {\n    const isNumber = typeof a[order.field] === 'number';\n    return isNumber\n      ? (a[order.field] as number) - (b[order.field] as number)\n      : `${a[order.field]}`.localeCompare(`${b[order.field]}`);\n  }\n}\n"],"names":[],"mappings":"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"}