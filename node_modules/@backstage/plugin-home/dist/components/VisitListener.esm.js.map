{"version":3,"file":"VisitListener.esm.js","sources":["../../src/components/VisitListener.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ReactNode, useEffect } from 'react';\n\nimport { useLocation } from 'react-router-dom';\n\nimport { visitsApiRef } from '../api';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { stringifyEntityRef } from '@backstage/catalog-model';\n\n/**\n * This function returns an implementation of toEntityRef which is responsible\n * for receiving a pathname and maybe returning an entityRef compatible with the\n * catalog-model.\n * By default this function uses the url root \"/catalog\" and the\n * stringifyEntityRef implementation from catalog-model.\n * Example:\n *   const toEntityRef = getToEntityRef();\n *   toEntityRef(\\{ pathname: \"/catalog/default/component/playback-order\" \\})\n *   // returns \"component:default/playback-order\"\n */\nconst getToEntityRef =\n  ({\n    rootPath = 'catalog',\n    stringifyEntityRefImpl = stringifyEntityRef,\n  } = {}) =>\n  ({ pathname }: { pathname: string }): string | undefined => {\n    const regex = new RegExp(\n      `^\\/${rootPath}\\/(?<namespace>[^\\/]+)\\/(?<kind>[^\\/]+)\\/(?<name>[^\\/]+)`,\n    );\n    const result = regex.exec(pathname);\n    if (!result || !result?.groups) return undefined;\n    const entity = {\n      namespace: result.groups.namespace,\n      kind: result.groups.kind,\n      name: result.groups.name,\n    };\n    return stringifyEntityRefImpl(entity);\n  };\n\n/**\n * @internal\n * This function returns an implementation of visitName which is responsible\n * for receiving a pathname and returning a string (name).\n */\nconst getVisitName =\n  ({ rootPath = 'catalog', document = global.document } = {}) =>\n  ({ pathname }: { pathname: string }) => {\n    // If it is a catalog entity, get the name from the path\n    const regex = new RegExp(\n      `^\\/${rootPath}\\/(?<namespace>[^\\/]+)\\/(?<kind>[^\\/]+)\\/(?<name>[^\\/]+)`,\n    );\n    let result = regex.exec(pathname);\n    if (result && result?.groups) return result.groups.name;\n\n    // If it is a root pathname, get the name from there\n    result = /^\\/(?<name>[^\\/]+)$/.exec(pathname);\n    if (result && result?.groups) return result.groups.name;\n\n    // Fallback to document title\n    return document.title;\n  };\n\n/**\n * @public\n * Component responsible for listening to location changes and calling\n * the visitsApi to save visits.\n */\nexport const VisitListener = ({\n  children,\n  toEntityRef,\n  visitName,\n}: {\n  children?: ReactNode;\n  toEntityRef?: ({ pathname }: { pathname: string }) => string | undefined;\n  visitName?: ({ pathname }: { pathname: string }) => string;\n}): JSX.Element => {\n  const visitsApi = useApi(visitsApiRef);\n  const { pathname } = useLocation();\n  const toEntityRefImpl = toEntityRef ?? getToEntityRef();\n  const visitNameImpl = visitName ?? getVisitName();\n  useEffect(() => {\n    // Wait for the browser to finish with paint with the assumption react\n    // has finished with dom reconciliation.\n    const requestId = requestAnimationFrame(() => {\n      visitsApi.save({\n        visit: {\n          name: visitNameImpl({ pathname }),\n          pathname,\n          entityRef: toEntityRefImpl({ pathname }),\n        },\n      });\n    });\n    return () => cancelAnimationFrame(requestId);\n  }, [visitsApi, pathname, toEntityRefImpl, visitNameImpl]);\n\n  return <>{children}</>;\n};\n"],"names":[],"mappings":";;;;;;;;AAkCA,MAAM,iBACJ,CAAC;AAAA,EACC,QAAA,GAAW,SAAA;AAAA,EACX,sBAAA,GAAyB;AAC3B,CAAA,GAAI,EAAC,KACL,CAAC,EAAE,UAAS,KAAgD;AAC1D,EAAA,MAAM,QAAQ,IAAI,MAAA;AAAA,IAChB,KAAM,QAAQ,CAAA,kDAAA;AAAA,GAChB;AACA,EAAA,MAAM,MAAA,GAAS,KAAA,CAAM,IAAA,CAAK,QAAQ,CAAA;AAClC,EAAA,IAAI,CAAC,MAAA,IAAU,CAAC,MAAA,EAAQ,QAAQ,OAAO,MAAA;AACvC,EAAA,MAAM,MAAA,GAAS;AAAA,IACb,SAAA,EAAW,OAAO,MAAA,CAAO,SAAA;AAAA,IACzB,IAAA,EAAM,OAAO,MAAA,CAAO,IAAA;AAAA,IACpB,IAAA,EAAM,OAAO,MAAA,CAAO;AAAA,GACtB;AACA,EAAA,OAAO,uBAAuB,MAAM,CAAA;AACtC,CAAA;AAOF,MAAM,YAAA,GACJ,CAAC,EAAE,QAAA,GAAW,WAAW,QAAA,GAAW,MAAA,CAAO,QAAA,EAAS,GAAI,EAAC,KACzD,CAAC,EAAE,UAAS,KAA4B;AAEtC,EAAA,MAAM,QAAQ,IAAI,MAAA;AAAA,IAChB,KAAM,QAAQ,CAAA,kDAAA;AAAA,GAChB;AACA,EAAA,IAAI,MAAA,GAAS,KAAA,CAAM,IAAA,CAAK,QAAQ,CAAA;AAChC,EAAA,IAAI,MAAA,IAAU,MAAA,EAAQ,MAAA,EAAQ,OAAO,OAAO,MAAA,CAAO,IAAA;AAGnD,EAAA,MAAA,GAAS,qBAAA,CAAsB,KAAK,QAAQ,CAAA;AAC5C,EAAA,IAAI,MAAA,IAAU,MAAA,EAAQ,MAAA,EAAQ,OAAO,OAAO,MAAA,CAAO,IAAA;AAGnD,EAAA,OAAO,QAAA,CAAS,KAAA;AAClB,CAAA;AAOK,MAAM,gBAAgB,CAAC;AAAA,EAC5B,QAAA;AAAA,EACA,WAAA;AAAA,EACA;AACF,CAAA,KAImB;AACjB,EAAA,MAAM,SAAA,GAAY,OAAO,YAAY,CAAA;AACrC,EAAA,MAAM,EAAE,QAAA,EAAS,GAAI,WAAA,EAAY;AACjC,EAAA,MAAM,eAAA,GAAkB,eAAe,cAAA,EAAe;AACtD,EAAA,MAAM,aAAA,GAAgB,aAAa,YAAA,EAAa;AAChD,EAAA,SAAA,CAAU,MAAM;AAGd,IAAA,MAAM,SAAA,GAAY,sBAAsB,MAAM;AAC5C,MAAA,SAAA,CAAU,IAAA,CAAK;AAAA,QACb,KAAA,EAAO;AAAA,UACL,IAAA,EAAM,aAAA,CAAc,EAAE,QAAA,EAAU,CAAA;AAAA,UAChC,QAAA;AAAA,UACA,SAAA,EAAW,eAAA,CAAgB,EAAE,QAAA,EAAU;AAAA;AACzC,OACD,CAAA;AAAA,IACH,CAAC,CAAA;AACD,IAAA,OAAO,MAAM,qBAAqB,SAAS,CAAA;AAAA,EAC7C,GAAG,CAAC,SAAA,EAAW,QAAA,EAAU,eAAA,EAAiB,aAAa,CAAC,CAAA;AAExD,EAAA,uCAAU,QAAA,EAAS,CAAA;AACrB;;;;"}